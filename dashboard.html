<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’å„€è¡¨æ¿ - é›²ç«¯å­¸é™¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .course-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e2e8f0; }
        .course-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="mockdata/curriculum_integrated.js"></script>
</head>
<body class="h-screen flex overflow-hidden">
    <aside class="w-64 bg-white border-r border-slate-100 hidden lg:flex flex-col z-20 shrink-0 h-screen sticky top-0">
        <div class="h-16 flex items-center px-6 border-b border-slate-50">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-sm mr-2 shadow-sm">å­¸</div>
            <span class="text-lg font-bold text-slate-800">é›²ç«¯å­¸é™¢</span>
        </div>
         <div class="bg-white border border-slate-100 rounded-3xl p-5 text-center shadow-[0_4px_20px_-10px_rgba(0,0,0,0.1)] relative overflow-hidden group">
        
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-purple-500"></div>

        <div class="mb-4 relative inline-block">
            <div class="w-16 h-16 bg-slate-100 rounded-full mx-auto flex items-center justify-center text-3xl shadow-inner mb-2">
                ğŸ˜€ </div>
            <h3 class="font-bold text-slate-800 text-lg" id="sideUserName">è®€å–ä¸­...</h3>
            <div class="text-xs text-slate-400 font-medium bg-slate-50 inline-block px-2 py-0.5 rounded-full border border-slate-100 mt-1" id="sideUserRole">å­¸ç”Ÿ</div>
        </div>

        <div class="mt-2 bg-slate-50 rounded-xl p-3 border border-slate-100">
            <div class="flex justify-between items-end mb-2">
                <div class="flex items-baseline gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Lv.</span>
                    <span id="displayLevel" class="text-2xl font-black text-blue-600 leading-none">1</span>
                </div>
                <span class="text-[10px] font-bold text-slate-400"><span id="displayXP">0</span>/100 XP</span>
            </div>
            
            <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden shadow-inner">
                <div id="xpBar" class="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 h-full rounded-full transition-all duration-700 ease-out shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: 0%"></div>
            </div>
            <p class="text-[10px] text-slate-400 mt-2 text-center">å† <span id="xpToNext" class="text-blue-500 font-bold">100</span> XP å‡ç´š</p>
        </div>

    </div>
        <nav class="flex-grow px-3 space-y-1">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> èª²ç¨‹ç¸½è¦½</a>
            <a href="remedial.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> éŒ¯é¡Œè£œæ•‘</a>
            <a href="study.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> é‡é»è¤‡ç¿’</a>
            <a href="arcade.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> éŠæˆ²å ´</a>
            <a href="forum.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> è§£é¡Œè«–å£‡</a>
        </nav>
        <div class="p-4 border-t border-slate-50">
            <button onclick="Auth.logout()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-red-500 py-3 transition-colors font-bold text-xs"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºç³»çµ±</button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col h-full relative">
        <div class="bg-white border-b border-gray-200 p-6 z-10 shadow-sm sticky top-0">
            <div class="max-w-7xl mx-auto flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">èª²ç¨‹ç¸½è¦½</h1>
                    <p class="text-sm text-gray-500 mt-1">é¸æ“‡ç§‘ç›®ï¼Œé€²å…¥å–®å…ƒå¼å­¸ç¿’</p>
                </div>
                <div class="bg-gray-100 p-1 rounded-lg flex text-sm font-bold">
                    <button onclick="setStage('high_school')" id="btnHigh" class="px-4 py-1.5 rounded-md transition bg-white text-gray-800 shadow-sm">é«˜ä¸­</button>
                    <button onclick="setStage('junior_high')" id="btnJunior" class="px-4 py-1.5 rounded-md transition text-gray-500 hover:text-gray-700">åœ‹ä¸­</button>
                </div>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto p-6 md:p-8" id="mainScroll">
            <div class="max-w-7xl mx-auto pb-20">
                <div id="courseContainer" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>
        <div id="profileModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm fade-in">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
        <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
            <h3 class="text-white font-bold text-lg"><i class="fas fa-user-edit mr-2"></i> ä¿®æ”¹å¹´ç´š</h3>
            <button onclick="closeProfileModal()" class="text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">è«‹é¸æ“‡ç›®å‰çš„å¹´ç´šï¼š</label>
            <div class="relative">
                <select id="editGradeSelect" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white appearance-none transition text-gray-700 font-bold">
                    <option value="åœ‹ä¸€">åœ‹ä¸€</option>
                    <option value="åœ‹äºŒ">åœ‹äºŒ</option>
                    <option value="åœ‹ä¸‰">åœ‹ä¸‰</option>
                    <hr>
                    <option value="é«˜ä¸€">é«˜ä¸€</option>
                    <option value="é«˜äºŒ">é«˜äºŒ</option>
                    <option value="é«˜ä¸‰">é«˜ä¸‰</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-3">â€» ä¿®æ”¹å¾Œï¼Œç³»çµ±å°‡æœƒå„ªå…ˆæ¨è–¦è©²å¹´ç´šçš„é¡Œç›®ã€‚</p>
        </div>

        <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-100">
            <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold text-sm">å–æ¶ˆ</button>
            <button onclick="saveProfile()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md hover:shadow-lg transition">
                ç¢ºèªä¿®æ”¹
            </button>
        </div>
    </div>
             <div id="levelUpModal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 text-center max-w-sm mx-4 shadow-2xl relative overflow-hidden animate-[bounce_1s_infinite]">
                <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-yellow-100/50 to-transparent pointer-events-none"></div>
                <div class="text-6xl mb-4">ğŸ†™</div>
                <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 to-orange-600 mb-2">LEVEL UP!</h2>
                <p class="text-gray-500 font-bold mb-6">æ­å–œå‡ä¸Š <span id="newLevelNum" class="text-2xl text-blue-600">2</span> ç­‰ï¼</p>
                <button onclick="document.getElementById('levelUpModal').classList.add('hidden')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg transition">
                    å¤ªæ£’äº†ï¼
                </button>
            </div>
        </div>
</div>
    </main>

    <input type="hidden" id="currentStage" value="high_school">

   <script>
    // ==========================================
    // ğŸŒ å…¨åŸŸè®Šæ•¸
    // ==========================================
    const XP_PER_LEVEL = 100;

    // ==========================================
    // ğŸš€ ç³»çµ±åˆå§‹åŒ– (window.onload)
    // ==========================================
    window.onload = function() {
        if (typeof Auth === 'undefined') {
            console.error("Auth module missing");
            setStage('high_school');
            return;
        }

        const user = Auth.getCurrentUser();
        if (user) {
            // 1. æ›´æ–°å€‹äººè³‡æ–™
            document.getElementById('sideUserName').textContent = user.name || user.username;
            document.getElementById('sideUserRole').textContent = user.grade || "å­¸ç”Ÿ";
            
            // 2. è‡ªå‹•åˆ¤æ–·å¹´ç´šä¸¦è¨­å®šèª²ç¨‹
            if (user.grade && user.grade.includes('åœ‹')) {
                setStage('junior_high');
            } else {
                setStage('high_school');
            }
        } else {
            // æœªç™»å…¥é è¨­
            if(document.getElementById('sideUserName')) document.getElementById('sideUserName').textContent = "è¨ªå®¢";
            setStage('high_school');
        }

        // 3. æ›´æ–°ç­‰ç´šé¡¯ç¤º
        updateLevelUI();
    };

    // ==========================================
    // ğŸ†™ ç­‰ç´šç³»çµ± (XP)
    // ==========================================
    function loadXP() {
        const user = Auth.getCurrentUser();
        if (!user) return 0;
        const key = `xp_${user.username}`;
        return parseInt(localStorage.getItem(key) || 0);
    }

    function updateLevelUI() {
        const totalXP = loadXP();
        const currentLevel = Math.floor(totalXP / XP_PER_LEVEL) + 1;
        const currentLevelXP = totalXP % XP_PER_LEVEL;
        const percentage = (currentLevelXP / XP_PER_LEVEL) * 100;

        const elLevel = document.getElementById('displayLevel');
        const elXP = document.getElementById('displayXP');
        const elBar = document.getElementById('xpBar');
        const elNext = document.getElementById('xpToNext');

        if (elLevel) elLevel.innerText = currentLevel;
        if (elXP) elXP.innerText = currentLevelXP;
        if (elBar) elBar.style.width = `${percentage}%`;
        if (elNext) elNext.innerText = XP_PER_LEVEL - currentLevelXP;
    }

    // ==========================================
    // âœï¸ å€‹äººè³‡æ–™ç·¨è¼¯åŠŸèƒ½
    // ==========================================
    function openProfileModal() {
        const user = Auth.getCurrentUser();
        if (!user) { alert("è«‹å…ˆç™»å…¥ï¼"); return; }
        
        const select = document.getElementById('editGradeSelect');
        if (user.grade) select.value = user.grade;
        
        document.getElementById('profileModal').classList.remove('hidden');
    }

    function closeProfileModal() {
        document.getElementById('profileModal').classList.add('hidden');
    }

    function saveProfile() {
        const newGrade = document.getElementById('editGradeSelect').value;
        
        if (Auth.updateUser) {
            Auth.updateUser('grade', newGrade);
            
            // æ›´æ–°ç•«é¢æ–‡å­—
            const roleEl = document.getElementById('sideUserRole');
            if (roleEl) roleEl.innerText = newGrade;
            
            // æ ¹æ“šæ–°å¹´ç´šé‡æ–°æ•´ç†èª²ç¨‹åˆ—è¡¨
            if (newGrade.includes('åœ‹')) setStage('junior_high');
            else setStage('high_school');

            alert(`ä¿®æ”¹æˆåŠŸï¼ç›®å‰å¹´ç´šå·²æ›´æ–°ç‚ºï¼š${newGrade}`);
            closeProfileModal();
        } else {
            alert("ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•å„²å­˜è³‡æ–™");
        }
    }

    // ==========================================
    // ğŸ“š èª²ç¨‹æ¸²æŸ“é‚è¼¯
    // ==========================================
    function setStage(stage) {
        document.getElementById('currentStage').value = stage;
        const btnHigh = document.getElementById('btnHigh');
        const btnJunior = document.getElementById('btnJunior');
        
        if (stage === 'high_school') {
            btnHigh.className = "px-4 py-1.5 rounded-md transition shadow-sm bg-white text-gray-800 font-bold border border-gray-200";
            btnJunior.className = "px-4 py-1.5 rounded-md transition text-gray-500 hover:text-gray-700 font-bold";
        } else {
            btnHigh.className = "px-4 py-1.5 rounded-md transition text-gray-500 hover:text-gray-700 font-bold";
            btnJunior.className = "px-4 py-1.5 rounded-md transition shadow-sm bg-white text-gray-800 font-bold border border-gray-200";
        }
        renderCourses();
    }

    function renderCourses() {
        const stage = document.getElementById('currentStage').value;
        const container = document.getElementById('courseContainer');
        container.innerHTML = '';

        // åŸºç¤ç§‘ç›®
        let subjects = [
            { id: 'chinese', name: 'åœ‹æ–‡', icon: 'fa-book-open', color: 'red' },
            { id: 'math', name: 'æ•¸å­¸', icon: 'fa-calculator', color: 'blue' },
            { id: 'english', name: 'è‹±æ–‡', icon: 'fa-language', color: 'purple' },
        ];

        // è‡ªç„¶ç§‘ (å€åˆ†åœ‹é«˜ä¸­)
        if (stage === 'junior_high') {
            subjects.push(
                { id: 'biology', name: 'ç”Ÿç‰©', icon: 'fa-leaf', color: 'green' }, 
                { id: 'science', name: 'ç†åŒ–', icon: 'fa-flask', color: 'indigo' }, 
                { id: 'earth', name: 'åœ°ç§‘', icon: 'fa-globe', color: 'orange' }
            );
        } else {
            subjects.push(
                { id: 'physics', name: 'ç‰©ç†', icon: 'fa-atom', color: 'indigo' },
                { id: 'chemistry', name: 'åŒ–å­¸', icon: 'fa-vial', color: 'pink' },
                { id: 'biology', name: 'ç”Ÿç‰©', icon: 'fa-leaf', color: 'green' },
                { id: 'earth', name: 'åœ°ç§‘', icon: 'fa-globe', color: 'orange' }
            );
        }

        // ç¤¾æœƒç§‘
        subjects.push(
            { id: 'history', name: 'æ­·å²', icon: 'fa-landmark', color: 'amber' },
            { id: 'geography', name: 'åœ°ç†', icon: 'fa-globe-americas', color: 'cyan' },
            { id: 'civics', name: 'å…¬æ°‘', icon: 'fa-balance-scale', color: 'teal' }
        );

        subjects.forEach((sub, idx) => {
            const linkHref = `course_hub.html?subject=${sub.id}&stage=${stage}&title=${encodeURIComponent(sub.name)}`;
            
            const html = `
                <a href="${linkHref}" class="course-card bg-white rounded-xl p-6 flex flex-col items-center text-center hover:bg-${sub.color}-50 group fade-in" style="animation-delay: ${idx * 0.05}s">
                    <div class="w-16 h-16 rounded-2xl bg-${sub.color}-100 text-${sub.color}-600 flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition">
                        <i class="fas ${sub.icon}"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${sub.name}</h3>
                    <p class="text-xs text-gray-400 font-bold bg-gray-50 px-3 py-1 rounded-full border border-gray-100">
                        ${stage === 'high_school' ? 'é«˜ä¸­å…¨å†Š' : 'åœ‹ä¸­å…¨å†Š'}
                    </p>
                    <div class="mt-4 w-full pt-4 border-t border-gray-100 flex justify-center text-${sub.color}-600 font-bold text-sm">
                        é€²å…¥èª²ç¨‹ <i class="fas fa-arrow-right ml-2 mt-1 transition-transform group-hover:translate-x-1"></i>
                    </div>
                </a>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }
</script>
</body>
</html>
