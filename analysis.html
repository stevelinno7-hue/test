<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診斷分析 - 翰林雲端學院</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* 側邊欄統一：淺藍色風格 */
        .nav-item-active { 
            background-color: #eff6ff !important; /* bg-blue-50 */
            color: #2563eb !important;            /* text-blue-600 */
            font-weight: 700;
        }
        .nav-item-inactive { color: #64748b; }
        .nav-item-inactive:hover { background-color: #f8fafc; color: #1e293b; }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
    
    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
</head>
<body class="h-screen flex overflow-hidden">


<aside class="w-64 bg-white border-r border-slate-100 hidden lg:flex flex-col z-20 shrink-0 h-screen sticky top-0">
    <div class="h-16 flex items-center px-6 border-b border-slate-50">
        <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-sm mr-2 shadow-sm">翰</div>
        <span class="text-lg font-bold text-slate-800 tracking-tight">雲端學院</span>
    </div>

    <div class="px-4 py-6">
        <div class="bg-white border border-slate-50 rounded-2xl p-6 text-center shadow-sm">
            <div class="w-16 h-16 mx-auto bg-blue-50 rounded-full flex items-center justify-center text-2xl text-blue-500 mb-3 border-2 border-white shadow-sm">
                <i class="fas fa-user-graduate"></i>
            </div>
            <h3 class="font-bold text-slate-800 text-base" id="sideUserName">--</h3>
            <div class="text-[11px] text-slate-400 mt-1 mb-3 font-medium uppercase tracking-wider" id="sideUserRole">--</div>
            <button onclick="openProfileModal()" class="text-[10px] font-bold text-slate-400 border border-slate-200 px-3 py-1.5 rounded-full hover:bg-slate-50 hover:text-slate-600 transition-all">
                <i class="fas fa-pen mr-1"></i> 編輯年級
            </button>
        </div>
    </div>

    <nav id="mainNav" class="flex-grow px-3 space-y-1 overflow-y-auto no-scrollbar">
        <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all text-sm font-medium">
            <i class="fas fa-th-large w-5 text-center"></i> 課程總覽
        </a>
        <a href="remedial.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all text-sm font-medium">
            <i class="fas fa-book-medical w-5 text-center"></i> 錯題補救
        </a>
        <a href="analysis.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold shadow-sm transition-all text-sm">
            <i class="fas fa-chart-pie w-5 text-center text-blue-600"></i> 學習分析
        </a>
        <a href="forum.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all text-sm font-medium">
            <i class="fas fa-comments w-5 text-center"></i> 解題論壇
        </a>
    </nav>

    <div class="p-4 border-t border-slate-50">
        <button onclick="Auth.logout()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-red-500 py-3 transition-colors font-bold text-xs">
            <i class="fas fa-sign-out-alt"></i> 登出系統
        </button>
    </div>
</aside>

    <main class="flex-grow flex flex-col h-full bg-[#fcfdfe] overflow-hidden">
        <header class="h-16 bg-white border-b border-slate-100 flex items-center justify-between px-8 shrink-0 z-10">
            <div class="flex items-center gap-3">
                <h2 class="text-lg font-bold text-slate-800">測驗結果診斷</h2>
                <span class="text-slate-200">|</span>
                <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase" id="examMetaInfo">Analysis Report</p>
            </div>
            <a href="dashboard.html" class="text-slate-400 hover:text-blue-600 text-sm font-bold transition flex items-center gap-2">
                <i class="fas fa-arrow-left text-xs"></i> 返回首頁
            </a>
        </header>

        <div class="flex-grow overflow-y-auto p-8 no-scrollbar" id="reportContent">
            <div class="max-w-5xl mx-auto space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-50 p-8 flex flex-col items-center justify-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-blue-500" id="scoreBar"></div>
                        <h3 class="text-slate-400 font-bold text-[10px] uppercase tracking-widest mb-4">Exam Score</h3>
                        <div class="text-7xl font-black text-slate-800 mb-6 tracking-tighter" id="scoreDisplay">--</div>
                        <div class="grid grid-cols-2 gap-3 w-full">
                            <div class="bg-emerald-50 rounded-2xl p-3 text-center">
                                <div class="text-[8px] text-emerald-500 font-bold uppercase">Correct</div>
                                <div class="text-lg font-bold text-emerald-600" id="correctCount">--</div>
                            </div>
                            <div class="bg-slate-50 rounded-2xl p-3 text-center">
                                <div class="text-[8px] text-slate-400 font-bold uppercase">Total</div>
                                <div class="text-lg font-bold text-slate-600" id="totalCount">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-50 p-8 lg:col-span-2">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                <i class="fas fa-chart-radar text-blue-500"></i> 五大能力指標分析
                            </h3>
                        </div>
                        <div class="w-full h-56"><canvas id="radarChart"></canvas></div>
                    </div>
                </div>

                <div id="wrongList" class="space-y-6 pb-20"></div>
            </div>
        </div>

        <div id="noDataMessage" class="hidden flex-grow flex flex-col items-center justify-center text-center p-10 bg-white">
            <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center text-3xl text-slate-200 mb-6">
                <i class="fas fa-clipboard-question"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">尚無測驗數據</h2>
            <p class="text-slate-400 text-xs mb-8">完成測驗後，系統將生成深度診斷報告</p>
            <a href="dashboard.html" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100 text-sm">前往測驗</a>
        </div>
    </main>
    <script>
        // 初始化與數據處理邏輯
        const user = Auth.getCurrentUser();
        if (user) {
            document.getElementById('sideUserName').textContent = user.name;
            document.getElementById('sideUserRole').textContent = user.grade || "九年級學生";
        }

        const resultStr = localStorage.getItem('examResult');
        if (!resultStr) {
            document.getElementById('reportContent').classList.add('hidden');
            document.getElementById('noDataMessage').classList.remove('hidden');
        } else {
            const result = JSON.parse(resultStr);
            const scoreEl = document.getElementById('scoreDisplay');
            const scoreBar = document.getElementById('scoreBar');
            scoreEl.textContent = result.score;

            // 高風險作弊處理
            const isCheatHigh = result.cheat?.cheatLevel === 'HIGH' || result.tabCheat?.level === 'HIGH';
            if (isCheatHigh) {
                scoreEl.classList.add('text-red-600', 'score-critical');
                scoreBar.classList.replace('bg-blue-600', 'bg-red-500');
                document.getElementById('examMetaInfo').innerHTML = `<span class="text-red-600 font-bold"><i class="fas fa-triangle-exclamation mr-1"></i> 誠信警示：成績待複查</span>`;
            } else {
                document.getElementById('examMetaInfo').textContent = `${result.subject || '綜合測驗'} | ${new Date().toLocaleDateString()}`;
            }

            document.getElementById('correctCount').textContent = result.correctCount;
            document.getElementById('totalCount').textContent = result.totalCount;

            // 雷達圖繪製
            function getAbilityData(res) {
                // 此處模擬基於錯題概念的能力計算
                return [85, 72, 90, 65, 80]; // 順序：觀念、邏輯、運算、分析、應用
            }

            new Chart(document.getElementById('radarChart').getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ["觀念理解", "邏輯推演", "運算能力", "圖表分析", "素養應用"],
                    datasets: [{
                        data: getAbilityData(result),
                        backgroundColor: 'rgba(37, 99, 235, 0.15)',
                        borderColor: '#2563eb',
                        borderWidth: 2,
                        pointBackgroundColor: '#2563eb',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: { min: 0, max: 100, ticks: { display: false }, grid: { color: '#f1f5f9' }, angleLines: { color: '#f1f5f9' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            applyCheatResult(result);
            renderWrongList(result.wrongList);
        }

        function applyCheatResult(result) {
            const timeBox = document.getElementById('timeCheatBox');
            const timeText = document.getElementById('timeCheatText');
            const tabBox = document.getElementById('tabCheatBox');
            const tabText = document.getElementById('tabText');

            // 時間診斷樣式映射
            const config = {
                NORMAL: { cls: 'border-emerald-100 bg-emerald-50 text-emerald-700', icon: 'check-circle', msg: '作答節奏穩健，符合常態範圍' },
                MEDIUM: { cls: 'border-amber-100 bg-amber-50 text-amber-700', icon: 'circle-exclamation', msg: '部分題目思考時間較短，請保持細心' },
                HIGH: { cls: 'border-red-100 bg-red-50 text-red-700', icon: 'triangle-exclamation', msg: '偵測到多題秒答，建議重新檢視作答過程' }
            };

            const tCfg = config[result.cheat?.cheatLevel || 'NORMAL'];
            timeBox.className = `p-6 rounded-2xl border ${tCfg.cls}`;
            timeCheatText.innerHTML = `<span class="font-bold block mb-1">${tCfg.msg}</span><span class="opacity-70">異常秒數題數：${result.cheat?.fastCount || 0} 題</span>`;

            const tabCfg = config[result.tabCheat?.level || 'NORMAL'];
            tabCheatBox.className = `p-6 rounded-2xl border ${tabCfg.cls}`;
            tabCheatText.innerHTML = `<span class="font-bold block mb-1">${tabCfg.msg.replace('作答', '切換')}</span><span class="opacity-70">分頁切換紀錄：${result.tabCheat?.totalSwitch || 0} 次</span>`;
        }

        function renderWrongList(list) {
            const container = document.getElementById('wrongList');
            if (list.length === 0) {
                container.innerHTML = `<div class="bg-emerald-50 border border-emerald-100 p-10 rounded-3xl text-center"><i class="fas fa-crown text-amber-400 text-4xl mb-4"></i><h3 class="text-emerald-800 font-bold text-xl">全對！表現堪稱完美</h3></div>`;
                return;
            }

            list.forEach((q, i) => {
                container.innerHTML += `
                    <div class="bg-white rounded-3xl border border-slate-100 overflow-hidden shadow-sm hover:border-blue-200 transition-colors">
                        <div class="p-8">
                            <div class="flex items-center gap-3 mb-6">
                                <span class="bg-red-50 text-red-500 text-[10px] font-black px-3 py-1 rounded-full border border-red-100 uppercase tracking-widest">Error ${i+1}</span>
                                <span class="bg-slate-100 text-slate-400 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">${q.concept || '核心概念'}</span>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-8 leading-relaxed">${q.question}</h3>
                            <div class="space-y-3">
                                ${q.options.map((opt, idx) => {
                                    const isCorrect = idx === q.answer;
                                    const isWrong = idx === q.yourAns;
                                    const style = isCorrect ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : (isWrong ? 'bg-red-50 border-red-200 text-red-700' : 'bg-slate-50 border-slate-100 text-slate-500 opacity-60');
                                    const icon = isCorrect ? 'fa-check-circle' : (isWrong ? 'fa-times-circle' : 'fa-circle');
                                    return `<div class="flex items-center p-4 rounded-2xl border ${style} transition-all">
                                        <i class="fas ${icon} mr-4 text-lg"></i>
                                        <span class="font-bold">${opt}</span>
                                        ${isCorrect ? '<span class="ml-auto text-[10px] font-black uppercase">Correct</span>' : ''}
                                        ${isWrong ? '<span class="ml-auto text-[10px] font-black uppercase">Your Choice</span>' : ''}
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="bg-blue-50/50 p-8 border-t border-blue-50">
                            <div class="flex gap-4">
                                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center shrink-0"><i class="fas fa-lightbulb"></i></div>
                                <div>
                                    <h4 class="font-black text-blue-800 text-xs uppercase tracking-widest mb-2">Detailed Analysis</h4>
                                    <p class="text-slate-600 text-sm leading-loose">${q.explanation ? q.explanation.join('') : '分析載入中...'}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
