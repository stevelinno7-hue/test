<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡é»è¤‡ç¿’ - é›²ç«¯å­¸é™¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .unit-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .unit-item:hover { background-color: #f1f5f9; }
        .unit-item.active { background-color: #eff6ff; color: #2563eb; border-left-color: #2563eb; font-weight: bold; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>

    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/generator_engine.js"></script>
    <script src="mockdata/generator_engine_polyfill.js"></script>
    <script src="mockdata/AutoTemplateFissionFactory.js"></script>
    <script src="mockdata/auto_fission_bootstrap.js"></script>
    <script src="mockdata/paper_generator.js"></script>
    <script src="mockdata/curriculum_integrated.js"></script>
    
    <script src="mockdata/templates_math_algebra_geometry.js"></script>
    <script src="mockdata/templates_physics_multistep.js"></script>
    <script src="mockdata/templates_chemistry_core.js"></script>
    <script src="mockdata/templates_biology_core.js"></script> 
    <script src="mockdata/templates_english_core.js"></script>
    <script src="mockdata/templates_chinese_core.js"></script>
    <script src="mockdata/templates_history_core.js"></script>
    <script src="mockdata/templates_geography_core.js"></script>
    <script src="mockdata/templates_civics_core.js"></script>
</head>
<body class="h-screen flex overflow-hidden">
    <aside class="w-64 bg-white border-r border-slate-100 hidden lg:flex flex-col z-20 shrink-0 h-screen sticky top-0">
        <div class="h-16 flex items-center px-6 border-b border-slate-50">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-sm mr-2 shadow-sm">å­¸</div>
            <span class="text-lg font-bold text-slate-800">é›²ç«¯å­¸é™¢</span>
        </div>
        <div class="px-4 py-6">
            <div class="bg-white border border-slate-50 rounded-2xl p-6 text-center shadow-sm">
                <h3 class="font-bold text-slate-800" id="sideUserName">è¨ªå®¢</h3>
                <div class="text-[11px] text-slate-400 mt-1 mb-3" id="sideUserRole">å­¸ç”Ÿ</div>
            </div>
        </div>
        <nav class="flex-grow px-3 space-y-1">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-book-medical w-5 text-center"></i> èª²ç¨‹ç¸½è¦½</a>
            <a href="remedial.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-book-medical w-5 text-center"></i> éŒ¯é¡Œè£œæ•‘</a>
            <a href="study.html"class="flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold shadow-sm"><i class="fas fa-th-large w-5 text-center"></i> é‡é»è¤‡ç¿’</a>
            <a href="arcade.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-gamepad w-5 text-center"></i> éŠæˆ²å ´</a>
            <a href="forum.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-gamepad w-5 text-center"></i> è§£é¡Œè«–å£‡</a>
        </nav>
        <div class="p-4 border-t border-slate-50">
            <button onclick="Auth.logout()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-red-500 py-3 transition-colors font-bold text-xs"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºç³»çµ±</button>
        </div>
    </aside>

    <main class="flex-grow flex h-full relative overflow-hidden">
        
        <div class="w-64 bg-slate-50 border-r border-slate-200 flex-shrink-0 flex flex-col h-full">
            <div class="p-4 border-b border-slate-200 bg-white">
                <label class="text-xs font-bold text-gray-400 uppercase">ç§‘ç›®é¸æ“‡</label>
                <select id="subjectSelect" onchange="loadBookMenu()" class="w-full mt-1 p-2 border border-slate-200 rounded-lg font-bold text-slate-700 focus:outline-none focus:border-blue-500">
                    <optgroup label="ä¸»è¦å­¸ç§‘">
                        <option value="math">ğŸ“ æ•¸å­¸</option>
                        <option value="english">ğŸ”¤ è‹±æ–‡</option>
                        <option value="chinese">ğŸ€„ åœ‹æ–‡</option>
                    </optgroup>
                    
                    <optgroup label="è‡ªç„¶ç§‘å­¸" id="scienceGroup">
                        <option value="science" id="optScience" class="hidden">ğŸ§ª è‡ªç„¶ (ç†åŒ–)</option>
                        <option value="physics" id="optPhysics">ğŸ§² ç‰©ç†</option>
                        <option value="chemistry" id="optChemistry">âš—ï¸ åŒ–å­¸</option>
                        <option value="biology">ğŸ§¬ ç”Ÿç‰©</option>
                        <option value="earth">ğŸŒ åœ°çƒç§‘å­¸</option>
                    </optgroup>

                    <optgroup label="ç¤¾æœƒäººæ–‡">
                        <option value="history">ğŸ“œ æ­·å²</option>
                        <option value="geography">ğŸ—ºï¸ åœ°ç†</option>
                        <option value="civics">âš–ï¸ å…¬æ°‘</option>
                    </optgroup>
                </select>
            </div>
            <div class="flex-grow overflow-y-auto p-2 space-y-4 no-scrollbar" id="unitMenu">
                <div class="text-center py-10 text-gray-400 text-sm"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div class="flex-grow flex flex-col h-full bg-white relative">
            <div class="h-16 border-b border-slate-100 flex items-center justify-between px-8 bg-white z-10">
                <div>
                    <h2 class="text-xl font-bold text-slate-800" id="currentUnitTitle">è«‹é¸æ“‡å–®å…ƒ</h2>
                    <p class="text-xs text-slate-400" id="currentUnitSub">é»æ“Šå·¦å´ç›®éŒ„ä»¥æª¢è¦–é‡é»</p>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto p-8 scroll-smooth" id="contentScroll">
                <div class="max-w-3xl mx-auto space-y-6" id="notesContainer">
                    <div class="flex flex-col items-center justify-center h-full text-slate-300 py-20">
                        <i class="fas fa-book-open text-6xl mb-4"></i>
                        <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å–®å…ƒé–‹å§‹è¤‡ç¿’</p>
                    </div>
                </div>
                <div class="h-20"></div> 
            </div>
        </div>

    </main>

    <script>
        // 1. å®šç¾©å…¨åŸŸè®Šæ•¸
        let currentSubject = 'math';
        let userStage = 'high_school'; 

        window.onload = function() {
            // --- A. è™•ç†ä½¿ç”¨è€…ç™»å…¥èˆ‡å­¸åˆ¶åˆ¤æ–· ---
            const user = Auth.getCurrentUser();
            if(user) {
                document.getElementById('sideUserName').textContent = user.name;
                document.getElementById('sideUserRole').textContent = user.grade;
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºåœ‹ä¸­ç”Ÿ
                if(user.grade && user.grade.includes('åœ‹')) {
                    userStage = 'junior_high';
                } else {
                    userStage = 'high_school';
                }
            }
            if(typeof setStage === 'function') setStage(userStage);

            // --- B. è‡ªå‹•èª¿æ•´ä¸‹æ‹‰é¸å–® (é‡è¦æ›´æ–°) ---
            const optScience = document.getElementById('optScience');
            const optPhysics = document.getElementById('optPhysics');
            const optChemistry = document.getElementById('optChemistry');
            const subjectSelect = document.getElementById('subjectSelect');

            if (userStage === 'junior_high') {
                // å¦‚æœæ˜¯åœ‹ä¸­ç”Ÿï¼šé¡¯ç¤ºã€Œè‡ªç„¶(ç†åŒ–)ã€ï¼Œéš±è—ç‰©ç†/åŒ–å­¸
                optScience.classList.remove('hidden');
                optPhysics.classList.add('hidden');
                optChemistry.classList.add('hidden');
                
                // å¦‚æœåŸæœ¬é è¨­æ˜¯ mathï¼Œä¿æŒ mathï¼›ä½†å¦‚æœæ²’æœ‰é¸ï¼Œé è¨­è·³è½‰é‚è¼¯
                // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœæ˜¯ math ä¸å‹•ï¼Œå…¶ä»–å‰‡é è¨­
            } else {
                // å¦‚æœæ˜¯é«˜ä¸­ç”Ÿï¼šéš±è—æ•´åˆçš„ç†åŒ–ï¼Œé¡¯ç¤ºåˆ†ç§‘
                optScience.classList.add('hidden');
                optPhysics.classList.remove('hidden');
                optChemistry.classList.remove('hidden');
            }

            // --- C. è™•ç†ç¶²å€åƒæ•¸èˆ‡é è¨­å€¼ ---
            const urlParams = new URLSearchParams(window.location.search);
            let filterParam = urlParams.get('filter');

            // å¦‚æœåƒæ•¸æ˜¯ç‰©ç†æˆ–åŒ–å­¸ï¼Œä¸”æ˜¯åœ‹ä¸­ç”Ÿï¼Œå¼·åˆ¶è½‰ç‚º science
            if ((filterParam === 'physics' || filterParam === 'chemistry') && userStage === 'junior_high') {
                filterParam = 'science';
            }

            currentSubject = filterParam || 'math';
            subjectSelect.value = currentSubject;

            // --- D. åˆå§‹åŒ– ---
            setTimeout(() => {
                if(window.initCurriculumData) window.initCurriculumData(); 
                patchScienceData(userStage); // åŸ·è¡Œè³‡æ–™è£œä¸
                loadBookMenu();
            }, 300);
        };

        // è³‡æ–™è£œä¸ï¼šç¢ºä¿åœ‹ä¸­ç†åŒ–è³‡æ–™å­˜åœ¨
        function patchScienceData(stage) {
            if (!window.CurriculumLibrary || !window.CurriculumLibrary.data) return;

            // ç¢ºä¿ physics å’Œ chemistry é™£åˆ—å­˜åœ¨
            if (!window.CurriculumLibrary.data['physics']) window.CurriculumLibrary.data['physics'] = [];
            if (!window.CurriculumLibrary.data['chemistry']) window.CurriculumLibrary.data['chemistry'] = [];

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰åœ‹ä¸­ç‰©ç†
            const hasJuniorPhysics = window.CurriculumLibrary.data['physics'].some(b => b.stage === 'junior_high');
            if (!hasJuniorPhysics && stage === 'junior_high') {
                window.CurriculumLibrary.data['physics'].push({
                    book: "åœ‹ä¸­ç†åŒ– (ç‰©ç†ç¯‡)",
                    stage: "junior_high",
                    // æ¨™è¨˜é€™æ˜¯ç‰©ç†ä¾†æºï¼Œä¾›æ··åˆæ™‚è­˜åˆ¥
                    sourceSubject: "physics", 
                    units: [
                        { name: "åŸºæœ¬æ¸¬é‡èˆ‡å¯†åº¦", tags: ["æ¸¬é‡", "å¯†åº¦"] },
                        { name: "åŠ›èˆ‡é‹å‹•", tags: ["ç‰›é “é‹å‹•å®šå¾‹", "åŠ›"] },
                        { name: "åŠŸèˆ‡èƒ½", tags: ["åŠŸ", "èƒ½é‡"] },
                        { name: "æº«åº¦èˆ‡ç†±", tags: ["ç†±å­¸", "æ¯”ç†±"] },
                        { name: "æ³¢å‹•èˆ‡è²éŸ³", tags: ["æ³¢å‹•", "è²éŸ³"] },
                        { name: "å…‰èˆ‡æŠ˜å°„", tags: ["å…‰å­¸", "æŠ˜å°„"] },
                        { name: "é›»èˆ‡ç£", tags: ["é›»å­¸", "ç£å ´"] }
                    ]
                });
            }

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰åœ‹ä¸­åŒ–å­¸
            const hasJuniorChem = window.CurriculumLibrary.data['chemistry'].some(b => b.stage === 'junior_high');
            if (!hasJuniorChem && stage === 'junior_high') {
                window.CurriculumLibrary.data['chemistry'].push({
                    book: "åœ‹ä¸­ç†åŒ– (åŒ–å­¸ç¯‡)",
                    stage: "junior_high",
                    sourceSubject: "chemistry",
                    units: [
                        { name: "ç‰©è³ªçš„åˆ†é¡èˆ‡è®ŠåŒ–", tags: ["ç‰©è³ª", "åŒ–å­¸è®ŠåŒ–"] },
                        { name: "åŸå­çµæ§‹èˆ‡å…ƒç´ é€±æœŸè¡¨", tags: ["åŸå­", "é€±æœŸè¡¨"] },
                        { name: "åŒ–å­¸åæ‡‰èˆ‡è¨ˆé‡", tags: ["åŒ–å­¸åæ‡‰", "è«è€³"] },
                        { name: "æ°§åŒ–é‚„åŸ", tags: ["æ°§åŒ–é‚„åŸ"] },
                        { name: "é…¸é¹¼é¹½", tags: ["é…¸é¹¼", "pHå€¼"] },
                        { name: "æœ‰æ©ŸåŒ–åˆç‰©", tags: ["æœ‰æ©ŸåŒ–å­¸", "ç¢³æ°«åŒ–åˆç‰©"] }
                    ]
                });
            }
        }

        // 2. è¼‰å…¥é¸å–® (åŒ…å«åˆä½µé‚è¼¯)
        function loadBookMenu() {
            const subjectSelect = document.getElementById('subjectSelect');
            if(subjectSelect) currentSubject = subjectSelect.value;
            
            const menu = document.getElementById('unitMenu');
            menu.innerHTML = '';

            if (!window.CurriculumLibrary || !window.CurriculumLibrary.data) {
                menu.innerHTML = `<div class="p-4 text-center text-sm text-gray-400">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>`;
                return;
            }

            let books = [];

            // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šè™•ç†ã€Œscience (ç†åŒ–)ã€çš„åˆä½µé‚è¼¯ â˜…â˜…â˜…
            if (currentSubject === 'science') {
                // 1. æŠ“å–ç‰©ç†è³‡æ–™
                const phyBooks = (window.CurriculumLibrary.data['physics'] || [])
                    .filter(b => b.stage === userStage)
                    .map(b => ({...b, realSubject: 'physics'})); // æ¨™è¨˜çœŸå¯¦ç§‘ç›®
                
                // 2. æŠ“å–åŒ–å­¸è³‡æ–™
                const chemBooks = (window.CurriculumLibrary.data['chemistry'] || [])
                    .filter(b => b.stage === userStage)
                    .map(b => ({...b, realSubject: 'chemistry'})); // æ¨™è¨˜çœŸå¯¦ç§‘ç›®

                // 3. åˆä½µ
                books = [...phyBooks, ...chemBooks];

            } else {
                // æ­£å¸¸å–®ç§‘è™•ç†
                const allBooks = window.CurriculumLibrary.data[currentSubject] || [];
                books = allBooks.filter(b => b.stage === userStage)
                                .map(b => ({...b, realSubject: currentSubject}));
            }

            if (books.length === 0) {
                menu.innerHTML = `<div class="p-4 text-center text-sm text-gray-400 bg-slate-100 m-2 rounded">æ­¤ç§‘ç›®å°šç„¡è³‡æ–™</div>`;
                return;
            }

            books.forEach((book, bIdx) => {
                const detailsOpen = bIdx === 0 ? 'open' : '';
                let unitsHtml = '';
                
                book.units.forEach((unit, uIdx) => {
                    const tagsStr = encodeURIComponent(JSON.stringify(unit.tags || []));
                    // é»æ“Šæ™‚ï¼Œå‚³å…¥çœŸå¯¦ç§‘ç›® (book.realSubject)ï¼Œé€™æ¨£ AI æ‰çŸ¥é“è¦ç”¨ç‰©ç†é‚„æ˜¯åŒ–å­¸å…¬å¼
                    unitsHtml += `
                        <div class="unit-item px-4 py-3 text-sm text-slate-600 rounded-lg mb-1 flex items-center gap-2 cursor-pointer hover:bg-slate-100" 
                             onclick="loadUnitContent('${unit.name}', '${tagsStr}', this, '${book.realSubject}')">
                            <i class="fas fa-circle text-[6px] text-slate-300"></i>
                            ${unit.name}
                        </div>`;
                });

                const html = `
                    <details ${detailsOpen} class="group">
                        <summary class="flex items-center justify-between p-3 font-bold text-slate-700 cursor-pointer hover:bg-slate-100 rounded-lg list-none">
                            <span>${book.book}</span>
                            <i class="fas fa-chevron-down text-xs text-slate-400 transition-transform group-open:rotate-180"></i>
                        </summary>
                        <div class="pl-2 mt-1 space-y-1 border-l-2 border-slate-100 ml-3">
                            ${unitsHtml}
                        </div>
                    </details>
                `;
                menu.insertAdjacentHTML('beforeend', html);
            });
        }

        // 3. å…§å®¹ç”Ÿæˆ (æ”¯æ´çœŸå¯¦ç§‘ç›®åƒæ•¸)
        function loadUnitContent(unitName, tagsStr, el, realSubject) {
            // UI Highlight
            document.querySelectorAll('.unit-item').forEach(i => i.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'font-bold'));
            el.classList.add('active', 'bg-blue-50', 'text-blue-600', 'font-bold');
            
            // é¡¯ç¤ºæ¨™é¡Œ (å¦‚æœæ˜¯åˆä½µçš„ç†åŒ–ï¼Œé€™è£¡é¡¯ç¤ºå­æ¨™é¡Œæ¯”è¼ƒæ¸…æ¥š)
            let displaySubject = currentSubject;
            if (currentSubject === 'science') {
                displaySubject = realSubject === 'physics' ? 'ç†åŒ– (ç‰©ç†ç¯‡)' : 'ç†åŒ– (åŒ–å­¸ç¯‡)';
            }
            
            document.getElementById('currentUnitTitle').textContent = unitName;
            document.getElementById('currentUnitSub').textContent = `ç§‘ç›®ï¼š${displaySubject} | ä¾†æºï¼šæ™ºæ…§é¡Œåº«`;

            const tags = JSON.parse(decodeURIComponent(tagsStr));
            const container = document.getElementById('notesContainer');
            
            container.innerHTML = '<div class="text-center py-10 text-gray-400"><i class="fas fa-spinner fa-spin"></i> AI æ­£åœ¨æ•´ç†é‡é»...</div>';

            setTimeout(() => {
                let questions = [];
                if (window.generatePaper) {
                    // â˜… é€™è£¡ä½¿ç”¨ realSubject (ä¾‹å¦‚ 'physics') å‚³çµ¦ç”Ÿæˆå¼•æ“ï¼Œè€Œä¸æ˜¯ 'science'
                    // å› ç‚ºå¼•æ“åªèªå¾— 'physics' æˆ– 'chemistry' çš„æ¨¡æ¿
                    questions = window.generatePaper({ subject: realSubject || currentSubject, total: 6, tags: tags });
                }

                if (!questions || questions.length === 0) {
                    container.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-100 p-8 rounded-xl text-center">
                            <i class="fas fa-exclamation-circle text-yellow-500 text-3xl mb-3"></i>
                            <p class="text-yellow-700 font-bold">æœ¬å–®å…ƒç›®å‰å°šç„¡é‡é»è³‡æ–™</p>
                        </div>`;
                    return;
                }

                let contentHtml = '';
                questions.forEach((q, idx) => {
                    const concept = q.concept || unitName.split(' ')[0] || 'æ ¸å¿ƒè§€å¿µ';
                    const explain = (q.explanation && q.explanation.length > 0) ? q.explanation.join('<br>') : "è§€å¿µæ‡‰ç”¨é¡Œ";
                    
                    // Logic to add a relevant diagram based on realSubject
                    let imageTag = '';
                    if (realSubject === 'physics') {
                        imageTag = `<div class="mb-4 text-center"></div>`;
                    } else if (realSubject === 'chemistry') {
                        imageTag = `<div class="mb-4 text-center"></div>`;
                    } else if (['biology', 'earth'].includes(currentSubject)) {
                        imageTag = `<div class="mb-4 text-center"></div>`;
                    }

                    contentHtml += `
                        <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm fade-in hover:shadow-md transition" style="animation-delay: ${idx * 0.1}s">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="bg-indigo-50 text-indigo-600 text-xs font-bold px-2 py-1 rounded">é‡é» ${idx + 1}</span>
                                <span class="text-sm font-bold text-slate-700">${concept}</span>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-1">Example</div>
                                <div class="text-slate-800 font-medium text-lg leading-relaxed">
                                    ${q.question.replace(/\n/g, '<br>')}
                                </div>
                            </div>

                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <div class="flex gap-3">
                                    <div class="mt-0.5"><i class="fas fa-lightbulb text-yellow-500"></i></div>
                                    <div class="w-full">
                                        <div class="text-xs font-bold text-slate-500 mb-1">è§€å¿µè§£æ</div>
                                        ${imageTag}
                                        <div class="text-sm text-slate-600 leading-relaxed">
                                            ${explain}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = contentHtml;
                if(window.MathJax) MathJax.typesetPromise();

            }, 300);
        }
    </script>
</body>
</html>
