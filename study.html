<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡é»è¤‡ç¿’ - é›²ç«¯å­¸é™¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .unit-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .unit-item:hover { background-color: #f1f5f9; }
        .unit-item.active { background-color: #eff6ff; color: #2563eb; border-left-color: #2563eb; font-weight: bold; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>

    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/generator_engine.js"></script>
    <script src="mockdata/generator_engine_polyfill.js"></script>
    <script src="mockdata/AutoTemplateFissionFactory.js"></script>
    <script src="mockdata/auto_fission_bootstrap.js"></script>
    <script src="mockdata/paper_generator.js"></script>
    <script src="mockdata/curriculum_integrated.js"></script>
    
    <script src="mockdata/templates_math_algebra_geometry.js"></script>
    <script src="mockdata/templates_physics_multistep.js"></script>
    <script src="mockdata/templates_chemistry_core.js"></script>
    <script src="mockdata/templates_biology_core.js"></script> 
    <script src="mockdata/templates_english_core.js"></script>
    <script src="mockdata/templates_chinese_core.js"></script>
    <script src="mockdata/templates_history_core.js"></script>
    <script src="mockdata/templates_geography_core.js"></script>
    <script src="mockdata/templates_civics_core.js"></script>
</head>
<body class="h-screen flex overflow-hidden">
    <aside class="w-64 bg-white border-r border-slate-100 hidden lg:flex flex-col z-20 shrink-0 h-screen sticky top-0">
        <div class="h-16 flex items-center px-6 border-b border-slate-50">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-sm mr-2 shadow-sm">å­¸</div>
            <span class="text-lg font-bold text-slate-800">é›²ç«¯å­¸é™¢</span>
        </div>
        <div class="px-4 py-6">
            <div class="bg-white border border-slate-50 rounded-2xl p-6 text-center shadow-sm">
                <h3 class="font-bold text-slate-800" id="sideUserName">è¨ªå®¢</h3>
                <div class="text-[11px] text-slate-400 mt-1 mb-3" id="sideUserRole">å­¸ç”Ÿ</div>
            </div>
        </div>
        <nav class="flex-grow px-3 space-y-1">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-book-medical w-5 text-center"></i> èª²ç¨‹ç¸½è¦½</a>
            <a href="remedial.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-book-medical w-5 text-center"></i> éŒ¯é¡Œè£œæ•‘</a>
            <a href="study.html"class="flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold shadow-sm"><i class="fas fa-th-large w-5 text-center"></i> é‡é»è¤‡ç¿’</a>
            <a href="arcade.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-gamepad w-5 text-center"></i> éŠæˆ²å ´</a>
            <a href="forum.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-gamepad w-5 text-center"></i> è§£é¡Œè«–å£‡</a>
        </nav>
        <div class="p-4 border-t border-slate-50">
            <button onclick="Auth.logout()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-red-500 py-3 transition-colors font-bold text-xs"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºç³»çµ±</button>
        </div>
    </aside>

    <main class="flex-grow flex h-full relative overflow-hidden">
        
        <div class="w-64 bg-slate-50 border-r border-slate-200 flex-shrink-0 flex flex-col h-full">
            <div class="p-4 border-b border-slate-200 bg-white">
                <label class="text-xs font-bold text-gray-400 uppercase">ç§‘ç›®é¸æ“‡</label>
                <select id="subjectSelect" onchange="loadBookMenu()" class="w-full mt-1 p-2 border border-slate-200 rounded-lg font-bold text-slate-700 focus:outline-none focus:border-blue-500">
                    <optgroup label="ä¸»è¦å­¸ç§‘">
                        <option value="math">ğŸ“ æ•¸å­¸</option>
                        <option value="english">ğŸ”¤ è‹±æ–‡</option>
                        <option value="chinese">ğŸ€„ åœ‹æ–‡</option>
                    </optgroup>
                    <optgroup label="è‡ªç„¶ç§‘å­¸ (ç†åŒ–)">
                        <option value="physics">ğŸ§² ç‰©ç† / ç†åŒ–(ä¸Š)</option>
                        <option value="chemistry">âš—ï¸ åŒ–å­¸ / ç†åŒ–(ä¸‹)</option>
                        <option value="biology">ğŸ§¬ ç”Ÿç‰©</option>
                        <option value="earth">ğŸŒ åœ°çƒç§‘å­¸</option>
                    </optgroup>
                    <optgroup label="ç¤¾æœƒäººæ–‡">
                        <option value="history">ğŸ“œ æ­·å²</option>
                        <option value="geography">ğŸ—ºï¸ åœ°ç†</option>
                        <option value="civics">âš–ï¸ å…¬æ°‘</option>
                    </optgroup>
                </select>
            </div>
            <div class="flex-grow overflow-y-auto p-2 space-y-4 no-scrollbar" id="unitMenu">
                <div class="text-center py-10 text-gray-400 text-sm"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div class="flex-grow flex flex-col h-full bg-white relative">
            <div class="h-16 border-b border-slate-100 flex items-center justify-between px-8 bg-white z-10">
                <div>
                    <h2 class="text-xl font-bold text-slate-800" id="currentUnitTitle">è«‹é¸æ“‡å–®å…ƒ</h2>
                    <p class="text-xs text-slate-400" id="currentUnitSub">é»æ“Šå·¦å´ç›®éŒ„ä»¥æª¢è¦–é‡é»</p>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto p-8 scroll-smooth" id="contentScroll">
                <div class="max-w-3xl mx-auto space-y-6" id="notesContainer">
                    <div class="flex flex-col items-center justify-center h-full text-slate-300 py-20">
                        <i class="fas fa-book-open text-6xl mb-4"></i>
                        <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å–®å…ƒé–‹å§‹è¤‡ç¿’</p>
                    </div>
                </div>
                <div class="h-20"></div> 
            </div>
        </div>

    </main>

    <script>
        // 1. å®šç¾©å…¨åŸŸè®Šæ•¸
        let currentSubject = 'math';
        let userStage = 'high_school'; // é è¨­å€¼

        window.onload = function() {
            // --- A. è™•ç†ä½¿ç”¨è€…ç™»å…¥èˆ‡å­¸åˆ¶åˆ¤æ–· ---
            const user = Auth.getCurrentUser();
            if(user) {
                document.getElementById('sideUserName').textContent = user.name;
                document.getElementById('sideUserRole').textContent = user.grade;
                if(user.grade && user.grade.includes('åœ‹')) {
                    userStage = 'junior_high';
                } else {
                    userStage = 'high_school';
                }
            }
            if(typeof setStage === 'function') setStage(userStage);

            // --- B. è™•ç†ç¶²å€åƒæ•¸ ---
            const urlParams = new URLSearchParams(window.location.search);
            currentSubject = urlParams.get('filter') || 'math';
            const subjectSelect = document.getElementById('subjectSelect');
            if(subjectSelect) subjectSelect.value = currentSubject;

            // --- C. åˆå§‹åŒ–è³‡æ–™åº«ä¸¦ä¿®å¾©ç†åŒ–ç¼ºæ¼ ---
            setTimeout(() => {
                if(window.initCurriculumData) window.initCurriculumData(); 
                patchScienceData(userStage); // â˜… åŸ·è¡Œç†åŒ–è³‡æ–™è£œä¸
                loadBookMenu();
            }, 300);
        };

        // â˜…â˜…â˜… æ–°å¢ï¼šç†åŒ–è³‡æ–™è£œä¸å‡½æ•¸ â˜…â˜…â˜…
        // ç”¨é€”ï¼šå¦‚æœç³»çµ±ç™¼ç¾æ˜¯åœ‹ä¸­éšæ®µï¼Œä½†æ‰¾ä¸åˆ°ã€Œç‰©ç†/åŒ–å­¸ã€çš„åœ‹ä¸­å°æ‡‰æ›¸æœ¬ï¼Œè‡ªå‹•è£œä¸Šã€Œåœ‹ä¸­ç†åŒ–ã€è³‡æ–™
        function patchScienceData(stage) {
            if (!window.CurriculumLibrary || !window.CurriculumLibrary.data) return;

            // 1. è£œä¸ï¼šåœ‹ä¸­ç‰©ç† (æ­¸é¡åœ¨ physics)
            if (!window.CurriculumLibrary.data['physics']) window.CurriculumLibrary.data['physics'] = [];
            const hasJuniorPhysics = window.CurriculumLibrary.data['physics'].some(b => b.stage === 'junior_high');
            
            if (!hasJuniorPhysics && stage === 'junior_high') {
                window.CurriculumLibrary.data['physics'].push({
                    book: "åœ‹ä¸­ç†åŒ– (ç‰©ç†ç¯‡)",
                    stage: "junior_high",
                    units: [
                        { name: "åŸºæœ¬æ¸¬é‡èˆ‡å¯†åº¦", tags: ["æ¸¬é‡", "å¯†åº¦"] },
                        { name: "åŠ›èˆ‡é‹å‹•", tags: ["ç‰›é “é‹å‹•å®šå¾‹", "åŠ›"] },
                        { name: "åŠŸèˆ‡èƒ½", tags: ["åŠŸ", "èƒ½é‡"] },
                        { name: "æº«åº¦èˆ‡ç†±", tags: ["ç†±å­¸", "æ¯”ç†±"] },
                        { name: "æ³¢å‹•èˆ‡è²éŸ³", tags: ["æ³¢å‹•", "è²éŸ³"] },
                        { name: "å…‰èˆ‡æŠ˜å°„", tags: ["å…‰å­¸", "æŠ˜å°„"] },
                        { name: "é›»èˆ‡ç£", tags: ["é›»å­¸", "ç£å ´"] }
                    ]
                });
            }

            // 2. è£œä¸ï¼šåœ‹ä¸­åŒ–å­¸ (æ­¸é¡åœ¨ chemistry)
            if (!window.CurriculumLibrary.data['chemistry']) window.CurriculumLibrary.data['chemistry'] = [];
            const hasJuniorChem = window.CurriculumLibrary.data['chemistry'].some(b => b.stage === 'junior_high');

            if (!hasJuniorChem && stage === 'junior_high') {
                window.CurriculumLibrary.data['chemistry'].push({
                    book: "åœ‹ä¸­ç†åŒ– (åŒ–å­¸ç¯‡)",
                    stage: "junior_high",
                    units: [
                        { name: "ç‰©è³ªçš„åˆ†é¡èˆ‡è®ŠåŒ–", tags: ["ç‰©è³ª", "åŒ–å­¸è®ŠåŒ–"] },
                        { name: "åŸå­çµæ§‹èˆ‡å…ƒç´ é€±æœŸè¡¨", tags: ["åŸå­", "é€±æœŸè¡¨"] },
                        { name: "åŒ–å­¸åæ‡‰èˆ‡è¨ˆé‡", tags: ["åŒ–å­¸åæ‡‰", "è«è€³"] },
                        { name: "æ°§åŒ–é‚„åŸ", tags: ["æ°§åŒ–é‚„åŸ"] },
                        { name: "é…¸é¹¼é¹½", tags: ["é…¸é¹¼", "pHå€¼"] },
                        { name: "æœ‰æ©ŸåŒ–åˆç‰©", tags: ["æœ‰æ©ŸåŒ–å­¸", "ç¢³æ°«åŒ–åˆç‰©"] }
                    ]
                });
            }
        }

        // 2. è¼‰å…¥å·¦å´é¸å–® (ç¶­æŒä¸è®Šï¼Œä½†ç¾åœ¨èƒ½è®€åˆ°è£œä¸å¾Œçš„è³‡æ–™äº†)
        function loadBookMenu() {
            const subjectSelect = document.getElementById('subjectSelect');
            if(subjectSelect) currentSubject = subjectSelect.value;
            
            const menu = document.getElementById('unitMenu');
            menu.innerHTML = '';

            if (!window.CurriculumLibrary || !window.CurriculumLibrary.data) {
                menu.innerHTML = `<div class="p-4 text-center text-sm text-gray-400">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>`;
                return;
            }

            const allBooks = window.CurriculumLibrary.data[currentSubject] || [];
            // æ ¹æ“šä½¿ç”¨è€…çš„å­¸åˆ¶ç¯©é¸æ›¸æœ¬
            const books = allBooks.filter(b => b.stage === userStage);

            if (books.length === 0) {
                let msg = "æ­¤ç§‘ç›®å°šç„¡å°æ‡‰å­¸åˆ¶çš„è³‡æ–™";
                if(currentSubject === 'physics' || currentSubject === 'chemistry') {
                    if(userStage === 'junior_high') msg = "æ‰¾ä¸åˆ°åœ‹ä¸­ç†åŒ–è³‡æ–™";
                }
                menu.innerHTML = `<div class="p-4 text-center text-sm text-gray-400 bg-slate-100 m-2 rounded">${msg}</div>`;
                return;
            }

            books.forEach((book, bIdx) => {
                const detailsOpen = bIdx === 0 ? 'open' : '';
                let unitsHtml = '';
                
                book.units.forEach((unit, uIdx) => {
                    const tagsStr = encodeURIComponent(JSON.stringify(unit.tags || []));
                    unitsHtml += `
                        <div class="unit-item px-4 py-3 text-sm text-slate-600 rounded-lg mb-1 flex items-center gap-2 cursor-pointer hover:bg-slate-100" 
                             onclick="loadUnitContent('${unit.name}', '${tagsStr}', this)">
                            <i class="fas fa-circle text-[6px] text-slate-300"></i>
                            ${unit.name}
                        </div>`;
                });

                const html = `
                    <details ${detailsOpen} class="group">
                        <summary class="flex items-center justify-between p-3 font-bold text-slate-700 cursor-pointer hover:bg-slate-100 rounded-lg list-none">
                            <span>${book.book}</span>
                            <i class="fas fa-chevron-down text-xs text-slate-400 transition-transform group-open:rotate-180"></i>
                        </summary>
                        <div class="pl-2 mt-1 space-y-1 border-l-2 border-slate-100 ml-3">
                            ${unitsHtml}
                        </div>
                    </details>
                `;
                menu.insertAdjacentHTML('beforeend', html);
            });
        }

        // 3. æ ¸å¿ƒï¼šæ ¹æ“šå–®å…ƒæ¨™ç±¤ç”Ÿæˆé‡é»å…§å®¹
        function loadUnitContent(unitName, tagsStr, el) {
            document.querySelectorAll('.unit-item').forEach(i => i.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'font-bold'));
            el.classList.add('active', 'bg-blue-50', 'text-blue-600', 'font-bold');
            
            document.getElementById('currentUnitTitle').textContent = unitName;
            document.getElementById('currentUnitSub').textContent = `ç§‘ç›®ï¼š${currentSubject} | ä¾†æºï¼šæ™ºæ…§é¡Œåº«`;

            const tags = JSON.parse(decodeURIComponent(tagsStr));
            const container = document.getElementById('notesContainer');
            
            container.innerHTML = '<div class="text-center py-10 text-gray-400"><i class="fas fa-spinner fa-spin"></i> AI æ­£åœ¨æ•´ç†é‡é»...</div>';

            setTimeout(() => {
                let questions = [];
                if (window.generatePaper) {
                    // å¦‚æœæ˜¯ç†åŒ–ï¼Œæ¨™ç±¤å¯èƒ½éœ€è¦åˆä½µè™•ç†ï¼Œä½†é€™è£¡å…ˆå‚³åŸå§‹tags
                    questions = window.generatePaper({ subject: currentSubject, total: 6, tags: tags });
                }

                if (!questions || questions.length === 0) {
                    container.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-100 p-8 rounded-xl text-center">
                            <i class="fas fa-exclamation-circle text-yellow-500 text-3xl mb-3"></i>
                            <p class="text-yellow-700 font-bold">æœ¬å–®å…ƒç›®å‰å°šç„¡é‡é»è³‡æ–™</p>
                            <p class="text-xs text-yellow-600 mt-1">AI é¡Œåº«æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>
                        </div>`;
                    return;
                }

                let contentHtml = '';
                questions.forEach((q, idx) => {
                    const concept = q.concept || unitName.split(' ')[0] || 'æ ¸å¿ƒè§€å¿µ';
                    const explain = (q.explanation && q.explanation.length > 0) ? q.explanation.join('<br>') : "è§€å¿µæ‡‰ç”¨é¡Œ";
                    
                    // Logic to add a relevant diagram if it's a science subject
                    let imageTag = '';
                    if (['physics', 'chemistry', 'biology', 'earth'].includes(currentSubject)) {
                        imageTag = `<div class="mb-4 text-center"></div>`;
                    }

                    contentHtml += `
                        <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm fade-in hover:shadow-md transition" style="animation-delay: ${idx * 0.1}s">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="bg-indigo-50 text-indigo-600 text-xs font-bold px-2 py-1 rounded">é‡é» ${idx + 1}</span>
                                <span class="text-sm font-bold text-slate-700">${concept}</span>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-1">Example</div>
                                <div class="text-slate-800 font-medium text-lg leading-relaxed">
                                    ${q.question.replace(/\n/g, '<br>')}
                                </div>
                            </div>

                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <div class="flex gap-3">
                                    <div class="mt-0.5"><i class="fas fa-lightbulb text-yellow-500"></i></div>
                                    <div class="w-full">
                                        <div class="text-xs font-bold text-slate-500 mb-1">è§€å¿µè§£æ</div>
                                        ${imageTag}
                                        <div class="text-sm text-slate-600 leading-relaxed">
                                            ${explain}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = contentHtml;
                if(window.MathJax) MathJax.typesetPromise();

            }, 300);
        }
    </script>
</body>
</html>
