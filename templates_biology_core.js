(function(global){
    'use strict';
    const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
    if (!G) return;
    const { pick, shuffle } = G.utils;

    // ==========================================
    // 自然科全方位資料庫 (Nature Science Database)
    // 規模：400+ 筆核心觀念
    // ==========================================
    const natureDB = [
        // ==========================================
        // 1. 生物 (Biology)
        // ==========================================
        // [國七] 細胞與生物體
        { s:"生物", t:["國七","細胞"], q: "細胞的發電廠，產生能量(ATP)", a: "粒線體" },
        { s:"生物", t:["國七","細胞"], q: "植物細胞進行光合作用的場所", a: "葉綠體" },
        { s:"生物", t:["國七","細胞"], q: "細胞的生命中樞，內含遺傳物質", a: "細胞核" },
        { s:"生物", t:["國七","細胞"], q: "植物細胞外層，提供支持與保護", a: "細胞壁" },
        { s:"生物", t:["國七","細胞"], q: "暫存水分、廢物與養分", a: "液泡" },
        { s:"生物", t:["國七","細胞"], q: "控制物質進出細胞的構造", a: "細胞膜" },
        { s:"生物", t:["國七","運輸"], q: "水分子通過半透膜的現象", a: "滲透作用" },
        { s:"生物", t:["國七","運輸"], q: "分子由高濃度往低濃度移動", a: "擴散作用" },
        { s:"生物", t:["國七","運輸"], q: "植物體內運送水分的構造", a: "木質部" },
        { s:"生物", t:["國七","運輸"], q: "植物體內運送養分(糖)的構造", a: "韌皮部" },
        { s:"生物", t:["國七","運輸"], q: "葉片散失水分的主要動力", a: "蒸散作用" },
        
        // [國七] 人體生理
        { s:"生物", t:["國七","消化"], q: "分泌膽汁的器官", a: "肝臟" },
        { s:"生物", t:["國七","消化"], q: "吸收養分與水分的主要場所", a: "小腸" },
        { s:"生物", t:["國七","消化"], q: "吸收水分與形成糞便", a: "大腸" },
        { s:"生物", t:["國七","消化"], q: "胃液中的酸性物質", a: "鹽酸" },
        { s:"生物", t:["國七","消化"], q: "唾液澱粉酶可分解", a: "澱粉" },
        { s:"生物", t:["國七","循環"], q: "將血液帶離心臟的血管", a: "動脈" },
        { s:"生物", t:["國七","循環"], q: "將血液帶回心臟的血管", a: "靜脈" },
        { s:"生物", t:["國七","循環"], q: "物質交換的場所，管壁最薄", a: "微血管" },
        { s:"生物", t:["國七","循環"], q: "攜帶氧氣的血球", a: "紅血球" },
        { s:"生物", t:["國七","循環"], q: "負責防禦與免疫的血球", a: "白血球" },
        { s:"生物", t:["國七","循環"], q: "負責血液凝固的血球", a: "血小板" },
        { s:"生物", t:["國七","循環"], q: "心臟中含充氧血的腔室", a: "左心房與左心室" },
        { s:"生物", t:["國七","呼吸"], q: "控制呼吸運動的氣體", a: "二氧化碳" },
        { s:"生物", t:["國七","呼吸"], q: "呼吸運動的中樞", a: "腦幹" },
        { s:"生物", t:["國七","神經"], q: "人體意識與感覺的中樞", a: "大腦" },
        { s:"生物", t:["國七","神經"], q: "協調肌肉與身體平衡", a: "小腦" },
        { s:"生物", t:["國七","神經"], q: "反射動作的中樞(如膝跳)", a: "脊髓" },
        { s:"生物", t:["國七","內分泌"], q: "血糖過高時分泌", a: "胰島素" },
        { s:"生物", t:["國七","內分泌"], q: "血糖過低時分泌", a: "升糖素" },
        { s:"生物", t:["國七","內分泌"], q: "應付緊急狀況(戰或逃)", a: "腎上腺素" },
        { s:"生物", t:["國七","恆定"], q: "人體主要的排泄器官(尿素)", a: "腎臟" },
        { s:"生物", t:["國七","恆定"], q: "皮膚調節體溫的方式", a: "流汗與血管擴張" },

        // [國八] 生殖與遺傳
        { s:"生物", t:["國七","生殖"], q: "產生精子的器官", a: "睪丸" },
        { s:"生物", t:["國七","生殖"], q: "產生卵子的器官", a: "卵巢" },
        { s:"生物", t:["國七","生殖"], q: "胎兒發育的場所", a: "子宮" },
        { s:"生物", t:["國七","生殖"], q: "酵母菌的無性生殖方式", a: "出芽生殖" },
        { s:"生物", t:["國七","生殖"], q: "變形蟲的無性生殖方式", a: "分裂生殖" },
        { s:"生物", t:["國七","生殖"], q: "草莓/馬鈴薯的生殖方式", a: "營養器官繁殖" },
        { s:"生物", t:["國七","遺傳"], q: "遺傳學之父", a: "孟德爾" },
        { s:"生物", t:["國七","遺傳"], q: "控制性狀的特徵因子", a: "基因" },
        { s:"生物", t:["國七","遺傳"], q: "人類體細胞的染色體數目", a: "46條 (23對)" },
        { s:"生物", t:["國七","遺傳"], q: "人類精子/卵子的染色體數", a: "23條" },
        { s:"生物", t:["國七","遺傳"], q: "決定性別的染色體", a: "第23對 (性染色體)" },
        { s:"生物", t:["國七","演化"], q: "天擇說的提出者", a: "達爾文" },
        { s:"生物", t:["國七","演化"], q: "演化的最直接證據", a: "化石" },
        { s:"生物", t:["國七","演化"], q: "同源器官", a: "來源相同，功能可能不同" },
        { s:"生物", t:["國七","分類"], q: "生物分類的最高階層", a: "界" },
        { s:"生物", t:["國七","分類"], q: "生物學名的組成", a: "屬名 + 種小名" },
        { s:"生物", t:["國七","分類"], q: "藍綠菌屬於", a: "原核生物界" },
        { s:"生物", t:["國七","分類"], q: "黴菌/酵母菌屬於", a: "真菌界" },

        // [國八] 生態
        { s:"生物", t:["國七","生態"], q: "能量流動的方向", a: "單向流動" },
        { s:"生物", t:["國七","生態"], q: "物質循環的特性", a: "循環利用" },
        { s:"生物", t:["國七","生態"], q: "生產者", a: "綠色植物、藻類" },
        { s:"生物", t:["國七","生態"], q: "分解者", a: "細菌、真菌" },
        { s:"生物", t:["國七","生態"], q: "生物放大作用", a: "毒素在高級消費者累積" },
        // [高中] 進階生物
        { s:"生物", t:["高一","細胞"], q: "細胞膜的主要成分", a: "磷脂質與蛋白質" },
        { s:"生物", t:["高一","細胞"], q: "原核細胞與真核細胞的區別", a: "有無核膜" },
        { s:"生物", t:["高一","代謝"], q: "能量貨幣", a: "ATP (三磷酸腺苷)" },
        { s:"生物", t:["高一","代謝"], q: "酵素的主要成分", a: "蛋白質" },
        { s:"生物", t:["高一","遺傳"], q: "DNA 的中文名稱", a: "去氧核糖核酸" },
        { s:"生物", t:["高一","遺傳"], q: "RNA 的中文名稱", a: "核糖核酸" },
        { s:"生物", t:["高一","遺傳"], q: "DNA 的鹼基配對", a: "A-T, C-G" },
        { s:"生物", t:["高一","遺傳"], q: "中心法則", a: "DNA -> RNA -> 蛋白質" },
        { s:"生物", t:["高二","生理"], q: "神經元傳導方向", a: "樹突 -> 本體 -> 軸突" },
        { s:"生物", t:["高二","生理"], q: "特異性免疫的主角", a: "淋巴球 (B細胞/T細胞)" },
        { s:"生物", t:["高二","生態"], q: "族群成長曲線(S型)的上限", a: "負荷量 (K值)" },

        // ==========================================
        // 2. 地球科學 (Earth Science)
        // ==========================================
        // [國九] 天文
        { s:"地科", t:["國九","天文"], q: "地球自轉造成的現象", a: "晝夜交替" },
        { s:"地科", t:["國九","天文"], q: "地球公轉造成的現象", a: "四季變化" },
        { s:"地科", t:["國九","天文"], q: "太陽系最大的行星", a: "木星" },
        { s:"地科", t:["國九","天文"], q: "類地行星特徵", a: "體積小、密度大、岩石組成" },
        { s:"地科", t:["國九","天文"], q: "類木行星特徵", a: "體積大、密度小、氣體組成" },
        { s:"地科", t:["國九","天文"], q: "月相變化的週期", a: "約 29.5 天 (朔望月)" },
        { s:"地科", t:["國九","天文"], q: "日食發生的農曆日期", a: "朔 (初一)" },
        { s:"地科", t:["國九","天文"], q: "月食發生的農曆日期", a: "望 (十五)" },
        { s:"地科", t:["國九","天文"], q: "織女星屬於", a: "恆星" },
        { s:"地科", t:["國九","天文"], q: "光年是單位的", a: "距離" },

        // [國九] 地質
        { s:"地科", t:["國九","地質"], q: "板塊構造運動的動力來源", a: "地函熱對流" },
        { s:"地科", t:["國九","地質"], q: "台灣位於哪兩板塊交界", a: "歐亞板塊與菲律賓海板塊" },
        { s:"地科", t:["國九","地質"], q: "聚合性板塊邊界特徵", a: "海溝、火山、造山運動" },
        { s:"地科", t:["國九","地質"], q: "張裂性板塊邊界特徵", a: "中洋脊、裂谷" },
        { s:"地科", t:["國九","地質"], q: "花岡岩屬於", a: "火成岩" },
        { s:"地科", t:["國九","地質"], q: "大理岩屬於", a: "變質岩" },
        { s:"地科", t:["國九","地質"], q: "石灰岩屬於", a: "沈積岩" },
        { s:"地科", t:["國九","地質"], q: "地震規模的定義", a: "釋放能量的多寡" },
        { s:"地科", t:["國九","地質"], q: "地震震度的定義", a: "地面搖晃的程度" },

        // [國九] 大氣與海洋
        { s:"地科", t:["國九","大氣"], q: "天氣現象發生的那一層", a: "對流層" },
        { s:"地科", t:["國九","大氣"], q: "臭氧層所在位置", a: "平流層" },
        { s:"地科", t:["國九","大氣"], q: "大氣中含量最多的氣體", a: "氮氣" },
        { s:"地科", t:["國九","大氣"], q: "造成溫室效應的主要氣體", a: "二氧化碳、甲烷、水氣" },
        { s:"地科", t:["國九","大氣"], q: "高氣壓中心的氣流", a: "下沉、順時針旋轉(北半球)" },
        { s:"地科", t:["國九","大氣"], q: "低氣壓中心的氣流", a: "上升、逆時針旋轉(北半球)" },
        { s:"地科", t:["國九","大氣"], q: "冷鋒通過時的天氣", a: "氣溫下降、降雨" },
        { s:"地科", t:["國九","海洋"], q: "造成潮汐的主因", a: "月球與太陽的引力" },
        { s:"地科", t:["國九","海洋"], q: "黑潮是", a: "暖流" },

        // [高中] 進階地科
        { s:"地科", t:["高一","天文"], q: "宇宙背景輻射證明了", a: "大霹靂理論" },
        { s:"地科", t:["高一","天文"], q: "哈伯定律描述", a: "宇宙正在膨脹" },
        { s:"地科", t:["高一","天文"], q: "星等數值越小", a: "亮度越亮" },
        { s:"地科", t:["高一","地質"], q: "絕對地質年代測定", a: "放射性元素定年法" },
        { s:"地科", t:["高一","氣候"], q: "聖嬰現象特徵", a: "東太平洋海水異常增溫" },
        { s:"地科", t:["高一","氣候"], q: "科氏力在北半球", a: "向右偏轉" },
        { s:"地科", t:["高一","海洋"], q: "溫鹽環流的驅動力", a: "密度差異(溫度與鹽度)" },

        // ==========================================
        // 3. 物理 (Physics)
        // ==========================================
        // [國八] 力學與測量
        { s:"物理", t:["國八","測量"], q: "國際單位制(SI)長度單位", a: "公尺 (m)" },
        { s:"物理", t:["國八","測量"], q: "國際單位制(SI)質量單位", a: "公斤 (kg)" },
        { s:"物理", t:["國八","測量"], q: "密度的定義", a: "質量除以體積 (D=M/V)" },
        { s:"物理", t:["國八","力學"], q: "力的單位(SI)", a: "牛頓 (N)" },
        { s:"物理", t:["國八","力學"], q: "虎克定律", a: "彈簧伸長量與受力成正比" },
        { s:"物理", t:["國八","力學"], q: "摩擦力的方向", a: "與運動方向相反" },
        { s:"物理", t:["國八","力學"], q: "阿基米德原理", a: "浮力等於排開液重" },
        { s:"物理", t:["國八","力學"], q: "壓力的定義", a: "單位面積所受的力 (P=F/A)" },

        // [國八] 熱、波、光
        { s:"物理", t:["國八","熱"], q: "溫度的微觀意義", a: "分子的平均動能" },
        { s:"物理", t:["國八","熱"], q: "比熱大的物質", a: "難熱難冷" },
        { s:"物理", t:["國八","熱"], q: "熱傳導", a: "固體的主要傳熱方式" },
        { s:"物理", t:["國八","熱"], q: "熱對流", a: "流體的主要傳熱方式" },
        { s:"物理", t:["國八","熱"], q: "熱輻射", a: "不需介質的傳熱方式" },
        { s:"物理", t:["國八","波動"], q: "聲波屬於", a: "縱波 (力學波)" },
        { s:"物理", t:["國八","波動"], q: "光波屬於", a: "橫波 (電磁波)" },
        { s:"物理", t:["國八","波動"], q: "聲音的三要素", a: "響度、音調、音色" },
        { s:"物理", t:["國八","波動"], q: "音調決定於", a: "頻率" },
        { s:"物理", t:["國八","波動"], q: "響度決定於", a: "振幅" },
        { s:"物理", t:["國八","光"], q: "光的三原色", a: "紅、綠、藍" },
        { s:"物理", t:["國八","光"], q: "平面鏡成像性質", a: "正立、相等、虛像" },
        { s:"物理", t:["國八","光"], q: "凸透鏡成像", a: "可聚光，可成實像或虛像" },
        { s:"物理", t:["國八","光"], q: "近視眼矯正", a: "凹透鏡" },

        // [國九] 運動與電磁
        { s:"物理", t:["國九","運動"], q: "位移", a: "起點到終點的直線距離與方向" },
        { s:"物理", t:["國九","運動"], q: "速度", a: "位移除以時間 (具方向性)" },
        { s:"物理", t:["國九","運動"], q: "加速度", a: "單位時間內速度的變化量" },
        { s:"物理", t:["國九","運動"], q: "牛頓第一運動定律", a: "慣性定律" },
        { s:"物理", t:["國九","運動"], q: "牛頓第二運動定律", a: "F = ma" },
        { s:"物理", t:["國九","運動"], q: "牛頓第三運動定律", a: "作用力與反作用力" },
        { s:"物理", t:["國九","能量"], q: "動能公式", a: "1/2 mv²" },
        { s:"物理", t:["國九","能量"], q: "重力位能公式", a: "mgh" },
        { s:"物理", t:["國九","能量"], q: "功率的定義", a: "單位時間內所作的功" },
        { s:"物理", t:["國九","電學"], q: "歐姆定律", a: "V = IR" },
        { s:"物理", t:["國九","電學"], q: "串聯電路", a: "電流相同，電壓相加" },
        { s:"物理", t:["國九","電學"], q: "並聯電路", a: "電壓相同，電流相加" },
        { s:"物理", t:["國九","電學"], q: "伏特計連接方式", a: "並聯" },
        { s:"物理", t:["國九","電學"], q: "安培計連接方式", a: "串聯" },
        { s:"物理", t:["國九","磁學"], q: "安培右手定則", a: "判斷電流產生的磁場方向" },
        { s:"物理", t:["國九","磁學"], q: "法拉第定律", a: "磁場變化產生感應電流" },

        // [高中] 進階物理
        { s:"物理", t:["高一","運動"], q: "斜向拋射", a: "水平等速，鉛直等加" },
        { s:"物理", t:["高一","力學"], q: "動量守恆條件", a: "系統不受外力" },
        { s:"物理", t:["高一","引力"], q: "萬有引力定律", a: "F = GMm/r²" },
        { s:"物理", t:["高一","引力"], q: "克卜勒第一定律", a: "行星軌道為橢圓" },
        { s:"物理", t:["高二","光學"], q: "干涉現象證明光具有", a: "波動性" },
        { s:"物理", t:["高二","近代"], q: "光電效應證明光具有", a: "粒子性" },
        { s:"物理", t:["高二","近代"], q: "波粒二象性", a: "光與物質同時具有波動與粒子性質" },

        // ==========================================
        // 4. 化學 (Chemistry)
        // ==========================================
        // [國八] 物質與反應
        { s:"化學", t:["國八","物質"], q: "空氣中含量最多的氣體", a: "氮氣" },
        { s:"化學", t:["國八","物質"], q: "惰性氣體 (鈍氣)", a: "氦、氖、氬" },
        { s:"化學", t:["國八","物質"], q: "純物質", a: "有固定的組成與性質" },
        { s:"化學", t:["國八","物質"], q: "混合物", a: "無固定的熔點與沸點" },
        { s:"化學", t:["國八","原子"], q: "道耳頓原子說", a: "原子不可分割 (後被修正)" },
        { s:"化學", t:["國八","原子"], q: "原子核內帶正電粒子", a: "質子" },
        { s:"化學", t:["國八","原子"], q: "原子核內不帶電粒子", a: "中子" },
        { s:"化學", t:["國八","原子"], q: "繞核旋轉帶負電粒子", a: "電子" },
        { s:"化學", t:["國八","原子"], q: "質量數", a: "質子數 + 中子數" },
        { s:"化學", t:["國八","原子"], q: "原子序", a: "質子數" },
        { s:"化學", t:["國八","週期表"], q: "週期表縱行稱為", a: "族 (化學性質相似)" },
        { s:"化學", t:["國八","週期表"], q: "週期表橫列稱為", a: "週期" },
        { s:"化學", t:["國八","反應"], q: "質量守恆定律", a: "反應前後總質量不變" },
        { s:"化學", t:["國八","反應"], q: "莫耳 (Mole)", a: "6 x 10²³ 個粒子" },
        { s:"化學", t:["國八","反應"], q: "吸熱反應", a: "周圍溫度下降" },
        { s:"化學", t:["國八","反應"], q: "放熱反應", a: "周圍溫度上升" },

        // [國九] 電解質與酸鹼
        { s:"化學", t:["國九","電解質"], q: "電解質定義", a: "溶於水能導電的化合物" },
        { s:"化學", t:["國九","酸鹼"], q: "酸的定義 (阿瑞尼士)", a: "溶於水產生氫離子(H+)" },
        { s:"化學", t:["國九","酸鹼"], q: "鹼的定義 (阿瑞尼士)", a: "溶於水產生氫氧根離子(OH-)" },
        { s:"化學", t:["國九","酸鹼"], q: "pH值小於7", a: "酸性" },
        { s:"化學", t:["國九","酸鹼"], q: "pH值大於7", a: "鹼性" },
        { s:"化學", t:["國九","酸鹼"], q: "酸鹼中和產物", a: "鹽 + 水 (+熱)" },
        { s:"化學", t:["國九","氧化"], q: "氧化反應", a: "物質與氧結合 (失去電子)" },
        { s:"化學", t:["國九","氧化"], q: "還原反應", a: "失去氧 (得到電子)" },
        { s:"化學", t:["國九","氧化"], q: "抗氧化劑", a: "自身發生氧化，保護其他物質" },
        { s:"化學", t:["國九","有機"], q: "有機化合物", a: "含碳的化合物 (除CO, CO2, 碳酸鹽等)" },
        { s:"化學", t:["國九","有機"], q: "烴類", a: "只含碳、氫的有機物" },
        { s:"化學", t:["國九","有機"], q: "天然氣主要成分", a: "甲烷 (CH4)" },
        { s:"化學", t:["國九","有機"], q: "液化石油氣(桶裝瓦斯)", a: "丙烷、丁烷" },
        { s:"化學", t:["國九","有機"], q: "發酵法製酒", a: "醣類分解為酒精與二氧化碳" },
        { s:"化學", t:["國九","有機"], q: "皂化反應", a: "油脂 + 鹼 -> 肥皂 + 甘油" },

        // [高中] 進階化學
        { s:"化學", t:["高一","鍵結"], q: "離子鍵", a: "金屬與非金屬間的靜電吸引力" },
        { s:"化學", t:["高一","鍵結"], q: "共價鍵", a: "非金屬間共用電子對" },
        { s:"化學", t:["高一","鍵結"], q: "金屬鍵", a: "電子海與金屬陽離子" },
        { s:"化學", t:["高一","計量"], q: "限量試劑", a: "反應中先被耗盡的反應物" },
        { s:"化學", t:["高二","氣體"], q: "理想氣體方程式", a: "PV = nRT" },
        { s:"化學", t:["高二","氣體"], q: "波以耳定律", a: "定溫下，PV = 定值" },
        { s:"化學", t:["高二","氣體"], q: "查理定律", a: "定壓下，V/T = 定值" },
        { s:"化學", t:["高二","反應"], q: "反應速率影響因素", a: "本性、濃度、溫度、催化劑、表面積" },
        { s:"化學", t:["高二","平衡"], q: "勒沙特列原理", a: "平衡移動以抵銷外加因素" },
        { s:"化學", t:["高二","酸鹼"], q: "緩衝溶液", a: "能抵抗pH值劇烈變化的溶液" }
    ];

    // ==========================================
    // 註冊模板 (分科註冊，避免混雜)
    // ==========================================
    // ==========================================
    // 註冊模板 (分科處理 + 自然語氣)
    // ==========================================
    const subjects = [
        { name: "生物", code: "bio" },
        { name: "地科", code: "ear" },
        { name: "物理", code: "phy" },
        { name: "化學", code: "chm" }
    ];

    subjects.forEach(subj => {
        // 1. 篩選科目資料
        const subData = natureDB.filter(item => item.s === subj.name);
        if (subData.length === 0) return;

        // 模板 A: 正向題 (描述 -> 名詞)
        G.registerTemplate(`${subj.code}_concept`, (ctx, rnd) => {
            const item = pick(subData);
            
            // 誘答：優先找同科目的錯誤選項
            const wrong = shuffle(subData.filter(x => x.a !== item.a)).slice(0, 3).map(x => x.a);
            // 補足選項
            while(wrong.length < 3) {
                const backup = pick(natureDB).a;
                if(backup !== item.a && !wrong.includes(backup)) wrong.push(backup);
            }

            const opts = shuffle([item.a, ...wrong]);

            return {
                question: `【${item.t[1]}】${item.q}，請問是指下列何者？`,
                options: opts,
                answer: opts.indexOf(item.a),
                concept: item.t[1],
                explanation: [`正確答案是：${item.a}`, `因為 ${item.a} 是 ${item.q.replace('，','，是')}。`]
            };
        }, [subj.name, "自然", "觀念"]);
        
        // 模板 B: 反向題 (名詞 -> 描述)
        G.registerTemplate(`${subj.code}_reverse`, (ctx, rnd) => {
            const item = pick(subData);
            // 找出正確描述的一部分作為選項 (簡化版)
            // 這裡我們直接用原本的題目(描述)當作正確選項，但要小心長度
            // 為了版面好看，我們反過來：題目是名詞，選項是描述
            
            const correctDesc = item.q;
            const wrongDescs = shuffle(subData.filter(x => x.q !== item.q)).slice(0, 3).map(x => x.q);
            const opts = shuffle([correctDesc, ...wrongDescs]);

            return {
                question: `【${item.t[1]}】關於「${item.a}」的敘述，下列何者正確？`,
                options: opts,
                answer: opts.indexOf(correctDesc),
                concept: item.t[1],
                explanation: [`${item.a} 的特徵是：${item.q}`]
            };
        }, [subj.name, "自然", "觀念"]);
    });

})(this);