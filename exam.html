<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>智慧評量系統</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="assets/js/auth.js"></script>
<script src="mockdata/paper_generator.js"></script>

<style>
.option { border:2px solid #e5e7eb; padding:1rem; border-radius:0.75rem; cursor:pointer }
.option.selected { border-color:#2563eb; background:#eff6ff }
.qbtn { width:36px; height:36px; border-radius:999px; border:1px solid #cbd5e1 }
.qbtn.active { background:#2563eb; color:white }
.qbtn.answered { background:#e5e7eb }
</style>
</head>

<body class="bg-gray-100 h-screen flex flex-col">

<header class="bg-white shadow px-6 py-3 flex justify-between items-center">
  <h1 id="examTitle" class="font-bold text-lg">載入中</h1>
  <div class="flex gap-4 items-center">
    <span id="timer" class="font-mono text-red-600">00:00</span>
    <button onclick="finishExam()" class="bg-orange-500 text-white px-4 py-2 rounded">
      交卷
    </button>
  </div>
</header>

<main class="flex flex-1 overflow-hidden">

<aside class="w-60 bg-white p-4 border-r hidden md:block">
  <div id="palette" class="grid grid-cols-5 gap-2"></div>
</aside>

<section class="flex-1 p-6 overflow-y-auto">
  <div class="bg-white p-6 rounded-xl shadow">

    <div class="flex justify-between mb-4">
      <span id="qNum"></span>
      <span id="concept" class="text-sm text-purple-600"></span>
    </div>

    <div id="question" class="text-xl font-bold mb-6"></div>
    <div id="options" class="space-y-3"></div>

    <div class="flex justify-between mt-6">
      <button id="prevBtn" class="px-4 py-2">上一題</button>
      <button id="nextBtn" class="px-4 py-2">下一題</button>
    </div>

  </div>
</section>

</main>

<script>
/* ================== 基本狀態 ================== */
const AUTOSAVE_KEY = 'exam_autosave';
const TAB_KEY = 'exam_tab';

const TAB_ID = Date.now() + '_' + Math.random();

let questions = [];
let answers = [];
let current = 0;
let timeLeft = 0;
let timer;
let enterTime = Date.now();
let timeLog = [];
let tabLog = [];

/* ================== 防多分頁 ================== */
localStorage.setItem(TAB_KEY, TAB_ID);
window.addEventListener('storage', e => {
  if (e.key === TAB_KEY && e.newValue !== TAB_ID) {
    alert('偵測到多分頁，考試結束');
    finishExam();
  }
});

/* ================== 初始化 ================== */
window.onload = () => {
  if (!Auth.requireLogin()) return;

  const params = new URLSearchParams(location.search);
  const subject = params.get('subject') || 'math';
  const count = parseInt(params.get('count')) || 10;

  questions = generatePaper({ subject, total: count });
  answers = new Array(questions.length).fill(null);
  timeLeft = count * 60;

  document.getElementById('examTitle').textContent = subject.toUpperCase();
  renderPalette();
  render();
  startTimer();
};

/* ================== Render ================== */
function render() {
  enterTime = Date.now();
  const q = questions[current];

  document.getElementById('qNum').textContent =
    `Q${current + 1} / ${questions.length}`;
  document.getElementById('question').innerHTML =
    q.question.replace(/\n/g,'<br>');
  document.getElementById('concept').textContent = q.concept || '';

  const opts = document.getElementById('options');
  opts.innerHTML = '';

  q.options.forEach((o,i)=>{
    const d = document.createElement('div');
    d.className = 'option' + (answers[current]===i?' selected':'');
    d.innerHTML = o;
    d.onclick = ()=>{
      answers[current]=i;
      recordTime();
      autoSave();
      render();
      updatePalette();
    };
    opts.appendChild(d);
  });

  MathJax?.typeset();
  updateNav();
}

/* ================== Palette ================== */
function renderPalette(){
  const p=document.getElementById('palette');
  p.innerHTML='';
  questions.forEach((_,i)=>{
    const b=document.createElement('button');
    b.textContent=i+1;
    b.className='qbtn';
    b.onclick=()=>{recordTime();current=i;render()};
    p.appendChild(b);
  });
  updatePalette();
}

function updatePalette(){
  questions.forEach((_,i)=>{
    const b=document.querySelectorAll('.qbtn')[i];
    b.className='qbtn';
    if(answers[i]!=null) b.classList.add('answered');
    if(i===current) b.classList.add('active');
  });
}

/* ================== Navigation ================== */
function updateNav(){
  prevBtn.onclick=()=>{ if(current>0){recordTime();current--;render()} };
  nextBtn.onclick=()=>{
    recordTime();
    if(current===questions.length-1) finishExam();
    else { current++; render(); }
  };
  nextBtn.textContent = current===questions.length-1?'交卷':'下一題';
}

/* ================== Timer ================== */
function startTimer(){
  timer=setInterval(()=>{
    timeLeft--;
    timerEl.textContent =
      String(Math.floor(timeLeft/60)).padStart(2,'0')+':' +
      String(timeLeft%60).padStart(2,'0');
    if(timeLeft<=0) finishExam();
  },1000);
}

/* ================== 防作弊 ================== */
function recordTime(){
  const s=Math.floor((Date.now()-enterTime)/1000);
  timeLog[current]={ seconds:s, flag:s<2 };
  enterTime=Date.now();
}

document.addEventListener('visibilitychange',()=>{
  if(document.hidden) tabLeave=Date.now();
  else if(tabLeave){
    tabLog.push((Date.now()-tabLeave)/1000);
    tabLeave=null;
  }
});

/* ================== Finish ================== */
function finishExam(){
  recordTime();
  clearInterval(timer);

  const record={
    score: answers.filter((a,i)=>a===questions[i].answer).length,
    timeLog,
    tabLog
  };

  localStorage.setItem('examResult',JSON.stringify(record));
  location.href='analysis.html';
}

function autoSave(){
  localStorage.setItem(AUTOSAVE_KEY,
    JSON.stringify({answers,current,timeLeft}));
}
</script>
</body>
</html>
