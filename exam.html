<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>智慧評量系統 - 翰林雲端學院</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f4f6f8 }
.option-card{border:2px solid #e5e7eb}
.option-card.selected{border-color:#2563eb;background:#eff6ff}
.q-nav-btn{width:36px;height:36px;border-radius:50%;border:1px solid #cbd5e1}
.q-nav-btn.active{background:#2563eb;color:#fff}
.q-nav-btn.answered{background:#e5e7eb}
</style>

<!-- 你原本的 JS，全數保留 -->
<script src="mockdata/users.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/generator_engine.js"></script>
<script src="mockdata/AutoTemplateFissionFactory.js"></script>
<script src="mockdata/auto_fission_bootstrap.js"></script>
<script src="mockdata/paper_generator.js"></script>
<script src="mockdata/curriculum_integrated.js"></script>

<script src="mockdata/templates_math_algebra_geometry.js"></script>
<script src="mockdata/templates_physics_multistep.js"></script>
<script src="mockdata/templates_chemistry_core.js"></script>
<script src="mockdata/templates_biology_core.js"></script>
<script src="mockdata/templates_english_core.js"></script>
<script src="mockdata/templates_chinese_core.js"></script>
<script src="mockdata/templates_history_core.js"></script>
</head>

<body class="h-screen flex flex-col">

<header class="h-16 bg-white shadow flex items-center justify-between px-6">
  <div class="font-bold">雲端學院</div>
  <div class="flex items-center gap-4">
    <span id="timer" class="font-mono text-red-600">00:00</span>
    <button id="submitBtnTop" class="bg-orange-500 text-white px-4 py-2 rounded">交卷</button>
  </div>
</header>

<main class="flex flex-1">
  <aside class="w-64 bg-white border-r hidden lg:block">
    <div id="questionPalette" class="grid grid-cols-5 gap-2 p-4"></div>
  </aside>

  <section class="flex-1 flex justify-center p-6">
    <div class="bg-white w-full max-w-3xl rounded p-6">
      <div class="flex justify-between mb-4">
        <div id="conceptBadge" class="text-sm font-bold"></div>
        <div>Q.<span id="currentQNum">1</span>/<span id="totalQNum">--</span></div>
      </div>
      <h2 id="questionText" class="text-xl font-bold mb-6"></h2>
      <div id="optionsContainer" class="space-y-3"></div>
      <div class="flex justify-between mt-6">
        <button id="prevBtn">← 上一題</button>
        <button id="nextBtn">下一題 →</button>
      </div>
    </div>
  </section>
</main>

<script>
let mockQuestions=[],userAnswers=[],currentQIndex=0;
let timeLeft=0,timerInterval,examFinished=false;

const els={
qText:questionText,opts:optionsContainer,curr:currentQNum,total:totalQNum,
prev:prevBtn,next:nextBtn,palette:questionPalette,timer,submit:submitBtnTop,badge:conceptBadge
};

window.onload=()=>{
if(!Auth.requireLogin())return;
setTimeout(initExam,200);
};

function initExam(){
const p=new URLSearchParams(location.search);
const subject=p.get('subject')||'math';
const count=parseInt(p.get('count'))||10;

mockQuestions=generatePaper({subject,total:count,tags:[]});
if(!mockQuestions||!mockQuestions.length)return alert("題庫載入失敗");

userAnswers=new Array(mockQuestions.length).fill(null);
els.total.textContent=mockQuestions.length;
renderPalette();
renderQuestion();
startTimer();
}

function renderQuestion(){
const q=mockQuestions[currentQIndex];
els.curr.textContent=currentQIndex+1;
els.qText.innerHTML=q.question;
els.badge.textContent=q.concept||'綜合';

els.opts.innerHTML='';
q.options.forEach((opt,i)=>{
const b=document.createElement('button');
b.className='option-card p-3 rounded w-full '+(userAnswers[currentQIndex]===i?'selected':'');
b.textContent=String.fromCharCode(65+i)+'. '+opt;
b.onclick=()=>{userAnswers[currentQIndex]=i;renderQuestion();updatePalette();}
els.opts.appendChild(b);
});

updateNav();
if(window.MathJax)MathJax.typesetPromise();
}

function renderPalette(){
els.palette.innerHTML='';
mockQuestions.forEach((_,i)=>{
const b=document.createElement('button');
b.textContent=i+1;
b.className='q-nav-btn '+(i===0?'active':'');
b.onclick=()=>{currentQIndex=i;renderQuestion()};
els.palette.appendChild(b);
});
}

function updatePalette(){
[...els.palette.children].forEach((b,i)=>{
b.className='q-nav-btn';
if(userAnswers[i]!=null)b.classList.add('answered');
if(i===currentQIndex)b.classList.add('active');
});
}

function updateNav(){
els.prev.disabled=currentQIndex===0;
els.prev.onclick=()=>{if(currentQIndex>0){currentQIndex--;renderQuestion()}};
if(currentQIndex===mockQuestions.length-1){
els.next.textContent='交卷';
els.next.onclick=finishExam;
}else{
els.next.textContent='下一題 →';
els.next.onclick=()=>{currentQIndex++;renderQuestion()};
}
}

function startTimer(){
timeLeft=mockQuestions.length*60;
timerInterval=setInterval(()=>{
timeLeft--;
els.timer.textContent=
String(Math.floor(timeLeft/60)).padStart(2,'0')+':' +
String(timeLeft%60).padStart(2,'0');
if(timeLeft<=0)finishExam();
},1000);
}

function finishExam(){
if(examFinished)return;
examFinished=true;
clearInterval(timerInterval);
alert("交卷完成（結果頁你原本就有）");
location.href='analysis.html';
}
</script>

</body>
</html>
