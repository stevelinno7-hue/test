<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’éŠæˆ²å ´ - é›²ç«¯å­¸é™¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ç¿»ç‰Œç‰¹æ•ˆ */
        .perspective { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .card-front { background: white; color: #334155; border: 2px solid #e2e8f0; }
        .card-back { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; transform: rotateY(180deg); }
        
        /* é…å°å¡ç‰‡æ¨£å¼ */
        .mem-card.matched .card-back { background: #22c55e !important; border-color: #22c55e; }
        
        .game-section { display: none; }
        .game-section.active { display: block; animation: fadeIn 0.3s ease-out; }
    </style>

    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/generator_engine.js"></script>
    <script src="mockdata/generator_engine_polyfill.js"></script>
    <script src="mockdata/AutoTemplateFissionFactory.js"></script>
    <script src="mockdata/auto_fission_bootstrap.js"></script>
    <script src="mockdata/paper_generator.js"></script>
    <script src="mockdata/curriculum_integrated.js"></script>
    <script src="mockdata/templates_math_algebra_geometry.js"></script>
    <script src="mockdata/templates_physics_multistep.js"></script>
    <script src="mockdata/templates_chemistry_core.js"></script>
    <script src="mockdata/templates_biology_core.js"></script> 
    <script src="mockdata/templates_english_core.js"></script>
    <script src="mockdata/templates_english_vocab_7000.js"></script>
    <script src="mockdata/templates_chinese_core.js"></script>
    <script src="mockdata/templates_history_core.js"></script>
    <script src="mockdata/templates_geography_core.js"></script>
    <script src="mockdata/templates_civics_core.js"></script>

</head>
<body class="h-screen flex overflow-hidden">
    <aside class="w-64 bg-white border-r border-slate-100 hidden lg:flex flex-col z-20 shrink-0 h-screen sticky top-0">
        <div class="h-16 flex items-center px-6 border-b border-slate-50">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-sm mr-2 shadow-sm">å­¸</div>
            <span class="text-lg font-bold text-slate-800">é›²ç«¯å­¸é™¢</span>
        </div>
        <nav class="flex-grow px-3 py-6 space-y-1">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition font-medium"><i class="fas fa-th-large w-5 text-center"></i> èª²ç¨‹ç¸½è¦½</a>
            <a href="remedial.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition font-medium"><i class="fas fa-book-medical w-5 text-center"></i> éŒ¯é¡Œè£œæ•‘</a>
            <a href="study.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition font-medium"><i class="fas fa-highlighter w-5 text-center"></i> é‡é»è¤‡ç¿’</a>
            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-50 text-indigo-600 font-bold shadow-sm"><i class="fas fa-gamepad w-5 text-center"></i> éŠæˆ²å ´</a>
            <a href="forum.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition font-medium"><i class="fas fa-comments w-5 text-center"></i> è§£é¡Œè«–å£‡</a>
        </nav>
    </aside>

    <main class="flex-grow flex flex-col h-full relative overflow-hidden">
        <div class="p-6 md:p-8 overflow-y-auto h-full scroll-smooth">
            
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-800 flex items-center gap-3">
                        <i class="fas fa-rocket text-indigo-500"></i> <span id="gamePageTitle">å­¸ç¿’éŠæˆ²å ´</span>
                    </h1>
                    <p class="text-slate-500 mt-1" id="gamePageSub">è¼‰å…¥æ‚¨çš„å°ˆå±¬é¡Œåº«ä¸­...</p>
                </div>
                <div class="flex gap-2">
                    <span class="px-4 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-coins"></i> é‡‘å¹£: <span id="coinCount">0</span>
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="gameMenu">
                <div onclick="startGame('flashcard')" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition">
                        <i class="fas fa-clone"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">æ™ºèƒ½é–ƒç¤ºå¡</h3>
                    <p class="text-slate-500">å°‡é¡Œç›®è½‰ç‚ºè¨˜æ†¶å¡ï¼Œæ­£é¢å•é¡Œã€èƒŒé¢ç­”æ¡ˆã€‚é©åˆèƒŒèª¦å–®å­—ã€å…¬å¼æˆ–æ­·å²å¹´ä»£ã€‚</p>
                </div>

                <div onclick="startGame('math_rush')" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group" id="cardMathRush">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition">
                        <i class="fas fa-stopwatch"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">æ¥µé€ŸæŒ‘æˆ°è³½</h3>
                    <p class="text-slate-500">é™æ™‚ 60 ç§’ï¼ç­”å°è¶Šå¤šåˆ†è¶Šé«˜ã€‚é€™æ˜¯å°ˆå±¬æ–¼æ•¸å­¸ç§‘çš„åæ‡‰è¨“ç·´ã€‚</p>
                </div>

                <div onclick="startGame('memory_match')" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition">
                        <i class="fas fa-puzzle-piece"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">çŸ¥è­˜å°å°ç¢°</h3>
                    <p class="text-slate-500">ç¿»ç‰Œé…å°éŠæˆ²ï¼æ‰¾å‡ºé¡Œç›®èˆ‡æ­£ç¢ºç­”æ¡ˆçš„çµ„åˆï¼Œè€ƒé©—æ‚¨çš„è¨˜æ†¶èˆ‡è§€å¿µé€£çµã€‚</p>
                </div>
            </div>

            <div id="game-flashcard" class="game-section max-w-2xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>çµæŸç·´ç¿’</button>
                    <span class="text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded-lg" id="fcSubjectTag">ç§‘ç›®</span>
                </div>
                <div class="perspective h-96 w-full cursor-pointer" onclick="flipCard(this)">
                    <div class="card-inner relative w-full h-full" id="flashCardInner">
                        <div class="card-face card-front flex-col p-8">
                            <span class="text-xs text-slate-400 font-bold mb-4 uppercase tracking-widest bg-slate-100 px-2 py-1 rounded">Question</span>
                            <div class="flex-grow flex items-center justify-center w-full">
                                <h2 class="text-2xl font-bold text-slate-800 text-center leading-relaxed" id="fcQuestion">è¼‰å…¥ä¸­...</h2>
                            </div>
                            <p class="mt-4 text-slate-400 text-xs flex items-center gap-1"><i class="fas fa-hand-pointer"></i> é»æ“Šç¿»é¢æŸ¥çœ‹ç­”æ¡ˆ</p>
                        </div>
                        <div class="card-face card-back flex-col p-8 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl"><i class="fas fa-lightbulb"></i></div>
                            <span class="text-xs text-blue-200 font-bold mb-4 uppercase tracking-widest bg-white/20 px-2 py-1 rounded">Answer</span>
                            <div class="flex-grow flex flex-col items-center justify-center w-full z-10">
                                <h2 class="text-3xl font-extrabold text-white text-center mb-4" id="fcAnswer">...</h2>
                                <p class="text-sm text-blue-100 bg-black/10 p-3 rounded-lg w-full text-center" id="fcExplain">è§£æè¼‰å…¥ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center gap-4 mt-8">
                    <button onclick="nextFlashcard()" class="px-8 py-3 bg-white border-2 border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition shadow-sm">
                        ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <div id="game-math_rush" class="game-section max-w-xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>æ”¾æ£„</button>
                    <div class="flex items-center gap-3">
                        <div class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-mono font-bold text-xl border border-red-100 shadow-sm">
                            <i class="far fa-clock mr-2"></i><span id="mrTimer">60</span>
                        </div>
                        <div class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl font-mono font-bold text-xl border border-blue-100 shadow-sm">
                            <i class="fas fa-star mr-2"></i><span id="mrScore">0</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-[2rem] shadow-xl border border-slate-100 p-8 text-center relative overflow-hidden">
                    <div id="mrGameArea">
                        <div class="mb-8">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Question</span>
                            <h2 class="text-4xl font-extrabold text-slate-800 mt-2 leading-tight" id="mrQuestion">æº–å‚™é–‹å§‹...</h2>
                        </div>
                        <div class="grid grid-cols-1 gap-3" id="mrOptions"></div>
                    </div>
                    <div id="mrGameOver" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center z-20">
                        <div class="w-20 h-20 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-4xl mb-4 shadow-sm animate-bounce"><i class="fas fa-trophy"></i></div>
                        <h3 class="text-3xl font-extrabold text-slate-800 mb-2">æ™‚é–“åˆ°ï¼</h3>
                        <div class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-8" id="mrFinalScore">0</div>
                        <button onclick="initMathRush()" class="px-10 py-3 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:bg-slate-800 transition transform hover:scale-105">å†ç©ä¸€æ¬¡</button>
                    </div>
                </div>
            </div>

            <div id="game-memory_match" class="game-section max-w-4xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>çµæŸéŠæˆ²</button>
                    <span class="text-green-600 font-bold bg-green-50 px-3 py-1 rounded-lg">æ‰¾å‡ºå°æ‡‰çš„ é¡Œç›® èˆ‡ ç­”æ¡ˆ</span>
                </div>
                <div class="grid grid-cols-4 gap-4" id="memoryGrid"></div>
            </div>

        </div>
    </main>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let gameQuestions = [];
        let currentQIdx = 0;
        let score = 0;
        let timer = 0;
        let timerInterval;
        let flippedCards = [];
        let matchedPairs = 0;

        // 1. åˆå§‹åŒ–èˆ‡åƒæ•¸è§£æ
        const urlParams = new URLSearchParams(window.location.search);
        let currentSubject = urlParams.get('subject') || 'all'; // é è¨­å…¨éƒ¨
        const pageTitle = urlParams.get('title') || 'ç¶œåˆç·´ç¿’';

        const user = Auth.getCurrentUser();
        if(user) {
            document.getElementById('coinCount').textContent = user.coins || 0;
        }

        // æ›´æ–°æ¨™é¡Œ
        document.getElementById('gamePageTitle').textContent = `${pageTitle} éŠæˆ²å ´`;
        document.getElementById('gamePageSub').textContent = `æ­£åœ¨ç‚ºæ‚¨è¼‰å…¥ ${pageTitle} çš„å°ˆå±¬é¡Œåº«...`;
        document.getElementById('fcSubjectTag').textContent = pageTitle;

        // å¦‚æœä¸æ˜¯æ•¸å­¸ï¼Œéš±è—ã€Œæ¥µé€ŸæŒ‘æˆ°ã€(å› ç‚ºå…¶ä»–ç§‘é¡Œç›®å¤ªé•·ä¸é©åˆé™æ™‚)
        if (currentSubject !== 'math' && currentSubject !== 'all') {
            document.getElementById('cardMathRush').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('cardMathRush').innerHTML += '<div class="absolute inset-0 bg-white/50 flex items-center justify-center font-bold text-gray-500">é™æ•¸å­¸ç§‘</div>';
        }

        // 2. æ ¸å¿ƒï¼šå…¨ç§‘é¡Œåº«ç”Ÿæˆå™¨
        function generateGameQuestions(subject, count = 20) {
            if (window.generatePaper) {
                // å¦‚æœ subject æ˜¯ 'all'ï¼Œå‰‡éš¨æ©ŸæŠ“å–å„ç§‘
                let targetSubject = subject === 'all' ? 'math' : subject; 
                // æ³¨æ„ï¼šé€™è£¡ç›´æ¥èª¿ç”¨æ‚¨çš„ Generator Engine
                const q = window.generatePaper({ subject: targetSubject, total: count, tags: ['åœ‹ä¸ƒ','åœ‹å…«','åœ‹ä¹','é«˜ä¸€','é«˜äºŒ','é«˜ä¸‰'] });
                return q.filter(item => item && item.question);
            }
            return [];
        }

        // å°èˆª
        function startGame(gameId) {
            document.getElementById('gameMenu').classList.add('hidden');
            document.querySelectorAll('.game-section').forEach(el => el.classList.remove('active', 'hidden'));
            document.getElementById(`game-${gameId}`).classList.add('active');

            if(gameId === 'flashcard') initFlashcard();
            if(gameId === 'math_rush') initMathRush();
            if(gameId === 'memory_match') initMemoryMatch();
        }

        function backToMenu() {
            document.getElementById('gameMenu').classList.remove('hidden');
            document.querySelectorAll('.game-section').forEach(el => {
                el.classList.remove('active');
                el.classList.add('hidden');
            });
            clearInterval(timerInterval);
        }

        // ============================================
        //  Game 1: æ™ºèƒ½é–ƒç¤ºå¡ (Flashcard) - æ”¯æ´æ‰€æœ‰ç§‘ç›®
        // ============================================
        function initFlashcard() {
            setTimeout(() => {
                // æ ¹æ“šç•¶å‰ç§‘ç›®ç”Ÿæˆé¡Œç›®
                gameQuestions = generateGameQuestions(currentSubject, 10);
                
                if(gameQuestions.length === 0) {
                    alert("ç›®å‰ç§‘ç›®é¡Œåº«è¼‰å…¥ä¸­æˆ–ç„¡é¡Œç›®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    backToMenu();
                    return;
                }
                
                currentQIdx = 0;
                renderFlashcard();
            }, 500);
        }

        function renderFlashcard() {
            const q = gameQuestions[currentQIdx % gameQuestions.length];
            document.getElementById('fcQuestion').innerHTML = q.question.replace(/\n/g, '<br>');
            
            let ansText = "è©³è¦‹è§£æ";
            if (q.options && q.answer !== undefined) ansText = q.options[q.answer];
            else if (typeof q.answer === 'string' || typeof q.answer === 'number') ansText = q.answer;
            
            document.getElementById('fcAnswer').innerHTML = ansText;
            document.getElementById('fcExplain').innerHTML = (q.explanation || []).join('<br>') || "æœ¬é¡Œç‚ºè§€å¿µé¡Œ";
            
            document.getElementById('flashCardInner').classList.remove('is-flipped');
            if(window.MathJax) MathJax.typesetPromise();
        }

        function flipCard(el) { el.querySelector('.card-inner').classList.toggle('is-flipped'); }
        function nextFlashcard() {
            currentQIdx++;
            const inner = document.getElementById('flashCardInner');
            inner.style.opacity = '0';
            setTimeout(() => { renderFlashcard(); inner.style.opacity = '1'; }, 300);
        }

        // ============================================
        //  Game 2: æ¥µé€ŸæŒ‘æˆ° (Math Rush) - æ•¸å­¸å°ˆç”¨
        // ============================================
        function initMathRush() {
            setTimeout(() => {
                // å¼·åˆ¶ç”Ÿæˆæ•¸å­¸é¡Œ (50é¡Œ)
                gameQuestions = generateGameQuestions('math', 50);
                if(gameQuestions.length === 0) { alert("æ•¸å­¸é¡Œåº«è¼‰å…¥å¤±æ•—"); backToMenu(); return; }

                score = 0; timer = 60; currentQIdx = 0;
                document.getElementById('mrScore').textContent = score;
                document.getElementById('mrTimer').textContent = timer;
                document.getElementById('mrGameOver').classList.add('hidden');
                
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timer--;
                    document.getElementById('mrTimer').textContent = timer;
                    if(timer <= 0) { clearInterval(timerInterval); document.getElementById('mrFinalScore').textContent = score; document.getElementById('mrGameOver').classList.remove('hidden'); }
                }, 1000);
                
                renderMathQuestion();
            }, 500);
        }

        function renderMathQuestion() {
            if (currentQIdx >= gameQuestions.length) currentQIdx = 0;
            const q = gameQuestions[currentQIdx];
            document.getElementById('mrQuestion').innerHTML = q.question;
            const container = document.getElementById('mrOptions');
            container.innerHTML = '';
            
            if(q.options) {
                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full py-4 text-lg font-bold bg-slate-50 border border-slate-200 rounded-xl hover:bg-blue-50 hover:border-blue-300 transition text-slate-700 shadow-sm";
                    btn.innerHTML = opt;
                    btn.onclick = () => {
                        if(idx === q.answer) {
                            score += 100; document.getElementById('mrScore').textContent = score;
                            btn.classList.add('bg-green-500', 'text-white');
                            setTimeout(() => { currentQIdx++; renderMathQuestion(); }, 200);
                        } else {
                            score = Math.max(0, score - 50); document.getElementById('mrScore').textContent = score;
                            btn.classList.add('bg-red-500', 'text-white');
                        }
                    };
                    container.appendChild(btn);
                });
            }
            if(window.MathJax) MathJax.typesetPromise();
        }

        // ============================================
        //  Game 3: çŸ¥è­˜å°å°ç¢° (Memory Match) - å…¨ç§‘é€šç”¨
        // ============================================
        function initMemoryMatch() {
            setTimeout(() => {
                // 1. æŠ“å– 6 é¡Œ
                const rawQuestions = generateGameQuestions(currentSubject, 6);
                if(rawQuestions.length < 6) { alert("é¡Œç›®æ•¸é‡ä¸è¶³ä»¥é€²è¡Œé…å°éŠæˆ²"); backToMenu(); return; }

                const container = document.getElementById('memoryGrid');
                container.innerHTML = '';
                flippedCards = [];
                matchedPairs = 0;
                
                // 2. è£½ä½œå¡ç‰‡å° (Qå¡ èˆ‡ Aå¡)
                let cards = [];
                rawQuestions.forEach((q, i) => {
                    // Qå¡ (é¡¯ç¤ºé¡Œç›®)
                    cards.push({ id: i, content: q.question, type: 'q' });
                    // Aå¡ (é¡¯ç¤ºç­”æ¡ˆ)
                    let ansText = q.options ? q.options[q.answer] : q.answer;
                    cards.push({ id: i, content: ansText, type: 'a' });
                });

                // 3. æ´—ç‰Œ
                cards.sort(() => Math.random() - 0.5);

                // 4. æ¸²æŸ“
                cards.forEach((card, index) => {
                    const el = document.createElement('div');
                    el.className = 'perspective h-32 cursor-pointer'; // å¡ç‰‡é«˜åº¦
                    // æ ¹æ“šæ˜¯ Q é‚„æ˜¯ A çµ¦äºˆä¸åŒé¡è‰²æç¤º
                    const backColor = card.type === 'q' ? 'text-indigo-700 border-indigo-200' : 'text-green-700 border-green-200';
                    const icon = card.type === 'q' ? 'fa-question' : 'fa-lightbulb';
                    
                    el.innerHTML = `
                        <div class="card-inner w-full h-full relative transition-transform duration-500 transform-style-3d mem-card" id="mem-card-${index}" data-id="${card.id}">
                            <div class="card-face absolute w-full h-full bg-indigo-500 rounded-xl flex items-center justify-center text-white text-2xl shadow-md border-b-4 border-indigo-700">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="card-face card-back absolute w-full h-full bg-white rounded-xl flex items-center justify-center p-2 text-center text-xs font-bold shadow-md border-2 ${backColor}" style="transform: rotateY(180deg); backface-visibility: hidden; overflow: hidden;">
                                ${card.content}
                            </div>
                        </div>
                    `;
                    el.onclick = () => handleMemoryClick(index, card.id);
                    container.appendChild(el);
                });
                if(window.MathJax) MathJax.typesetPromise();

            }, 500);
        }

        function handleMemoryClick(index, id) {
            const cardEl = document.getElementById(`mem-card-${index}`);
            // é˜²æ­¢é‡è¤‡é»æ“Šã€å·²ç¿»é–‹ã€å·²é…å°
            if(flippedCards.length >= 2 || cardEl.classList.contains('is-flipped') || cardEl.classList.contains('matched')) return;

            cardEl.style.transform = 'rotateY(180deg)';
            cardEl.classList.add('is-flipped');
            flippedCards.push({ index, id, element: cardEl });

            if(flippedCards.length === 2) {
                checkMemoryMatch();
            }
        }

        function checkMemoryMatch() {
            const [c1, c2] = flippedCards;
            
            if (c1.id === c2.id) {
                // é…å°æˆåŠŸ
                c1.element.classList.add('matched');
                c2.element.classList.add('matched');
                flippedCards = [];
                matchedPairs++;
                // å¢åŠ é‡‘å¹£
                if(user) {
                    user.coins = (user.coins || 0) + 10;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    document.getElementById('coinCount').textContent = user.coins;
                }

                if(matchedPairs === 6) {
                    setTimeout(() => alert("ğŸ‰ æ­å–œï¼å…¨éƒ¨é…å°æˆåŠŸï¼ç²å¾— 60 é‡‘å¹£ï¼"), 500);
                }
            } else {
                // é…å°å¤±æ•—ï¼Œç¿»å›å»
                setTimeout(() => {
                    c1.element.style.transform = 'rotateY(0deg)';
                    c2.element.style.transform = 'rotateY(0deg)';
                    c1.element.classList.remove('is-flipped');
                    c2.element.classList.remove('is-flipped');
                    flippedCards = [];
                }, 1000);
            }
        }

    </script>
</body>
</html>
