<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’éŠæˆ²å ´ - é›²ç«¯å­¸é™¢</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* === ç¿»ç‰Œç‰¹æ•ˆ (ä¿®æ­£ç‰ˆ) === */
        .perspective { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        
        /* ç¢ºä¿å¡ç‰‡æ­£åé¢éš±è—é‚è¼¯æ­£ç¢º */
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* å…§å®¹é¢ (Content)ï¼šåˆå§‹æ—‹è½‰ 180 åº¦ (èƒŒé¢ç‹€æ…‹)ï¼Œç¿»è½‰å¾Œè®Šæ­£é¢ */
        .card-front { background: white; color: #0f172a; border: 2px solid #e2e8f0; transform: rotateY(180deg); z-index: 2; overflow: hidden; padding: 0.5rem; }
        
        /* å°é¢é¢ (Pattern)ï¼šåˆå§‹ 0 åº¦ (æ­£é¢ç‹€æ…‹)ï¼Œç¿»è½‰å¾Œéš±è— */
        .card-back { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; transform: rotateY(0deg); z-index: 1; }
        
        .matched .card-inner { opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        
        /* éŠæˆ²å€å¡Šåˆ‡æ›å‹•ç•« */
        .game-section { display: none; }
        .game-section.active { display: block; animation: fadeIn 0.3s ease-out; }
    </style>

    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/generator_engine.js"></script>
    <script src="mockdata/generator_engine_polyfill.js"></script>
    <script src="mockdata/AutoTemplateFissionFactory.js"></script>
    <script src="mockdata/auto_fission_bootstrap.js"></script>
    <script src="mockdata/paper_generator.js"></script>
    <script src="mockdata/curriculum_integrated.js"></script>
    
    <script src="mockdata/templates_math_algebra_geometry.js"></script>
    <script src="mockdata/templates_physics_multistep.js"></script>
    <script src="mockdata/templates_chemistry_core.js"></script>
    <script src="mockdata/templates_biology_core.js"></script>
    <script src="mockdata/templates_english_core.js"></script>
    <script src="mockdata/templates_chinese_core.js"></script>
    <script src="mockdata/templates_history_core.js"></script>
    <script src="mockdata/templates_geography_core.js"></script>
    <script src="mockdata/templates_civics_core.js"></script>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-slate-100 hidden lg:flex flex-col z-20 shrink-0 h-screen sticky top-0">
        <div class="h-16 flex items-center px-6 border-b border-slate-50">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-sm mr-2 shadow-sm">å­¸</div>
            <span class="text-lg font-bold text-slate-800">é›²ç«¯å­¸é™¢</span>
        </div>
        <div class="p-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center">
                <div class="w-16 h-16 mx-auto bg-blue-50 rounded-full flex items-center justify-center text-2xl text-blue-600 mb-3 border-2 border-white shadow-sm">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <h3 class="font-bold text-gray-800 text-lg" id="sideUserName">--</h3>
                <div class="text-xs text-gray-500 mb-3" id="sideUserRole">--</div>
                <button onclick="openProfileModal()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full transition">
                    <i class="fas fa-pen mr-1"></i> ç·¨è¼¯å¹´ç´š
                </button>
            </div>
        </div>
        <nav class="flex-grow px-3 space-y-1">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-book-medical w-5 text-center"></i> èª²ç¨‹ç¸½è¦½</a>
            <a href="remedial.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-book-medical w-5 text-center"></i> éŒ¯é¡Œè£œæ•‘</a>
            <a href="study.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> é‡é»è¤‡ç¿’</a>
            <a href="arcade.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold shadow-sm"><i class="fas fa-th-large w-5 text-center"></i> éŠæˆ²å ´</a>
            <a href="forum.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> è§£é¡Œè«–å£‡</a>
        </nav>
        <div class="p-4 border-t border-slate-50">
            <button onclick="Auth.logout()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-red-500 py-3 transition-colors font-bold text-xs"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºç³»çµ±</button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col h-full relative overflow-hidden">
        <div class="p-6 md:p-8 overflow-y-auto h-full scroll-smooth">
            
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-800 flex items-center gap-3">
                        <i class="fas fa-rocket text-indigo-500"></i> å­¸ç¿’éŠæˆ²å ´
                    </h1>
                    <p class="text-slate-500 mt-1">ä½¿ç”¨æ‚¨çš„å°ˆå±¬é¡Œåº«ï¼Œé‚Šç©é‚Šå­¸ï¼</p>
                </div>
                <div class="flex gap-2">
                    <span class="px-4 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-coins"></i> é‡‘å¹£: <span id="coinCount">0</span>
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="gameMenu">
                
                <div onclick="startGame('flashcard')" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-clone"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">æ™ºèƒ½é–ƒç¤ºå¡</h3>
                    <p class="text-sm text-slate-500">ç¿»ç‰Œè¨˜æ†¶ï¼Œè¤‡ç¿’è§€å¿µçš„æœ€ä½³åˆ©å™¨ã€‚</p>
                </div>

                <div onclick="startGame('math_rush')" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-14 h-14 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-stopwatch"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">æ¥µé€ŸæŒ‘æˆ°è³½</h3>
                    <p class="text-sm text-slate-500">é™æ™‚æ¶ç­”ï¼æŒ‘æˆ°ä½ çš„åæ‡‰é€Ÿåº¦ã€‚</p>
                </div>

                <div onclick="startGame('memory_match')" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-brain"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">è…¦åŠ›é…å°ï¼ˆä¼‘é–’éŠæˆ²Plus)</h3>
                    <p class="text-sm text-slate-500">æ‰¾å‡ºéš±è—çš„é—œè¯å¡ç‰‡ï¼ï¼ˆä¼‘é–’éŠæˆ²Plus)</p>
                </div>

                <div onclick="startGame('rpg_battle')" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-14 h-14 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-khanda"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">å‹‡è€…é¬¥æƒ¡é¾</h3>
                    <p class="text-sm text-slate-500">ç­”é¡Œæ”»æ“Šï¼æ“Šæ•—æ€ªç¸å®ˆè­·åŸå ¡ã€‚</p>
                </div>

                <div onclick="startGame('defuse_bomb')" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-bomb"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">æ‹†å½ˆå°ˆå®¶</h3>
                    <p class="text-sm text-slate-500">ç­”éŒ¯å³çˆ†ï¼é€£çºŒç­”å°ä¾†è§£é™¤å±æ©Ÿã€‚</p>
                </div>

                <div onclick="startGame('lucky_wheel')" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition cursor-pointer group">
                    <div class="w-14 h-14 bg-yellow-100 text-yellow-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-dharmachakra"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">å¹¸é‹è½‰ç›¤</h3>
                    <p class="text-sm text-slate-500">è½‰å‡ºé«˜åˆ†å€ç‡ï¼ŒæŒ‘æˆ°é‹æ°£èˆ‡å¯¦åŠ›ã€‚</p>
                </div>

            </div>


            <div id="game-flashcard" class="game-section max-w-2xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>çµæŸ</button>
                    <span class="text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded-lg">ç§‘ç›®ï¼š<span id="fcSubject">æ•¸å­¸</span></span>
                </div>
                <div class="perspective h-96 w-full cursor-pointer" onclick="flipCard(this)">
                    <div class="card-inner relative w-full h-full" id="flashCardInner">
                        <div class="card-face card-front flex-col p-8">
                            <span class="text-xs text-slate-400 font-bold mb-4 uppercase tracking-widest bg-slate-100 px-2 py-1 rounded">Answer</span>
                            <div class="flex-grow flex flex-col items-center justify-center w-full">
                                <h2 class="text-3xl font-extrabold text-blue-600 text-center mb-4" id="fcAnswer">...</h2>
                            </div>
                        </div>
                        <div class="card-face card-back flex-col p-8 text-center bg-white">
                            <span class="text-xs text-white/80 font-bold mb-4 uppercase tracking-widest bg-white/20 px-2 py-1 rounded">Question</span>
                            <div class="flex-grow flex items-center justify-center w-full">
                                <h2 class="text-2xl font-bold text-white leading-relaxed" id="fcQuestion">...</h2>
                            </div>
                            <p class="mt-4 text-white/60 text-xs">é»æ“Šç¿»é¢æŸ¥çœ‹ç­”æ¡ˆ</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center mt-8"><button onclick="nextFlashcard()" class="px-8 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50">ä¸‹ä¸€é¡Œ</button></div>
            </div>

            <div id="game-math_rush" class="game-section max-w-xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>æ”¾æ£„</button>
                    <div class="flex items-center gap-3">
                        <div class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold text-xl"><i class="far fa-clock mr-2"></i><span id="mrTimer">--</span></div>
                        <div class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl font-bold text-xl"><i class="fas fa-star mr-2"></i><span id="mrScore">0</span></div>
                    </div>
                </div>
                <div class="bg-white rounded-[2rem] shadow-xl p-8 text-center relative overflow-hidden min-h-[400px] flex flex-col justify-center">
                    <div id="mrTimeSelector" class="absolute inset-0 bg-white z-10 flex flex-col items-center justify-center p-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">æº–å‚™æŒ‘æˆ°</h2>
                        <div class="grid grid-cols-1 gap-3 w-full max-w-xs mt-4">
                            <button onclick="startSpeedGame(30)" class="w-full py-3 bg-white border-2 border-slate-200 hover:border-blue-500 text-slate-600 rounded-xl font-bold">âš¡ 30 ç§’</button>
                            <button onclick="startSpeedGame(60)" class="w-full py-3 bg-white border-2 border-slate-200 hover:border-blue-500 text-slate-600 rounded-xl font-bold">â±ï¸ 60 ç§’</button>
                        </div>
                    </div>
                    <div id="mrGameArea" class="hidden">
                        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800 mb-8 mt-2 leading-relaxed" id="mrQuestion">...</h2>
                        <div class="grid grid-cols-1 gap-3" id="mrOptions"></div>
                    </div>
                    <div id="mrGameOver" class="hidden text-center py-10">
                        <h3 class="text-3xl font-bold text-slate-800 mb-2">æ™‚é–“åˆ°ï¼</h3>
                        <div class="text-6xl font-black text-blue-600 mb-8" id="mrFinalScore">0</div>
                        <button onclick="initMathRush()" class="px-10 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-700">å†ç©ä¸€æ¬¡</button>
                    </div>
                </div>
            </div>

            <div id="game-memory_match" class="game-section max-w-4xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>çµæŸ</button>
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-50 text-purple-600 px-4 py-2 rounded-xl font-bold text-xl">
                            <i class="fas fa-check-double mr-2"></i><span id="mmMatches">0</span>/6
                        </div>
                    </div>
                </div>
                <div id="mmGrid" class="grid grid-cols-3 md:grid-cols-4 gap-4 w-full h-[500px]"></div>
                
                <div id="mmGameOver" class="hidden text-center py-12 bg-white rounded-3xl shadow-lg mt-4">
                    <h3 class="text-3xl font-bold text-slate-800 mb-2">é…å°å®Œæˆï¼</h3>
                    <button onclick="initMemoryMatch()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg transition">å†ç©ä¸€æ¬¡</button>
                </div>
            </div>

            <div id="game-rpg_battle" class="game-section max-w-2xl mx-auto hidden">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>é€ƒè·‘</button>
                    <div class="bg-red-50 text-red-600 px-3 py-1 rounded-lg font-bold">â¤ï¸ HP: <span id="heroHp">100</span></div>
                </div>
                <div class="bg-slate-800 rounded-2xl p-6 text-white text-center mb-4 relative overflow-hidden h-64 flex flex-col justify-end items-center">
                    <div id="rpgMonster" class="mb-4">
                        <i class="fas fa-dragon text-8xl text-red-400"></i>
                        <div class="mt-2 font-bold text-red-200">çŸ¥è­˜æƒ¡é¾</div>
                        <div class="w-48 h-3 bg-slate-700 rounded-full mx-auto mt-2 border border-slate-600 overflow-hidden">
                            <div id="monsterHpBar" class="h-full bg-red-500 transition-all duration-300" style="width: 100%"></div>
                        </div>
                    </div>
                    <div id="rpgEffect" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                        <div class="text-6xl font-black text-yellow-400 animate-ping">BANG!</div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
                    <h3 class="text-lg font-bold text-slate-800 mb-4" id="rpgQuestion">...</h3>
                    <div class="grid grid-cols-1 gap-3" id="rpgOptions"></div>
                </div>
            </div>

            <div id="game-defuse_bomb" class="game-section max-w-xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>æ”¾æ£„</button>
                    <div class="text-slate-400 font-bold">éœ€é€£çºŒç­”å° <span class="text-blue-600" id="bombStreakTarget">5</span> é¡Œ</div>
                </div>
                <div class="bg-slate-900 rounded-3xl p-8 text-center text-white relative shadow-2xl border-4 border-slate-700">
                    <div class="w-full bg-black/50 rounded-xl p-4 mb-6 border border-slate-600">
                        <div class="font-mono text-6xl text-red-500 font-black tracking-widest animate-pulse" id="bombTimer">10</div>
                    </div>
                    <div class="flex justify-center gap-2 mb-8" id="bombWires"></div>
                    <h3 class="text-xl font-bold mb-6" id="bombQuestion">æº–å‚™æ‹†å½ˆ...</h3>
                    <div class="grid grid-cols-2 gap-4" id="bombOptions"></div>
                    <div id="bombExplosion" class="absolute inset-0 bg-red-600 z-50 rounded-2xl flex flex-col items-center justify-center hidden">
                        <h2 class="text-4xl font-black text-white">BOOM!</h2>
                        <button onclick="initDefuseBomb()" class="mt-8 px-6 py-2 bg-white text-red-600 rounded-full font-bold">é‡è©¦</button>
                    </div>
                    <div id="bombSuccess" class="absolute inset-0 bg-green-500 z-50 rounded-2xl flex flex-col items-center justify-center hidden">
                        <h2 class="text-3xl font-black text-white">æ‹†å½ˆæˆåŠŸ!</h2>
                        <button onclick="initDefuseBomb()" class="mt-8 px-6 py-2 bg-white text-green-600 rounded-full font-bold">ä¸‹ä¸€é¡†</button>
                    </div>
                </div>
            </div>

            <div id="game-lucky_wheel" class="game-section max-w-2xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMenu()" class="text-slate-400 hover:text-slate-600 font-bold"><i class="fas fa-arrow-left mr-2"></i>çµæŸ</button>
                    <div class="bg-yellow-50 text-yellow-700 px-4 py-1 rounded-full font-bold">ç¸½åˆ†: <span id="wheelScore">0</span></div>
                </div>
                <div class="flex flex-col md:flex-row gap-8 items-center">
                    <div class="relative w-64 h-64 shrink-0">
                        <div id="wheelCircle" class="w-full h-full rounded-full border-8 border-yellow-300 bg-white flex items-center justify-center shadow-xl transition-transform duration-[3s] ease-out relative overflow-hidden" style="background: conic-gradient(#ff9999 0deg 60deg, #66b3ff 60deg 120deg, #99ff99 120deg 180deg, #ffcc99 180deg 240deg, #c2c2f0 240deg 300deg, #ffb3e6 300deg 360deg);"></div>
                        <button onclick="spinWheel()" id="spinBtn" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-white rounded-full font-bold text-slate-700 shadow-lg border-4 border-yellow-100 flex items-center justify-center z-20">GO</button>
                    </div>
                    <div class="flex-grow bg-white p-6 rounded-2xl shadow-sm border border-slate-200 opacity-50 pointer-events-none" id="wheelQuizArea">
                        <div class="text-3xl font-black text-yellow-500 mb-4" id="wheelMultiplier">x?</div>
                        <h3 class="text-lg font-bold text-slate-800 mb-4" id="wheelQuestion">è«‹å…ˆè½‰å‹•è½‰ç›¤...</h3>
                        <div class="grid grid-cols-1 gap-2" id="wheelOptions"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

<script>
        // ==========================================
        // ğŸŒ å…¨åŸŸè®Šæ•¸
        // ==========================================
        let currentSubject = 'math';
        let targetTags = [];
        let gameQuestions = [];
        let currentQIdx = 0;
        let timerInterval;

        // ==========================================
        // ğŸš€ ç³»çµ±åˆå§‹åŒ– (window.onload)
        // ==========================================
        window.onload = function() {
            // 1. èº«åˆ†é©—è­‰èˆ‡å¸³è™Ÿç¶å®š
            if (typeof Auth === 'undefined') {
                console.error("Auth module not loaded");
                alert("ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥é©—è­‰æ¨¡çµ„");
                return;
            }

            const user = Auth.getCurrentUser();
            if (!user) {
                alert("è«‹å…ˆç™»å…¥ï¼");
                window.location.href = "index.html";
                return;
            }
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’å„€è¡¨æ¿ - é›²ç«¯å­¸é™¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .course-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e2e8f0; }
        .course-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
    <script src="mockdata/users.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="mockdata/curriculum_integrated.js"></script>
</head>
<body class="h-screen flex overflow-hidden">
    <aside class="w-64 bg-white border-r border-slate-100 hidden lg:flex flex-col z-20 shrink-0 h-screen sticky top-0">
        <div class="h-16 flex items-center px-6 border-b border-slate-50">
            <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-sm mr-2 shadow-sm">å­¸</div>
            <span class="text-lg font-bold text-slate-800">é›²ç«¯å­¸é™¢</span>
        </div>
        <div class="p-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center">
                <div class="w-16 h-16 mx-auto bg-blue-50 rounded-full flex items-center justify-center text-2xl text-blue-600 mb-3 border-2 border-white shadow-sm">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <h3 class="font-bold text-gray-800 text-lg" id="sideUserName">--</h3>
                <div class="text-xs text-gray-500 mb-3" id="sideUserRole">--</div>
                <button onclick="openProfileModal()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full transition">
                    <i class="fas fa-pen mr-1"></i> ç·¨è¼¯å¹´ç´š
                </button>
            </div>
        </div>
        <nav class="flex-grow px-3 space-y-1">
            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold shadow-sm"><i class="fas fa-th-large w-5 text-center"></i> èª²ç¨‹ç¸½è¦½</a>
            <a href="remedial.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-book-medical w-5 text-center"></i> éŒ¯é¡Œè£œæ•‘</a>
            <a href="study.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-highlighter w-5 text-center"></i> é‡é»è¤‡ç¿’</a>
            <a href="arcade.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-gamepad w-5 text-center"></i> éŠæˆ²å ´</a>
            <a href="forum.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition"><i class="fas fa-comments w-5 text-center"></i> è§£é¡Œè«–å£‡</a>
        </nav>
        <div class="p-4 border-t border-slate-50">
            <button onclick="Auth.logout()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-red-500 py-3 transition-colors font-bold text-xs"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºç³»çµ±</button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col h-full relative">
        <div class="bg-white border-b border-gray-200 p-6 z-10 shadow-sm sticky top-0">
            <div class="max-w-7xl mx-auto flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">èª²ç¨‹ç¸½è¦½</h1>
                    <p class="text-sm text-gray-500 mt-1">é¸æ“‡ç§‘ç›®ï¼Œé€²å…¥å–®å…ƒå¼å­¸ç¿’</p>
                </div>
                <div class="bg-gray-100 p-1 rounded-lg flex text-sm font-bold">
                    <button onclick="setStage('high_school')" id="btnHigh" class="px-4 py-1.5 rounded-md transition bg-white text-gray-800 shadow-sm">é«˜ä¸­</button>
                    <button onclick="setStage('junior_high')" id="btnJunior" class="px-4 py-1.5 rounded-md transition text-gray-500 hover:text-gray-700">åœ‹ä¸­</button>
                </div>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto p-6 md:p-8" id="mainScroll">
            <div class="max-w-7xl mx-auto pb-20">
                <div id="courseContainer" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>
        <div id="profileModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm fade-in">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
        <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
            <h3 class="text-white font-bold text-lg"><i class="fas fa-user-edit mr-2"></i> ä¿®æ”¹å¹´ç´š</h3>
            <button onclick="closeProfileModal()" class="text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">è«‹é¸æ“‡ç›®å‰çš„å¹´ç´šï¼š</label>
            <div class="relative">
                <select id="editGradeSelect" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white appearance-none transition text-gray-700 font-bold">
                    <option value="åœ‹ä¸€">åœ‹ä¸€</option>
                    <option value="åœ‹äºŒ">åœ‹äºŒ</option>
                    <option value="åœ‹ä¸‰">åœ‹ä¸‰</option>
                    <hr>
                    <option value="é«˜ä¸€">é«˜ä¸€</option>
                    <option value="é«˜äºŒ">é«˜äºŒ</option>
                    <option value="é«˜ä¸‰">é«˜ä¸‰</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-3">â€» ä¿®æ”¹å¾Œï¼Œç³»çµ±å°‡æœƒå„ªå…ˆæ¨è–¦è©²å¹´ç´šçš„é¡Œç›®ã€‚</p>
        </div>

        <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-100">
            <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold text-sm">å–æ¶ˆ</button>
            <button onclick="saveProfile()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md hover:shadow-lg transition">
                ç¢ºèªä¿®æ”¹
            </button>
        </div>
    </div>
</div>
        <div id="profileModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm fade-in">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
        <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
            <h3 class="text-white font-bold text-lg"><i class="fas fa-user-edit mr-2"></i> ä¿®æ”¹å¹´ç´š</h3>
            <button onclick="closeProfileModal()" class="text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">è«‹é¸æ“‡ç›®å‰çš„å¹´ç´šï¼š</label>
            <div class="relative">
                <select id="editGradeSelect" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white appearance-none transition text-gray-700 font-bold">
                    <option value="åœ‹ä¸€">åœ‹ä¸€</option>
                    <option value="åœ‹äºŒ">åœ‹äºŒ</option>
                    <option value="åœ‹ä¸‰">åœ‹ä¸‰</option>
                    <hr>
                    <option value="é«˜ä¸€">é«˜ä¸€</option>
                    <option value="é«˜äºŒ">é«˜äºŒ</option>
                    <option value="é«˜ä¸‰">é«˜ä¸‰</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-3">â€» ä¿®æ”¹å¾Œï¼Œç³»çµ±å°‡æœƒå„ªå…ˆæ¨è–¦è©²å¹´ç´šçš„é¡Œç›®ã€‚</p>
        </div>

        <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-100">
            <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold text-sm">å–æ¶ˆ</button>
            <button onclick="saveProfile()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md hover:shadow-lg transition">
                ç¢ºèªä¿®æ”¹
            </button>
        </div>
    </div>
</div>
    </main>

    <input type="hidden" id="currentStage" value="high_school">

   <script>
        window.onload = function() {
            // ç¢ºä¿ Auth ç‰©ä»¶å­˜åœ¨ï¼Œé¿å…å ±éŒ¯ (å¦‚æœåªæ¸¬è©¦å‰ç«¯ UIï¼Œå¯ä»¥è¨»è§£æ‰é€™å¡Š)
            if (typeof Auth !== 'undefined') {
                const user = Auth.getCurrentUser();
                if(user) {
                    document.getElementById('sideUserName').textContent = user.name;
                    document.getElementById('sideUserRole').textContent = user.grade;
                    if(user.grade && user.grade.includes('åœ‹')) setStage('junior_high');
                    else setStage('high_school');
                } else {
                    setStage('high_school');
                }
            } else {
                console.warn('Auth module not loaded, defaulting to high school.');
                setStage('high_school');
            }
        };
// ==========================================
// âœï¸ å€‹äººè³‡æ–™ç·¨è¼¯åŠŸèƒ½
// ==========================================

// 1. é–‹å•Ÿç·¨è¼¯è¦–çª—
function openProfileModal() {
    const user = Auth.getCurrentUser();
    if (!user) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        return;
    }

    // è¨­å®šä¸‹æ‹‰é¸å–®ç‚ºç›®å‰çš„å¹´ç´š
    const select = document.getElementById('editGradeSelect');
    if (user.grade) {
        select.value = user.grade;
    }
    
    // é¡¯ç¤ºè¦–çª—
    document.getElementById('profileModal').classList.remove('hidden');
}

// 2. é—œé–‰ç·¨è¼¯è¦–çª—
function closeProfileModal() {
    document.getElementById('profileModal').classList.add('hidden');
}

// 3. å„²å­˜ä¿®æ”¹
function saveProfile() {
    const newGrade = document.getElementById('editGradeSelect').value;
    
    // å‘¼å« Auth æ¨¡çµ„æ›´æ–°è³‡æ–™åº« (é€™æœƒåŒæ™‚æ›´æ–° LocalStorage å’Œ mockdata)
    if (Auth.updateUser) {
        Auth.updateUser('grade', newGrade);
        
        // æ›´æ–°ç•«é¢ä¸Šçš„æ–‡å­—
        const roleEl = document.getElementById('sideUserRole');
        if (roleEl) roleEl.innerText = newGrade;
        
        // æç¤ºæˆåŠŸ
        alert(`ä¿®æ”¹æˆåŠŸï¼ç›®å‰å¹´ç´šå·²æ›´æ–°ç‚ºï¼š${newGrade}`);
        closeProfileModal();
        
        // å¦‚æœæ˜¯åœ¨ dashboardï¼Œå¯èƒ½éœ€è¦é‡æ–°æ•´ç†é é¢ä»¥å¥—ç”¨æ–°é¡Œåº«è¨­å®š
        // location.reload(); 
    } else {
        console.error("Auth.updateUser å‡½å¼ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ auth.js");
        alert("ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•å„²å­˜è³‡æ–™");
    }
}
        function setStage(stage) {
            document.getElementById('currentStage').value = stage;
            const btnHigh = document.getElementById('btnHigh');
            const btnJunior = document.getElementById('btnJunior');
            
            if (stage === 'high_school') {
                btnHigh.className = "px-4 py-1.5 rounded-md transition shadow-sm bg-white text-gray-800 font-bold";
                btnJunior.className = "px-4 py-1.5 rounded-md transition text-gray-500 hover:text-gray-700 font-bold";
            } else {
                btnHigh.className = "px-4 py-1.5 rounded-md transition text-gray-500 hover:text-gray-700 font-bold";
                btnJunior.className = "px-4 py-1.5 rounded-md transition shadow-sm bg-white text-gray-800 font-bold";
            }
            renderCourses();
        }

        function renderCourses() {
            const stage = document.getElementById('currentStage').value;
            const container = document.getElementById('courseContainer');
            container.innerHTML = '';

            // å®šç¾©åŸºç¤ç§‘ç›® (åœ‹é«˜ä¸­éƒ½æœ‰)
            let subjects = [
                { id: 'chinese', name: 'åœ‹æ–‡', icon: 'fa-book-open', color: 'red' },
                { id: 'math', name: 'æ•¸å­¸', icon: 'fa-calculator', color: 'blue' },
                { id: 'english', name: 'è‹±æ–‡', icon: 'fa-language', color: 'purple' },
            ];

            // ä¾æ“šéšæ®µåŠ å…¥ä¸åŒè‡ªç„¶ç§‘
            if (stage === 'junior_high') {
                // åœ‹ä¸­ï¼šåŠ å…¥ã€Œç”Ÿç‰©ã€èˆ‡ã€Œç†åŒ–ã€
                subjects.push(
                    { id: 'biology', name: 'ç”Ÿç‰©', icon: 'fa-leaf', color: 'green' }, // åœ‹ä¸ƒ
                    { id: 'science', name: 'ç†åŒ–', icon: 'fa-flask', color: 'indigo' }, // åœ‹å…«ã€ä¹ (ç‰©ç†+åŒ–å­¸)
                    { id: 'earth', name: 'åœ°ç§‘', icon: 'fa-globe', color: 'orange' }    // åœ‹ä¹
                );
            } else {
                // é«˜ä¸­ï¼šç‰©ç†ã€åŒ–å­¸ã€ç”Ÿç‰©ã€åœ°ç§‘ åˆ†é–‹
                subjects.push(
                    { id: 'physics', name: 'ç‰©ç†', icon: 'fa-atom', color: 'indigo' },
                    { id: 'chemistry', name: 'åŒ–å­¸', icon: 'fa-vial', color: 'pink' },
                    { id: 'biology', name: 'ç”Ÿç‰©', icon: 'fa-leaf', color: 'green' },
                    { id: 'earth', name: 'åœ°ç§‘', icon: 'fa-globe', color: 'orange' }
                );
            }

            // åŠ å…¥ç¤¾æœƒç§‘ (åœ‹é«˜ä¸­éƒ½æœ‰)
            subjects.push(
                { id: 'history', name: 'æ­·å²', icon: 'fa-landmark', color: 'amber' },
                { id: 'geography', name: 'åœ°ç†', icon: 'fa-globe-americas', color: 'cyan' },
                { id: 'civics', name: 'å…¬æ°‘', icon: 'fa-balance-scale', color: 'teal' }
            );

            subjects.forEach((sub, idx) => {
                const linkHref = `course_hub.html?subject=${sub.id}&stage=${stage}&title=${encodeURIComponent(sub.name)}`;
                
                // å‹•æ…‹ç”Ÿæˆ HTML
                // æ³¨æ„ï¼šstyle="animation-delay" æ­é…ä¸Šæ–¹æ–°å¢çš„ CSS @keyframes fadeIn ä½¿ç”¨
                const html = `
                    <a href="${linkHref}" class="course-card bg-white rounded-xl p-6 flex flex-col items-center text-center hover:bg-${sub.color}-50 group fade-in" style="animation-delay: ${idx * 0.05}s">
                        <div class="w-16 h-16 rounded-2xl bg-${sub.color}-100 text-${sub.color}-600 flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition">
                            <i class="fas ${sub.icon}"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${sub.name}</h3>
                        <p class="text-xs text-gray-400 font-bold bg-gray-50 px-3 py-1 rounded-full border">
                            ${stage === 'high_school' ? 'é«˜ä¸­å…¨å†Š' : 'åœ‹ä¸­å…¨å†Š'}
                        </p>
                        <div class="mt-4 w-full pt-4 border-t border-gray-100 flex justify-center text-${sub.color}-600 font-bold text-sm">
                            é€²å…¥èª²ç¨‹ <i class="fas fa-arrow-right ml-2 mt-1"></i>
                        </div>
                    </a>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
    </script>
</body>
</html>
            // æ›´æ–°å´é‚Šæ¬„è³‡è¨Š
            const nameEl = document.getElementById('sideUserName');
            const roleEl = document.getElementById('sideUserRole');
            if(nameEl) nameEl.innerText = user.name || user.username;
            if(roleEl) roleEl.innerText = user.role === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ';

            // 2. è¨­å®šå°ˆå±¬çš„é‡‘å¹£ Key (ä¾‹å¦‚: coins_student123)
            const COIN_KEY = `coins_${user.username}`; 
            const coinDisplay = document.getElementById('coinCount');

            // å®šç¾©è®€å–é‡‘å¹£å‡½å¼
            window.loadCoins = function() {
                const saved = localStorage.getItem(COIN_KEY);
                return saved ? parseInt(saved) : 0;
            };

            // å®šç¾©å„²å­˜é‡‘å¹£å‡½å¼ (ä¸¦æ›´æ–°ç•«é¢)
            window.saveCoins = function(amount) {
                localStorage.setItem(COIN_KEY, amount);
                if(coinDisplay) coinDisplay.innerText = amount;
            };

            // åˆå§‹åŒ–é¡¯ç¤ºé‡‘å¹£
            let currentCoins = window.loadCoins();
            if(coinDisplay) coinDisplay.innerText = currentCoins;

            // 3. è®€å–ç¶²å€åƒæ•¸ (è¨­å®šç§‘ç›®èˆ‡å¹´ç´š)
            const urlParams = new URLSearchParams(window.location.search);
            currentSubject = urlParams.get('subject') || 'math';
            const rawGrade = decodeURIComponent(urlParams.get('grade') || '');
            
            if (rawGrade && rawGrade !== 'undefined' && rawGrade !== 'null') {
                targetTags = rawGrade.split(',').filter(t => t.trim() !== '');
            }
            
            const subjTitle = document.getElementById('fcSubject');
            if(subjTitle) subjTitle.textContent = getSubjectName(currentSubject);
        };

        // è¼”åŠ©ï¼šè½‰æ›ç§‘ç›®åç¨±
        function getSubjectName(code) {
            const map = { 'math': 'æ•¸å­¸', 'chinese': 'åœ‹èª', 'english': 'è‹±æ–‡', 'physics': 'ç‰©ç†', 'biology': 'ç”Ÿç‰©' };
            return map[code] || code;
        }

        // ==========================================
        // âš™ï¸ æ ¸å¿ƒåŠŸèƒ½å‡½å¼
        // ==========================================

        // é¡Œç›®ç”Ÿæˆå™¨
        function generateGameQuestions(subj, count) {
            if (window.generatePaper) {
                let q = window.generatePaper({ 
                    subject: subj, 
                    total: count, 
                    tags: targetTags.length > 0 ? targetTags : [subj] 
                }).filter(i => i && i.question);
                
                // è£œé½Šé¡Œç›®é˜²æ­¢ç•¶æ©Ÿ
                if (q.length < count) {
                    const backup = window.generatePaper({ subject: subj, total: count - q.length });
                    q = q.concat(backup);
                }
                return q;
            }
            // å¦‚æœæ²’æœ‰ç”Ÿæˆå™¨ï¼Œå›å‚³å‡è³‡æ–™é¿å…ç•¶æ©Ÿ
            console.warn("ç„¡æ³•è¼‰å…¥é¡Œç›®ç”Ÿæˆå™¨");
            return [];
        }

        function resolveAnswerText(q) {
            if (!q) return "???";
            if (typeof q.answer === 'number' && q.options && q.options[q.answer]) {
                return q.options[q.answer];
            }
            return q.answer;
        }

        function startGame(id) {
            document.getElementById('gameMenu').classList.add('hidden');
            document.querySelectorAll('.game-section').forEach(el => el.classList.add('hidden'));
            
            const gameSection = document.getElementById(`game-${id}`);
            if(gameSection) {
                gameSection.classList.remove('hidden');
                gameSection.classList.add('active');
            }
            
            if(id === 'flashcard') initFlashcard();
            if(id === 'math_rush') initMathRush();
            if(id === 'memory_match') initMemoryMatch();
            if(id === 'rpg_battle') initRPG();
            if(id === 'defuse_bomb') initDefuseBomb();
            if(id === 'lucky_wheel') initLuckyWheel();
        }

        function backToMenu() {
            document.getElementById('gameMenu').classList.remove('hidden');
            document.querySelectorAll('.game-section').forEach(e => {
                e.classList.remove('active');
                e.classList.add('hidden');
            });
            if (timerInterval) clearInterval(timerInterval);
        }

        // ==========================================
        // ğŸƒ éŠæˆ² 1: æ™ºèƒ½é–ƒç¤ºå¡
        // ==========================================
        function initFlashcard() {
            gameQuestions = generateGameQuestions(currentSubject, 10);
            if(!gameQuestions.length) { alert("âš ï¸ ç„¡é¡Œç›®ï¼Œè«‹æª¢æŸ¥é¡Œåº«è¨­å®š"); backToMenu(); return; }
            currentQIdx = 0; renderFlashcard();
        }
        function renderFlashcard() {
            const q = gameQuestions[currentQIdx % gameQuestions.length];
            document.getElementById('fcQuestion').innerHTML = q.question.replace(/\n/g, '<br>');
            let ans = resolveAnswerText(q);
            if(q.options && typeof q.answer === 'number') {
                ans = `<span class="text-4xl font-bold block mb-2 text-blue-300">${String.fromCharCode(65+q.answer)}</span><span class="text-xl">${ans}</span>`;
            }
            document.getElementById('fcAnswer').innerHTML = ans;
            document.getElementById('flashCardInner').classList.remove('is-flipped');
            if(window.MathJax) MathJax.typesetPromise();
        }
        function flipCard(el) { el.querySelector('.card-inner').classList.toggle('is-flipped'); }
        function nextFlashcard() { currentQIdx++; renderFlashcard(); }

        // ==========================================
        // â±ï¸ éŠæˆ² 2: æ¥µé€ŸæŒ‘æˆ° (å«é‡‘å¹£çå‹µ)
        // ==========================================
        let mrScore = 0, mrTimer = 60;
        function initMathRush() {
            document.getElementById('mrGameOver').classList.add('hidden');
            document.getElementById('mrGameArea').classList.add('hidden');
            document.getElementById('mrTimeSelector').classList.remove('hidden');
            document.getElementById('mrScore').textContent = 0;
        }
        function startSpeedGame(selectedTime) {
            gameQuestions = generateGameQuestions(currentSubject, 50);
            if(!gameQuestions.length) { alert("ç„¡é¡Œç›®"); backToMenu(); return; }
            mrScore = 0; mrTimer = selectedTime; currentQIdx = 0;
            document.getElementById('mrTimeSelector').classList.add('hidden');
            document.getElementById('mrGameArea').classList.remove('hidden');
            document.getElementById('mrTimer').textContent = mrTimer;
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                mrTimer--; 
                document.getElementById('mrTimer').textContent = mrTimer;
                if(mrTimer<=0) endMathRush();
            }, 1000);
            renderMathQuestion();
        }
        function renderMathQuestion() {
            const q = gameQuestions[currentQIdx % gameQuestions.length];
            document.getElementById('mrQuestion').innerHTML = q.question.replace(/\n/g, '<br>');
            const con = document.getElementById('mrOptions'); con.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full py-3 text-lg font-bold bg-slate-50 border-2 border-slate-100 rounded-xl hover:bg-blue-50 transition active:scale-95";
                btn.innerHTML = opt;
                btn.onclick = () => {
                    let isCorrect = (typeof q.answer === 'number' ? idx === q.answer : opt === q.answer);
                    if(isCorrect) { mrScore += 100; currentQIdx++; renderMathQuestion(); }
                    else { mrScore = Math.max(0, mrScore-50); btn.classList.add('bg-red-100', 'text-red-600'); }
                    document.getElementById('mrScore').textContent = mrScore;
                };
                con.appendChild(btn);
            });
            if(window.MathJax) MathJax.typesetPromise();
        }
        function endMathRush() {
            clearInterval(timerInterval);
            document.getElementById('mrGameArea').classList.add('hidden');
            document.getElementById('mrGameOver').classList.remove('hidden');
            document.getElementById('mrFinalScore').textContent = mrScore;

            // é‡‘å¹£çå‹µé‚è¼¯
            const coinsEarned = Math.floor(mrScore / 100);
            if (coinsEarned > 0) {
                let current = window.loadCoins(); 
                window.saveCoins(current + coinsEarned);
                alert(`æ™‚é–“åˆ°ï¼æ­å–œç²å¾— ${coinsEarned} æšé‡‘å¹£ï¼`);
            }
        }

        // ==========================================
        // ğŸ§  éŠæˆ² 3: è…¦åŠ›é…å° (å¼·åŠ›ä¿®å¾©ç‰ˆ)
        // ==========================================
        let mmCards = [], mmFlipped = [], mmLocked = false, mmMatches = 0;
        
        function initMemoryMatch() {
            let rawQuestions = generateGameQuestions(currentSubject, 6);
            
            // ä¿åº•é¡Œç›®
            if (!rawQuestions || rawQuestions.length < 6) {
                console.warn("é¡Œåº«ä¸è¶³ï¼Œå•Ÿç”¨ä¿åº•é¡Œç›®");
                rawQuestions = [
                    { question: "10 + 10 = ?", answer: "20" },
                    { question: "5 x 5 = ?", answer: "25" },
                    { question: "100 - 1 = ?", answer: "99" },
                    { question: "30 / 2 = ?", answer: "15" },
                    { question: "8 x 8 = ?", answer: "64" },
                    { question: "12 + 8 = ?", answer: "20" }
                ];
            }

            mmFlipped = []; mmLocked = false; mmMatches = 0;
            document.getElementById('mmGameOver').classList.add('hidden');
            document.getElementById('mmGrid').classList.remove('hidden');
            document.getElementById('mmMatches').textContent = 0;

            mmCards = [];
            rawQuestions.slice(0, 6).forEach((q, index) => {
                let ansText = resolveAnswerText(q);
                mmCards.push({ id: index, type: 'Q', content: q.question, display: 'text-sm font-bold text-slate-800' });
                mmCards.push({ id: index, type: 'A', content: ansText, display: 'text-lg font-extrabold text-blue-600' });
            });
            mmCards.sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('mmGrid');
            grid.innerHTML = '';
            mmCards.forEach((card) => {
                const div = document.createElement('div');
                div.className = "relative h-24 md:h-32 cursor-pointer perspective group";
                div.innerHTML = `
                    <div class="card-inner w-full h-full relative rounded-2xl shadow-md border border-slate-200">
                        <div class="card-back absolute inset-0 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center z-10">
                            <i class="fas fa-question text-white/50 text-2xl"></i>
                        </div>
                        <div class="card-face card-front absolute inset-0 bg-white rounded-2xl flex items-center justify-center p-2 text-center overflow-auto z-0">
                            <div class="${card.display} break-words w-full">${card.content}</div>
                        </div>
                    </div>`;
                div.onclick = () => handleMMClick(div, card);
                grid.appendChild(div);
            });
            if(window.MathJax) setTimeout(() => MathJax.typesetPromise(), 100);
        }

        function handleMMClick(el, card) {
            const inner = el.querySelector('.card-inner');
            if(mmLocked || inner.classList.contains('is-flipped') || el.classList.contains('matched')) return;
            
            inner.classList.add('is-flipped');
            mmFlipped.push({ el, card });

            if(mmFlipped.length === 2) {
                mmLocked = true;
                const [first, second] = mmFlipped;
                
                if(first.card.id === second.card.id && first.card.type !== second.card.type) {
                    setTimeout(() => {
                        first.el.classList.add('matched');
                        second.el.classList.add('matched');
                        first.el.style.visibility = 'hidden';
                        second.el.style.visibility = 'hidden';
                        mmFlipped = []; mmLocked = false;
                        mmMatches++;
                        document.getElementById('mmMatches').textContent = mmMatches;
                        if(mmMatches === 6) {
                            document.getElementById('mmGameOver').classList.remove('hidden');
                            // è…¦åŠ›é…å°çå‹µ
                            let current = window.loadCoins();
                            window.saveCoins(current + 20); // é€™è£¡çµ¦å›ºå®š 20 é‡‘å¹£
                        }
                    }, 600);
                } else {
                    setTimeout(() => {
                        first.el.querySelector('.card-inner').classList.remove('is-flipped');
                        second.el.querySelector('.card-inner').classList.remove('is-flipped');
                        mmFlipped = []; mmLocked = false;
                    }, 1000);
                }
            }
        }

        // ==========================================
        // âš”ï¸ éŠæˆ² 4: å‹‡è€…é¬¥æƒ¡é¾
        // ==========================================
        let rpgHp = 100, monsterHp = 100;
        function initRPG() {
            gameQuestions = generateGameQuestions(currentSubject, 20);
            if(!gameQuestions.length) { alert("ç„¡é¡Œç›®"); backToMenu(); return; }
            rpgHp = 100; monsterHp = 100; currentQIdx = 0;
            document.getElementById('heroHp').textContent = rpgHp;
            updateMonsterHp(100);
            renderRPGQuestion();
        }
        function updateMonsterHp(val) {
            monsterHp = Math.max(0, val);
            document.getElementById('monsterHpBar').style.width = monsterHp + '%';
            if(monsterHp === 0) { 
                alert("ğŸ‰ æ­å–œï¼ä½ æ“Šæ•—äº†æƒ¡é¾ï¼ç²å¾— 50 é‡‘å¹£ï¼"); 
                let current = window.loadCoins();
                window.saveCoins(current + 50);
                backToMenu(); 
            }
        }
        function renderRPGQuestion() {
            const q = gameQuestions[currentQIdx % gameQuestions.length];
            document.getElementById('rpgQuestion').innerHTML = q.question;
            const con = document.getElementById('rpgOptions'); con.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full py-3 bg-slate-50 border rounded-lg hover:bg-green-50 text-left px-4 font-bold text-slate-600";
                btn.innerHTML = opt;
                btn.onclick = () => {
                    let isCorrect = (typeof q.answer === 'number' ? idx === q.answer : opt === q.answer);
                    if(isCorrect) {
                        document.getElementById('rpgEffect').classList.remove('hidden');
                        setTimeout(() => document.getElementById('rpgEffect').classList.add('hidden'), 500);
                        updateMonsterHp(monsterHp - 20);
                        currentQIdx++; setTimeout(renderRPGQuestion, 600);
                    } else {
                        rpgHp -= 20; document.getElementById('heroHp').textContent = rpgHp;
                        btn.classList.add('bg-red-100');
                        if(rpgHp <= 0) { alert("ğŸ’€ å‹‡è€…å€’ä¸‹äº†..."); backToMenu(); }
                    }
                };
                con.appendChild(btn);
            });
            if(window.MathJax) MathJax.typesetPromise();
        }

        // ==========================================
        // ğŸ’£ éŠæˆ² 5: æ‹†å½ˆå°ˆå®¶
        // ==========================================
        let bombStreak = 0, bombTarget = 5, bombTimerValue = 10;
        function initDefuseBomb() {
            gameQuestions = generateGameQuestions(currentSubject, 20);
            if(!gameQuestions.length) { alert("ç„¡é¡Œç›®"); backToMenu(); return; }
            bombStreak = 0; bombTimerValue = 10; currentQIdx = 0;
            document.getElementById('bombExplosion').classList.add('hidden');
            document.getElementById('bombSuccess').classList.add('hidden');
            updateBombWires(); startBombTimer(); renderBombQuestion();
        }
        function startBombTimer() {
            if(timerInterval) clearInterval(timerInterval);
            bombTimerValue = 10; 
            document.getElementById('bombTimer').textContent = bombTimerValue;
            timerInterval = setInterval(() => {
                bombTimerValue--; 
                document.getElementById('bombTimer').textContent = bombTimerValue;
                if(bombTimerValue <= 0) { 
                    clearInterval(timerInterval); 
                    document.getElementById('bombExplosion').classList.remove('hidden'); 
                }
            }, 1000);
        }
        function updateBombWires() {
            const wires = document.getElementById('bombWires');
            wires.innerHTML = '';
            for(let i=0; i<bombTarget; i++) {
                const w = document.createElement('div');
                w.className = `w-8 h-2 rounded-full ${i < bombStreak ? 'bg-green-500' : 'bg-slate-600'}`;
                wires.appendChild(w);
            }
        }
        function renderBombQuestion() {
            const q = gameQuestions[currentQIdx % gameQuestions.length];
            document.getElementById('bombQuestion').innerHTML = q.question;
            const con = document.getElementById('bombOptions'); con.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "py-4 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-600";
                btn.innerHTML = opt;
                btn.onclick = () => {
                    let isCorrect = (typeof q.answer === 'number' ? idx === q.answer : opt === q.answer);
                    if(isCorrect) {
                        bombStreak++; updateBombWires();
                        if(bombStreak >= bombTarget) { 
                            clearInterval(timerInterval); 
                            document.getElementById('bombSuccess').classList.remove('hidden'); 
                            let current = window.loadCoins();
                            window.saveCoins(current + 30); // æ‹†å½ˆæˆåŠŸçå‹µ
                        }
                        else { currentQIdx++; startBombTimer(); renderBombQuestion(); }
                    } else { 
                        clearInterval(timerInterval); 
                        document.getElementById('bombExplosion').classList.remove('hidden'); 
                    }
                };
                con.appendChild(btn);
            });
            if(window.MathJax) MathJax.typesetPromise();
        }

        // ==========================================
        // ğŸ¯ éŠæˆ² 6: å¹¸é‹è½‰ç›¤
        // ==========================================
        let wheelScore = 0, currentMultiplier = 1;
        function initLuckyWheel() {
            gameQuestions = generateGameQuestions(currentSubject, 15);
            if(!gameQuestions.length) { alert("ç„¡é¡Œç›®"); backToMenu(); return; }
            wheelScore = 0; currentQIdx = 0;
            document.getElementById('wheelScore').textContent = 0;
            document.getElementById('wheelQuizArea').style.opacity = '0.5';
            document.getElementById('wheelQuizArea').style.pointerEvents = 'none';
            document.getElementById('spinBtn').disabled = false;
        }
        function spinWheel() {
            const wheel = document.getElementById('wheelCircle');
            const deg = 1800 + Math.random() * 360;
            wheel.style.transform = `rotate(${deg}deg)`;
            document.getElementById('spinBtn').disabled = true;
            setTimeout(() => {
                currentMultiplier = Math.floor(Math.random() * 5) + 1;
                document.getElementById('wheelMultiplier').textContent = `x${currentMultiplier}`;
                document.getElementById('wheelQuizArea').style.opacity = '1';
                document.getElementById('wheelQuizArea').style.pointerEvents = 'auto';
                renderWheelQuestion();
            }, 3000);
        }
        function renderWheelQuestion() {
            const q = gameQuestions[currentQIdx % gameQuestions.length];
            document.getElementById('wheelQuestion').innerHTML = q.question;
            const con = document.getElementById('wheelOptions'); con.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full py-2 bg-yellow-50 border border-yellow-200 rounded-lg text-slate-700 font-bold hover:bg-yellow-100";
                btn.innerHTML = opt;
                btn.onclick = () => {
                    let isCorrect = (typeof q.answer === 'number' ? idx === q.answer : opt === q.answer);
                    if(isCorrect) {
                        const points = 100 * currentMultiplier;
                        wheelScore += points;
                        document.getElementById('wheelScore').textContent = wheelScore;
                        alert(`ğŸ‰ ç­”å°ï¼ç²å¾— ${points} åˆ†`);
                        
                        // è½‰ç›¤é‡‘å¹£ï¼šæ¯ 1000 åˆ†çµ¦ 1 é‡‘å¹£
                        if(wheelScore % 1000 === 0) {
                             let current = window.loadCoins();
                             window.saveCoins(current + 1);
                        }
                    } else { alert("ğŸ’¥ ç­”éŒ¯äº†..."); }
                    currentQIdx++;
                    resetWheelState();
                };
                con.appendChild(btn);
            });
            if(window.MathJax) MathJax.typesetPromise();
        }
        function resetWheelState() {
            document.getElementById('wheelQuizArea').style.opacity = '0.5';
            document.getElementById('wheelQuizArea').style.pointerEvents = 'none';
            document.getElementById('spinBtn').disabled = false;
            document.getElementById('wheelCircle').style.transform = 'rotate(0deg)';
            document.getElementById('wheelMultiplier').textContent = 'x?';
            document.getElementById('wheelQuestion').textContent = 'è«‹å…ˆè½‰å‹•è½‰ç›¤...';
            document.getElementById('wheelOptions').innerHTML = '';
        }
    </script>
</body>
</html>
