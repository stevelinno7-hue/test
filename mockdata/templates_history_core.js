(function(global){
    'use strict';
    
    // 1. ç¢ºä¿å€‰åº«å­˜åœ¨
    window.__HISTORY_REPO__ = window.__HISTORY_REPO__ || {};

    console.log("ğŸ“œ [History V9.0] æ­·å²å·¥å» ï¼šæ­£åœ¨ç”Ÿç”¢è©¦é¡Œ...");

    // å·¥å…·å‡½å¼
    const U = { 
        shuffle: (arr) => arr.sort(() => Math.random() - 0.5)
    };

    // 2. è³‡æ–™åº« (çµ±ä¸€è®Šæ•¸åç¨±ç‚º historyData)
    const historyData = [
        // å°ç£å² (Taiwan)
        {e:"é•·æ¿±æ–‡åŒ–", k:"èˆŠçŸ³å™¨", tags:["å°ç£", "å²å‰", "èˆŠçŸ³å™¨"]}, 
        {e:"å¤§åŒå‘æ–‡åŒ–", k:"æ–°çŸ³å™¨", tags:["å°ç£", "å²å‰", "æ–°çŸ³å™¨"]}, 
        {e:"åä¸‰è¡Œæ–‡åŒ–", k:"é‡‘å±¬å™¨", tags:["å°ç£", "å²å‰", "é‡‘å±¬å™¨"]},
        {e:"ç†±è˜­é®åŸ", k:"è·è˜­", tags:["å°ç£", "è·è˜­"]}, 
        {e:"è–å¤šæ˜å“¥åŸ", k:"è¥¿ç­ç‰™", tags:["å°ç£", "è¥¿ç­ç‰™"]}, 
        {e:"å…¨å°é¦–å­¸", k:"é™³æ°¸è¯", tags:["å°ç£", "æ˜é„­"]},
        {e:"æ¸¡å°ç¦ä»¤", k:"æ¸…é ˜åˆæœŸ", tags:["å°ç£", "æ¸…é ˜"]}, 
        {e:"é–‹æ¸¯é€šå•†", k:"èŒ¶ç³–æ¨Ÿè…¦", tags:["å°ç£", "æ¸…é ˜"]}, 
        {e:"ç‰¡ä¸¹ç¤¾äº‹ä»¶", k:"æ—¥æœ¬ä¾µå°", tags:["å°ç£", "æ¸…é ˜"]},
        {e:"åŠ‰éŠ˜å‚³", k:"éµè·¯å»ºè¨­", tags:["å°ç£", "æ¸…é ˜"]}, 
        {e:"å…«ç”°èˆ‡ä¸€", k:"å˜‰å—å¤§åœ³", tags:["å°ç£", "æ—¥æ²»"]}, 
        {e:"çš‡æ°‘åŒ–", k:"æ”¹å§“å", tags:["å°ç£", "æ—¥æ²»"]},
        {e:"äºŒäºŒå…«", k:"å®˜é€¼æ°‘å", tags:["å°ç£", "æˆ°å¾Œ"]}, 
        {e:"ä¸‰ä¸ƒäº”æ¸›ç§Ÿ", k:"åœŸåœ°æ”¹é©", tags:["å°ç£", "æˆ°å¾Œ"]}, 
        {e:"åå¤§å»ºè¨­", k:"ç¶“æ¿Ÿèµ·é£›", tags:["å°ç£", "æˆ°å¾Œ"]},
        {e:"è§£åš´", k:"è”£ç¶“åœ‹", tags:["å°ç£", "æˆ°å¾Œ"]}, 
        {e:"é¦–æ¬¡æ”¿é»¨è¼ªæ›¿", k:"2000å¹´", tags:["å°ç£", "æˆ°å¾Œ"]},
        {e:"åŸä½æ°‘æ­£åé‹å‹•", k:"åŸæ¬Šæœƒ", tags:["å°ç£", "åŸä½æ°‘"]}, // è£œå¼·åŸä½æ°‘æ¨™ç±¤
        {e:"é«˜ç ‚æ—", k:"æ—¥æ²»æ™‚æœŸ", tags:["å°ç£", "åŸä½æ°‘", "æ—¥æ²»"]},

        // ä¸­åœ‹å² (China)
        {e:"ç§¦å§‹çš‡", k:"éƒ¡ç¸£åˆ¶", tags:["ä¸­åœ‹", "ç§¦æ¼¢"]}, 
        {e:"æ¼¢æ­¦å¸", k:"ç¨å°Šå„’è¡“", tags:["ä¸­åœ‹", "ç§¦æ¼¢"]}, 
        {e:"çµ²è·¯é–‹é€š", k:"å¼µé¨«", tags:["ä¸­åœ‹", "ç§¦æ¼¢"]},
        {e:"ä¸‰åœ‹é¼ç«‹", k:"èµ¤å£ä¹‹æˆ°", tags:["ä¸­åœ‹", "é­æ™‰å—åŒ—æœ"]}, 
        {e:"å”å¤ªå®—", k:"è²è§€ä¹‹æ²»", tags:["ä¸­åœ‹", "éš‹å”"]}, 
        {e:"æ­¦å‰‡å¤©", k:"å¥³çš‡å¸", tags:["ä¸­åœ‹", "éš‹å”"]},
        {e:"å®‹æœ", k:"é‡æ–‡è¼•æ­¦", tags:["ä¸­åœ‹", "å®‹å…ƒ"]}, 
        {e:"å…ƒæœ", k:"ç¨®æ—æ­§è¦–", tags:["ä¸­åœ‹", "å®‹å…ƒ"]}, 
        {e:"é„­å’Œä¸‹è¥¿æ´‹", k:"æ˜æœ", tags:["ä¸­åœ‹", "æ˜æ¸…"]},
        {e:"é›æ­£çš‡å¸", k:"è»æ©Ÿè™•", tags:["ä¸­åœ‹", "æ˜æ¸…"]}, 
        {e:"é´‰ç‰‡æˆ°çˆ­", k:"å—äº¬æ¢ç´„", tags:["ä¸­åœ‹", "æ™šæ¸…"]}, 
        {e:"å¤ªå¹³å¤©åœ‹", k:"æ´ªç§€å…¨", tags:["ä¸­åœ‹", "æ™šæ¸…"]},
        {e:"è‡ªå¼·é‹å‹•", k:"å¸«å¤·é•·æŠ€", tags:["ä¸­åœ‹", "æ™šæ¸…"]}, 
        {e:"ç”²åˆæˆ°çˆ­", k:"é¦¬é—œæ¢ç´„", tags:["ä¸­åœ‹", "æ™šæ¸…"]}, 
        {e:"è¾›äº¥é©å‘½", k:"å»ºç«‹æ°‘åœ‹", tags:["ä¸­åœ‹", "æ™šæ¸…"]},
        {e:"äº”å››é‹å‹•", k:"å¾·å…ˆç”Ÿè³½å…ˆç”Ÿ", tags:["ä¸­åœ‹", "æ°‘åœ‹"]}, 
        {e:"æ–‡åŒ–å¤§é©å‘½", k:"ç´…è¡›å…µ", tags:["ä¸­åœ‹", "ä¸­å…±"]},

        // ä¸–ç•Œå² (World)
        {e:"é‡‘å­—å¡”", k:"å¤åŸƒåŠ", tags:["ä¸–ç•Œ", "ä¸Šå¤"]}, 
        {e:"æ¼¢æ‘©æ‹‰æ¯”æ³•å…¸", k:"å…©æ²³æµåŸŸ", tags:["ä¸–ç•Œ", "ä¸Šå¤"]}, 
        {e:"ç¨®å§“åˆ¶åº¦", k:"å¤å°åº¦", tags:["ä¸–ç•Œ", "ä¸Šå¤"]},
        {e:"å¥§æ—åŒ¹å…‹", k:"å¤å¸Œè‡˜", tags:["ä¸–ç•Œ", "ä¸Šå¤"]}, 
        {e:"åäºŒè¡¨æ³•", k:"å¤ç¾…é¦¬", tags:["ä¸–ç•Œ", "ä¸Šå¤"]}, 
        {e:"åå­—è»æ±å¾", k:"å®—æ•™æˆ°çˆ­", tags:["ä¸–ç•Œ", "ä¸­å¤"]},
        {e:"é»‘æ­»ç—…", k:"ä¸­ä¸–ç´€", tags:["ä¸–ç•Œ", "ä¸­å¤"]}, 
        {e:"æ–‡è—å¾©èˆˆ", k:"ç¾©å¤§åˆ©", tags:["ä¸–ç•Œ", "è¿‘ä»£"]}, 
        {e:"å®—æ•™æ”¹é©", k:"é¦¬ä¸è·¯å¾·", tags:["ä¸–ç•Œ", "è¿‘ä»£"]},
        {e:"å“¥å€«å¸ƒ", k:"ç™¼ç¾æ–°å¤§é™¸", tags:["ä¸–ç•Œ", "åœ°ç†å¤§ç™¼ç¾"]}, 
        {e:"å·¥æ¥­é©å‘½", k:"è’¸æ±½æ©Ÿ", tags:["ä¸–ç•Œ", "è¿‘ä»£"]}, 
        {e:"æ³•åœ‹å¤§é©å‘½", k:"æ‹¿ç ´å´™", tags:["ä¸–ç•Œ", "è¿‘ä»£"]},
        {e:"ç¬¬ä¸€æ¬¡å¤§æˆ°", k:"å‡¡çˆ¾è³½æ¢ç´„", tags:["ä¸–ç•Œ", "ç¾ä»£"]}, 
        {e:"ç¶“æ¿Ÿå¤§ææ…Œ", k:"ç¾…æ–¯ç¦æ–°æ”¿", tags:["ä¸–ç•Œ", "ç¾ä»£"]}, 
        {e:"ç¬¬äºŒæ¬¡å¤§æˆ°", k:"åŸå­å½ˆ", tags:["ä¸–ç•Œ", "ç¾ä»£"]},
        {e:"å†·æˆ°", k:"æŸæ—åœç‰†", tags:["ä¸–ç•Œ", "ç¾ä»£"]}
    ];

    // 3. ç”Ÿç”¢é¡Œç›® (ä¿®å¾©è¿´åœˆé‚è¼¯)
    let count = 0;
    historyData.forEach((item, i) => {
        const id = `hist_fix_${i}`;
        // ç¢ºä¿æ¨™ç±¤åŒ…å«åŸºæœ¬é—œéµå­—ï¼Œè®“æœå°‹æ›´å®¹æ˜“å‘½ä¸­
        const finalTags = ["history", "æ­·å²", "ç¤¾æœƒ", "åœ‹ä¸ƒ", "åœ‹å…«", "åœ‹ä¹", ...(item.tags || [])];
        
        window.__HISTORY_REPO__[id] = {
            func: () => {
                // å¾è³‡æ–™åº«ä¸­éš¨æ©ŸæŠ“å– 3 å€‹éŒ¯èª¤ç­”æ¡ˆ (ä¸åŒ…å«æ­£ç¢ºç­”æ¡ˆ)
                // ç‚ºäº†é¿å… crashï¼Œé€™è£¡åŠ äº†ä¿è­·æ©Ÿåˆ¶
                const distractorPool = historyData.filter(x => x.k !== item.k);
                const wr = U.shuffle(distractorPool).slice(0, 3).map(x => x.k);
                
                // çµ„åˆé¸é …
                const opts = U.shuffle([item.k, ...wr]);
                
                return { 
                    question: `ã€æ­·å²ã€‘èˆ‡ã€Œ${item.e}ã€æœ€ç›¸é—œçš„é—œéµè©æ˜¯ï¼Ÿ`, 
                    options: opts, 
                    answer: opts.indexOf(item.k), 
                    explanation: [`é—œéµè©å°æ‡‰ï¼š${item.e} â ${item.k}`, `æ™‚ä»£/åˆ†é¡ï¼š${(item.tags||[]).join('/')}`], 
                    subject: "history", 
                    tags: finalTags 
                };
            }, 
            tags: finalTags, 
            subject: "history"
        };
        count++;
    });

    console.log(`âœ… [History V9.0] æ­·å²é¡Œåº«ä¿®å¾©å®Œæˆï¼å…±è¼‰å…¥ ${count} é¡Œï¼Œå·²å­˜å…¥ window.__HISTORY_REPO__`);

})(window);
