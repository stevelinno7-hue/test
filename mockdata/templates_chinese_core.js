(function(global){
    'use strict';

    // ------------------------------------------------------------------
    //  V7.5 æ ¸å¿ƒä¿®å¾©ï¼šæ›´å¼·å¤§çš„å¼•æ“åµæ¸¬èˆ‡åƒæ•¸å…¼å®¹ (Argument Compatibility)
    // ------------------------------------------------------------------
    function init() {
        // 1. å¼·åŠ›æœå°‹æ‰€æœ‰å¯èƒ½çš„å¼•æ“åç¨±
        const G = window.RigorousGenerator || window.GeneratorEngine || window.PaperGenerator || (window.global && window.global.RigorousGenerator);
        
        // è‹¥æ‰¾ä¸åˆ°å¼•æ“ï¼ŒæŒçºŒé‡è©¦ (æ¯ 100ms ä¸€æ¬¡)
        if (!G || typeof G.registerTemplate !== 'function') { 
            console.log("â³ ç­‰å¾… Generator Engine å°±ç·’...");
            setTimeout(init, 100); 
            return; 
        }

        // ==========================================
        // åœ‹æ–‡ç§‘æ ¸å¿ƒè³‡æ–™åº« (Chinese Core Database)
        // ==========================================
        const chiData = [
            // 1. æˆèªåˆ¤è®€
            { q: "ç™½é§’ééš™", a: "å½¢å®¹æ™‚é–“éå¾—å¾ˆå¿«", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "æŒ‡é¹¿ç‚ºé¦¬", a: "æ¯”å–»æ··æ·†æ˜¯é", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "ç•«è›‡æ·»è¶³", a: "æ¯”å–»å¤šæ­¤ä¸€èˆ‰", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "æ¯å¼“è›‡å½±", a: "æ¯”å–»ç–‘ç¥ç–‘é¬¼ï¼Œè‡ªç›¸é©šæ“¾", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "ç­é–€å¼„æ–§", a: "åœ¨è¡Œå®¶é¢å‰è³£å¼„æœ¬äº‹", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "å¦‚ç«å¦‚è¼", a: "å½¢å®¹æ°£å‹¢æ—ºç››æˆ–æ°£æ°›ç†±çƒˆ", tag: ["åœ‹å…«","æˆèª"] },
            { q: "æ«›é¢¨æ²é›¨", a: "å½¢å®¹å¥”æ³¢å‹ç¢Œï¼Œä¸é¿é¢¨é›¨", tag: ["åœ‹å…«","æˆèª"] },
            { q: "éŸ‹ç·¨ä¸‰çµ•", a: "å½¢å®¹è®€æ›¸å‹¤å¥®", tag: ["åœ‹å…«","æˆèª"] },
            { q: "ä¸‰ä»¤äº”ç”³", a: "å†ä¸‰å‘½ä»¤å‘Šèª¡", tag: ["åœ‹å…«","æˆèª"] },
            { q: "ç ´é‡œæ²ˆèˆŸ", a: "æ¯”å–»åšäº‹æœæ±ºï¼Œç¾©ç„¡åé¡§", tag: ["åœ‹ä¹","æˆèª"] },
            { q: "è‡¥è–ªå˜—è†½", a: "åˆ»è‹¦è‡ªå‹µï¼Œç™¼æ†¤åœ–å¼·", tag: ["åœ‹ä¹","æˆèª"] },
            { q: "ç½„ç«¹é›£æ›¸", a: "å½¢å®¹ç½ªæƒ¡æ¥µå¤šï¼Œç„¡æ³•å¯«ç›¡", tag: ["åœ‹ä¹","æˆèª"] },
            
            // 2. ä¿®è¾­æŠ€å·§
            { q: "ç™½é«®ä¸‰åƒä¸ˆï¼Œç·£æ„ä¼¼å€‹é•·", a: "èª‡é£¾", tag: ["åœ‹å…«","ä¿®è¾­"] },
            { q: "æ„Ÿæ™‚èŠ±æ¿ºæ·šï¼Œæ¨åˆ¥é³¥é©šå¿ƒ", a: "è½‰åŒ–(æ“¬äºº)", tag: ["åœ‹å…«","ä¿®è¾­"] },
            { q: "é‚£é›ªç™½çš„ç¾½æ¯›ï¼Œåƒæ˜¯å¤©ä½¿çš„ç¿…è†€", a: "è­¬å–»(æ˜å–»)", tag: ["åœ‹ä¸ƒ","ä¿®è¾­"] },
            { q: "å±å±å–³å–³çš„éº»é›€", a: "æ‘¹å¯«(è½è¦º)", tag: ["åœ‹ä¸ƒ","ä¿®è¾­"] },
            { q: "åœ¨å¤©é¡˜ä½œæ¯”ç¿¼é³¥ï¼Œåœ¨åœ°é¡˜ç‚ºé€£ç†æ", a: "å°å¶", tag: ["åœ‹ä¹","ä¿®è¾­"] },
            { q: "çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚æ¨‚ä¹‹è€…", a: "å±¤é", tag: ["åœ‹å…«","ä¿®è¾­"] },
            { q: "å€Ÿå•é…’å®¶ä½•è™•æœ‰ï¼Ÿç‰§ç«¥é™æŒ‡æèŠ±æ‘", a: "è¨­å•(æå•)", tag: ["åœ‹å…«","ä¿®è¾­"] },
            
            // 3. åœ‹å­¸å¸¸è­˜ & å…­æ›¸
            { q: "è±¡å½¢", a: "ç•«æˆå…¶ç‰©ï¼Œéš¨é«”è©°è©˜ (å¦‚ï¼šæ—¥ã€æœˆ)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "æŒ‡äº‹", a: "è¦–è€Œå¯è­˜ï¼Œå¯Ÿè€Œè¦‹æ„ (å¦‚ï¼šä¸Šã€ä¸‹)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "æœƒæ„", a: "æ¯”é¡åˆèª¼ï¼Œä»¥è¦‹æŒ‡æ’ (å¦‚ï¼šä¼‘ã€æ­¦)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "å½¢è²", a: "ä»¥äº‹ç‚ºåï¼Œå–è­¬ç›¸æˆ (å¦‚ï¼šæ±Ÿã€æ²³)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "è€Œç«‹ä¹‹å¹´", a: "30æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "ä¸æƒ‘ä¹‹å¹´", a: "40æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "çŸ¥å‘½ä¹‹å¹´", a: "50æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "è€³é †ä¹‹å¹´ / èŠ±ç”²", a: "60æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "å¤ç¨€ä¹‹å¹´", a: "70æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },

            // 4. ç¶“å…¸å¤æ–‡
            { q: "å­¸è€Œæ™‚ç¿’ä¹‹ï¼Œä¸äº¦èªªä¹", a: "è«–èª (å­”å­å¼Ÿå­)", tag: ["åœ‹ä¸ƒ","å¤æ–‡"] },
            { q: "ä¸‰äººè¡Œï¼Œå¿…æœ‰æˆ‘å¸«ç„‰", a: "è«–èª (å¼·èª¿å­¸ç¿’)", tag: ["åœ‹ä¸ƒ","å¤æ–‡"] },
            { q: "æ¡ƒèŠ±æºè¨˜", a: "é™¶æ·µæ˜ (æ±æ™‰ï¼Œç†æƒ³ä¸–ç•Œ)", tag: ["åœ‹ä¹","å¤æ–‡"] },
            { q: "ä¸–èªªæ–°èª", a: "åŠ‰ç¾©æ…¶ (ç­†è¨˜å°èªªï¼Œé­æ™‰é¢¨åº¦)", tag: ["åœ‹å…«","å¤æ–‡"] },
            { q: "èˆ‰é ­æœ›æ˜æœˆï¼Œä½é ­æ€æ•…é„‰", a: "æç™½ (éœå¤œæ€)", tag: ["åœ‹ä¸ƒ","å”è©©"] },
            { q: "ç™»é¸›é›€æ¨“", a: "ç‹ä¹‹æ¸™ (ç››å”é‚Šå¡)", tag: ["åœ‹ä¸ƒ","å”è©©"] },
            { q: "åœ‹ç ´å±±æ²³åœ¨ï¼ŒåŸæ˜¥è‰æœ¨æ·±", a: "æœç”« (æ˜¥æœ›ï¼Œæ„Ÿæ™‚æ†‚åœ‹)", tag: ["åœ‹å…«","å”è©©"] },
            { q: "æ…ˆæ¯æ‰‹ä¸­ç·šï¼ŒéŠå­èº«ä¸Šè¡£", a: "å­ŸéƒŠ (éŠå­åŸ)", tag: ["åœ‹ä¸ƒ","å”è©©"] },
            
            // 5. ç¾ä»£æ–‡å­¸
            { q: "èƒŒå½±", a: "æœ±è‡ªæ¸… (çˆ¶æ„›)", tag: ["åœ‹ä¸ƒ","ç¾ä»£æ–‡"] },
            { q: "é›…é‡", a: "å®‹æ™¶å®œ (åŒ…å®¹å°Šé‡)", tag: ["åœ‹ä¸ƒ","ç¾ä»£æ–‡"] },
            { q: "ç´™èˆ¹å°è±¡", a: "æ´ªé†’å¤« (æ¯æ„›)", tag: ["åœ‹ä¸ƒ","ç¾ä»£æ–‡"] },
            { q: "è² è·", a: "å³æ™Ÿ (ç”œèœœçš„è² è·)", tag: ["åœ‹å…«","ç¾ä»£æ–‡"] }
        ];

        // æ•´ç†çµ„åˆ
        const combinations = new Set();
        chiData.forEach(item => {
            if(item.tag && item.tag.length >= 2) {
                combinations.add(`${item.tag[0].trim()}_${item.tag[1].trim()}`);
            }
        });

        // è¨»å†Šæ¨¡æ¿
        combinations.forEach(combo => {
            const [grade, topic] = combo.split('_');
            const pool = chiData.filter(q => q.tag[0].trim() === grade && q.tag[1].trim() === topic);

            if (pool.length > 0) {
                // æ¨™ç±¤è™•ç†ï¼šå…¨éƒ¨è½‰å°å¯«ä»¥é˜²å¤§å°å¯«ä¸åŒ¹é…
                const rawTags = ["chinese", topic, grade, "åœ‹æ–‡", "èªæ–‡"];
                const uniqueTags = [...new Set(rawTags)];

                // ç”¢ç”Ÿå™¨å‡½æ•¸ (èˆ‡ V7.4 ç›¸åŒï¼Œä½† return ç‰©ä»¶çµæ§‹å¢å¼·)
                const generatorFunc = (ctx, rnd) => {
                    const item = pool[Math.floor(Math.random() * pool.length)];
                    const others = chiData.filter(x => x.tag[1] === topic && x.q !== item.q);
                    
                    // é¸é …æ··æ·†
                    const wrongOpts = others.sort(() => 0.5 - Math.random()).slice(0, 3).map(x => x.a);
                    while(wrongOpts.length < 3) wrongOpts.push("ä»¥ä¸Šçš†é");
                    
                    const opts = [item.a, ...wrongOpts].sort(() => 0.5 - Math.random());
                    
                    let qText = topic === "æˆèª" ? `ã€Œ${item.q}ã€çš„æ„æ€ç‚ºä½•ï¼Ÿ` : 
                               topic === "ä¿®è¾­" ? `ã€Œ${item.q}ã€ä½¿ç”¨äº†å“ªç¨®ä¿®è¾­ï¼Ÿ` :
                               topic === "å¤æ–‡" ? `ã€Œ${item.q}ã€å‡ºè‡ªä½•è™•æˆ–ä½•äººï¼Ÿ` :
                               `é—œæ–¼ã€Œ${item.q}ã€ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ`;

                    return {
                        question: `ã€${topic}ã€‘${qText}`,
                        options: opts,
                        answer: opts.indexOf(item.a),
                        concept: topic,
                        explanation: [`æ­£ç¢ºç­”æ¡ˆï¼š${item.a}`],
                        // â˜… V7.5 é›™é‡ä¿éšªï¼šåŒæ™‚åœ¨æ ¹ç›®éŒ„èˆ‡ meta æä¾› Subject â˜…
                        subject: "chinese",
                        tags: uniqueTags,
                        meta: { subject: "chinese", grade: grade, topic: topic }
                    };
                };

                // â˜…â˜…â˜… V7.5 é—œéµä¿®æ­£ï¼šåŒæ™‚æ”¯æ´ã€Œé™£åˆ—ã€èˆ‡ã€Œå±•é–‹ã€è¨»å†Šæ¨¡å¼ â˜…â˜…â˜…
                // é€™æ˜¯ç‚ºäº†è§£æ±º GeneratorEngine åƒæ•¸ä¸åŒ¹é…å°è‡´æ¨™ç±¤å¤±æ•ˆçš„ä¸»å› 
                try {
                    // å˜—è©¦æ¨¡å¼ A: å‚³éé™£åˆ— (Modern)
                    G.registerTemplate(`chi_def_${grade}_${topic}`, generatorFunc, uniqueTags);
                    
                    // å˜—è©¦æ¨¡å¼ B: å‚³éå±•é–‹åƒæ•¸ (Legacy) - ä»¥é˜²ç³»çµ±ä½¿ç”¨èˆŠç‰ˆå¼•æ“
                    // æ³¨æ„ï¼šé€™ä¸æœƒå ±éŒ¯ï¼Œå¦‚æœ ID é‡è¤‡ï¼Œé€šå¸¸å¼•æ“æœƒè¦†è“‹æˆ–å¿½ç•¥ï¼Œé€™æ˜¯å®‰å…¨çš„
                    if (G.registerTemplate.length > 2) { 
                        G.registerTemplate(`chi_def_legacy_${grade}_${topic}`, generatorFunc, ...uniqueTags);
                    }
                } catch (e) {
                    console.error("Template Reg Error:", e);
                }
            }
        });

        console.log(`ğŸ‰ åœ‹æ–‡é¡Œåº« (V7.5 Universal Fix) å·²è¼‰å…¥ï¼è¨»å†Š ${combinations.size} çµ„æ¨¡æ¿ã€‚`);
        
        // é¡å¤–è¨ºæ–·è¨Šæ¯
        if (window.PaperGenerator) {
             console.log("ğŸ” PaperGenerator ç‹€æ…‹æª¢æŸ¥:", 
                "Registered count:", Object.keys(window.RigorousGenerator?.templates || {}).length,
                "Has Chinese Tag?", JSON.stringify(uniqueTags || "N/A")
             );
        }
    }

    init();
})(window);
