(function(global){
    'use strict';
    const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
    if (!G) return;
    const { pick, shuffle } = G.utils;

    // ==========================================
    // 國文科核心資料庫 (Chinese Core Database)
    // ==========================================
    const chiData = [
        // ------------------------------------------
        // 1. 成語判讀 (Idioms)
        // ------------------------------------------
        { q: "白駒過隙", a: "形容時間過得很快", tag: ["國七","成語"] },
        { q: "指鹿為馬", a: "比喻混淆是非", tag: ["國七","成語"] },
        { q: "畫蛇添足", a: "比喻多此一舉", tag: ["國七","成語"] },
        { q: "杯弓蛇影", a: "比喻疑神疑鬼，自相驚擾", tag: ["國七","成語"] },
        { q: "班門弄斧", a: "在行家面前賣弄本事", tag: ["國七","成語"] },
        { q: "如火如荼", a: "形容氣勢旺盛或氣氛熱烈", tag: ["國八","成語"] },
        { q: "櫛風沐雨", a: "形容奔波勞碌，不避風雨", tag: ["國八","成語"] },
        { q: "韋編三絕", a: "形容讀書勤奮", tag: ["國八","成語"] },
        { q: "三令五申", a: "再三命令告誡", tag: ["國八","成語"] },
        { q: "破釜沈舟", a: "比喻做事果決，義無反顧", tag: ["國九","成語"] },
        { q: "臥薪嘗膽", a: "刻苦自勵，發憤圖強", tag: ["國九","成語"] },
        { q: "罄竹難書", a: "形容罪惡極多，無法寫盡", tag: ["國九","成語"] },
        { q: "明日黃花", a: "比喻過時的事物", tag: ["高一","成語"] },
        { q: "罪不容誅", a: "罪大惡極，處死都不足以抵償", tag: ["高一","成語"] },
        { q: "文不加點", a: "形容文思敏捷，下筆成章", tag: ["高一","成語"] },
        { q: "七月流火", a: "形容天氣轉涼", tag: ["高二","成語"] },
        { q: "不刊之論", a: "確鑿不移、不可更動的言論", tag: ["高二","成語"] },
        { q: "瓜田李下", a: "比喻容易引起嫌疑的場合", tag: ["高二","成語"] },
        { q: "南轅北轍", a: "比喻行動和目的彼此背道而馳", tag: ["高二","成語"] },
        { q: "滄海桑田", a: "比喻世事變化巨大", tag: ["高三","成語"] },
        { q: "管窺蠡測", a: "比喻見識狹窄", tag: ["高三","成語"] },
        { q: "暴虎馮河", a: "比喻有勇無謀", tag: ["高三","成語"] },
        { q: "緣木求魚", a: "比喻方法錯誤，徒勞無功", tag: ["高三","成語"] },
        { q: "飲鴆止渴", a: "比喻只求解決眼前困難，不顧後患", tag: ["高三","成語"] },
        { q: "按圖索驥", a: "比喻做事拘泥成規，不知變通", tag: ["高三","成語"] },
        { q: "汗牛充棟", a: "形容書籍極多", tag: ["高三","成語"] },
        { q: "美輪美奐", a: "形容房屋高大華麗", tag: ["高三","成語"] },
        { q: "亦步亦趨", a: "比喻事事模仿或追隨別人", tag: ["高三","成語"] },
        
        // ------------------------------------------
        // 2. 修辭技巧 (Rhetoric)
        // ------------------------------------------
        { q: "白髮三千丈，緣愁似個長", a: "誇飾", tag: ["國八","修辭"] },
        { q: "感時花濺淚，恨別鳥驚心", a: "轉化(擬人)", tag: ["國八","修辭"] },
        { q: "那雪白的羽毛，像是天使的翅膀", a: "譬喻(明喻)", tag: ["國七","修辭"] },
        { q: "吱吱喳喳的麻雀", a: "摹寫(聽覺)", tag: ["國七","修辭"] },
        { q: "微風過處，送來縷縷清香，彷彿遠處高樓上渺茫的歌聲", a: "移覺(通感)", tag: ["高一","修辭"] },
        { q: "在天願作比翼鳥，在地願為連理枝", a: "對偶", tag: ["國九","修辭"] },
        { q: "知之者不如好之者，好之者不如樂之者", a: "層遞", tag: ["國八","修辭"] },
        { q: "雄兔腳撲朔，雌兔眼迷離", a: "互文", tag: ["高一","修辭"] },
        { q: "主人下馬客在船", a: "互文", tag: ["高一","修辭"] },
        { q: "借問酒家何處有？牧童遙指杏花村", a: "設問(提問)", tag: ["國八","修辭"] },
        { q: "聰明人！你告訴我，我們的日子為什麼一去不復返呢？", a: "設問(激問)", tag: ["國九","修辭"] },
        { q: "我達達的馬蹄是美麗的錯誤", a: "映襯", tag: ["高二","修辭"] },
        { q: "是誰多事種芭蕉？早也瀟瀟，晚也瀟瀟", a: "類疊", tag: ["國九","修辭"] },
        { q: "何以解憂？唯有杜康", a: "借代(酒)", tag: ["高二","修辭"] },
        { q: "朱門酒肉臭，路有凍死骨", a: "借代(富貴人家)", tag: ["高二","修辭"] },
        { q: "一語天然萬古新，豪華落盡見真淳", a: "映襯", tag: ["高三","修辭"] },
        { q: "孤帆遠影碧山盡", a: "借代(船)", tag: ["國七","修辭"] },
        { q: "粉身碎骨渾不怕，要留清白在人間", a: "雙關(石灰/人品)", tag: ["國九","修辭"] },
        { q: "東邊日出西邊雨，道是無晴卻有晴", a: "雙關(晴/情)", tag: ["國九","修辭"] },

        // ------------------------------------------
        // 3. 國學常識 (Culture & Knowledge)
        // ------------------------------------------
        { q: "象形", a: "畫成其物，隨體詰詘 (如：日、月)", tag: ["國八","六書"] },
        { q: "指事", a: "視而可識，察而見意 (如：上、下)", tag: ["國八","六書"] },
        { q: "會意", a: "比類合誼，以見指撝 (如：休、武)", tag: ["國八","六書"] },
        { q: "形聲", a: "以事為名，取譬相成 (如：江、河)", tag: ["國八","六書"] },
        { q: "而立之年", a: "30歲", tag: ["國七","年齡"] },
        { q: "不惑之年", a: "40歲", tag: ["國七","年齡"] },
        { q: "知命之年", a: "50歲", tag: ["國七","年齡"] },
        { q: "耳順之年 / 花甲", a: "60歲", tag: ["國七","年齡"] },
        { q: "古稀之年", a: "70歲", tag: ["國七","年齡"] },
        { q: "弱冠", a: "男子20歲", tag: ["高一","年齡"] },
        { q: "及笄", a: "女子15歲", tag: ["高一","年齡"] },
        { q: "束脩", a: "送給老師的見面禮(肉乾)", tag: ["國九","禮俗"] },
        { q: "椿萱並茂", a: "祝賀父母健在", tag: ["高一","題辭"] },
        { q: "杏林春暖", a: "稱讚醫生醫術高明", tag: ["高一","題辭"] },
        { q: "桃李滿門", a: "稱讚老師學生眾多", tag: ["高一","題辭"] },
        { q: "弄璋之喜", a: "賀生子", tag: ["高二","題辭"] },
        { q: "弄瓦之喜", a: "賀生女", tag: ["高二","題辭"] },
        { q: "詩經", a: "中國最早的詩歌總集，北方文學", tag: ["高一","經典"] },
        { q: "楚辭", a: "中國最早的辭賦總集，南方文學", tag: ["高一","經典"] },
        { q: "史記", a: "司馬遷，第一部紀傳體通史", tag: ["高二","史書"] },
        { q: "漢書", a: "班固，第一部紀傳體斷代史", tag: ["高二","史書"] },
        { q: "資治通鑑", a: "司馬光，編年體通史", tag: ["高二","史書"] },

        // ------------------------------------------
        // 4. 經典古文與詩詞 (Literature)
        // ------------------------------------------
        // 先秦
        { q: "學而時習之，不亦說乎", a: "論語 (孔子弟子)", tag: ["國七","古文"] },
        { q: "三人行，必有我師焉", a: "論語 (強調學習)", tag: ["國七","古文"] },
        { q: "緣木求魚", a: "孟子 (梁惠王上)", tag: ["高一","古文"] },
        { q: "以五十步笑百步", a: "孟子 (比喻缺點相同)", tag: ["高一","古文"] },
        { q: "勸學", a: "荀子 (性惡論，強調後天學習)", tag: ["高二","古文"] },
        { q: "燭之武退秦師", a: "左傳 (外交辭令)", tag: ["高一","古文"] },
        { q: "諫逐客書", a: "李斯 (秦代，實用文)", tag: ["高二","古文"] },
        { q: "大同與小康", a: "禮記 (政治理想)", tag: ["高一","古文"] },
        
        // 漢魏六朝
        { q: "出師表", a: "諸葛亮 (三國，忠君愛國)", tag: ["高二","古文"] },
        { q: "桃花源記", a: "陶淵明 (東晉，理想世界)", tag: ["國九","古文"] },
        { q: "世說新語", a: "劉義慶 (筆記小說，魏晉風度)", tag: ["國八","古文"] },
        { q: "蘭亭集序", a: "王羲之 (天下第一行書)", tag: ["高二","古文"] },
        { q: "典論論文", a: "曹丕 (文學批評)", tag: ["高三","古文"] },
        
        // 唐宋
        { q: "師說", a: "韓愈 (文以載道，尊師重道)", tag: ["高一","古文"] },
        { q: "師者，所以傳道、受業、解惑也", a: "韓愈", tag: ["高一","古文"] },
        { q: "始得西山宴遊記", a: "柳宗元 (永州八記)", tag: ["高二","古文"] },
        { q: "岳陽樓記", a: "范仲淹 (先憂後樂)", tag: ["高三","古文"] },
        { q: "先天下之憂而憂，後天下之樂而樂", a: "范仲淹", tag: ["高三","古文"] },
        { q: "醉翁亭記", a: "歐陽脩 (與民同樂)", tag: ["高二","古文"] },
        { q: "赤壁賦", a: "蘇軾 (被貶黃州，豁達人生)", tag: ["高一","古文"] },
        { q: "寄蜉蝣於天地，渺滄海之一粟", a: "蘇軾 (赤壁賦)", tag: ["高一","古文"] },
        { q: "廉恥", a: "顧炎武 (強調士大夫氣節)", tag: ["高一","古文"] },
        { q: "晚遊六橋待月記", a: "袁宏道 (獨抒性靈)", tag: ["高一","古文"] },
        { q: "項脊軒志", a: "歸有光 (親情散文)", tag: ["高二","古文"] },
        { q: "左忠毅公軼事", a: "方苞 (桐城派，師生情操)", tag: ["高二","古文"] },
        { q: "琵琶行", a: "白居易 (同是天涯淪落人)", tag: ["高一","古文"] },
        { q: "夢溪筆談", a: "沈括 (科技百科)", tag: ["國八","古文"] },
        
        // 詩詞曲
        { q: "舉頭望明月，低頭思故鄉", a: "李白 (靜夜思)", tag: ["國七","唐詩"] },
        { q: "登鸛雀樓", a: "王之渙 (盛唐邊塞)", tag: ["國七","唐詩"] },
        { q: "國破山河在，城春草木深", a: "杜甫 (春望，感時憂國)", tag: ["國八","唐詩"] },
        { q: "慈母手中線，遊子身上衣", a: "孟郊 (遊子吟)", tag: ["國七","唐詩"] },
        { q: "行到水窮處，坐看雲起時", a: "王維 (終南別業，山水田園)", tag: ["國九","唐詩"] },
        { q: "大江東去，浪淘盡，千古風流人物", a: "蘇軾 (念奴嬌，豪放派)", tag: ["高二","宋詞"] },
        { q: "尋尋覓覓，冷冷清清，悽悽慘慘戚戚", a: "李清照 (聲聲慢，婉約派)", tag: ["高二","宋詞"] },
        { q: "枯藤老樹昏鴉，小橋流水人家", a: "馬致遠 (天淨沙，元曲)", tag: ["國九","元曲"] },
        { q: "一騎紅塵妃子笑，無人知是荔枝來", a: "杜牧 (詠史)", tag: ["高二","唐詩"] },

        // ------------------------------------------
        // 5. 現代文學 (Modern Literature)
        // ------------------------------------------
        { q: "背影", a: "朱自清 (父愛)", tag: ["國七","現代文"] },
        { q: "雅量", a: "宋晶宜 (包容尊重)", tag: ["國七","現代文"] },
        { q: "紙船印象", a: "洪醒夫 (母愛)", tag: ["國七","現代文"] },
        { q: "負荷", a: "吳晟 (甜蜜的負荷)", tag: ["國八","現代文"] },
        { q: "那默默的一群", a: "張騰蛟 (清道夫)", tag: ["國八","現代文"] },
        { q: "孔乙己", a: "魯迅 (科舉制度毒害)", tag: ["高一","現代文"] },
        { q: "再別康橋", a: "徐志摩 (新月派)", tag: ["高一","現代文"] },
        { q: "錯誤 (我達達的馬蹄)", a: "鄭愁予 (浪子情懷)", tag: ["高二","現代文"] },
        { q: "髻", a: "琦君 (懷舊散文)", tag: ["高二","現代文"] },
        { q: "狼之獨步", a: "紀弦 (現代詩)", tag: ["高三","現代文"] },
        { q: "一桿稱仔", a: "賴和 (台灣新文學之父)", tag: ["高三","現代文"] },
        { q: "壓不扁的玫瑰", a: "楊逵 (抗日精神)", tag: ["高三","現代文"] }
    ];

    
    // ------------------------------------------
    G.registerTemplate('chi_definition', (ctx, rnd) => {
        const item = pick(chiData);
        const sameCat = chiData.filter(x => x.tag[1] === item.tag[1] && x.q !== item.q);
        const pool = sameCat.length >= 3 ? sameCat : chiData.filter(x => x.q !== item.q);
        const wrongOpts = shuffle(pool).slice(0, 3).map(x => x.a);
        const opts = shuffle([item.a, ...wrongOpts]);

        let qText = "";
        // 根據類型調整問法
        if(item.tag[1] === "成語") qText = `【成語】「${item.q}」的意思為何？`;
        else if(item.tag[1] === "修辭") qText = `【修辭】「${item.q}」這句話運用了哪種修辭技巧？`;
        else if(item.tag[1] === "古文" || item.tag[1] === "唐詩") qText = `【文學】「${item.q}」這句話出自何處或何人？`;
        else qText = `【${item.tag[1]}】關於「${item.q}」，下列敘述何者正確？`;

        return {
            question: qText,
            options: opts,
            answer: opts.indexOf(item.a),
            concept: item.tag[1],
            explanation: [`答案：${item.a}`]
        };
    }, ["國文", "語文"]);

    // ------------------------------------------
    // 模板 2: 反向題 (判讀)
    // ------------------------------------------
    G.registerTemplate('chi_reverse', (ctx, rnd) => {
        const item = pick(chiData);
        const sameCat = chiData.filter(x => x.tag[1] === item.tag[1] && x.q !== item.q);
        const pool = sameCat.length >= 3 ? sameCat : chiData.filter(x => x.q !== item.q);
        const wrongOpts = shuffle(pool).slice(0, 3).map(x => x.q);
        const opts = shuffle([item.q, ...wrongOpts]);

        let qText = "";
        if(item.tag[1] === "成語") qText = `【成語】下列哪一個成語的意思是「${item.a}」？`;
        else if(item.tag[1] === "修辭") qText = `【修辭】下列哪一個句子使用了「${item.a}」法？`;
        else if(item.tag[1] === "古文" || item.tag[1] === "現代文") qText = `【文學】下列何者是「${item.a}」的作品或名句？`;
        else qText = `【${item.tag[1]}】下列何者符合「${item.a}」的描述？`;

        return {
            question: qText,
            options: opts,
            answer: opts.indexOf(item.q),
            concept: item.tag[1],
            explanation: [`「${item.q}」對應的是：${item.a}`]
        };
    }, ["國文", "應用"]);

})(this);