(function(global){
    'use strict';

    // ------------------------------------------------------------------
    //  V7.7 è‡ªç™’æ ¸å¿ƒç‰ˆ (Self-Healing Engine)
    //  è§£æ±ºã€Œè¨»å†ŠæˆåŠŸä½†è®€ä¸åˆ°ã€çš„å•é¡Œï¼Œå¼·åˆ¶å»ºç«‹å…±äº«å„²å­˜å€
    // ------------------------------------------------------------------
    
    function ensureEngine() {
        // å¦‚æœå…¨åŸŸå¼•æ“ä¸å­˜åœ¨ï¼Œæˆ‘å€‘å°±è‡ªå·±é€ ä¸€å€‹ï¼
        if (!window.RigorousGenerator) {
            console.warn("âš ï¸ [Chinese V7.7] åµæ¸¬åˆ°å¼•æ“å°šæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åŸ·è¡Œã€Œç·Šæ€¥æ¶è¨­ã€...");
            window.RigorousGenerator = {
                _templates: {},
                registerTemplate: function(id, func, tags) {
                    // æ”¯æ´ V7.6 çš„å±¬æ€§æ³¨å…¥
                    if (func.tags) tags = func.tags;
                    
                    this._templates[id] = {
                        func: func,
                        tags: tags || [],
                        meta: tags || [], // é›™é‡å‚™ä»½
                        subject: func.subject || "chinese" // ç¢ºä¿ç§‘ç›®å±¬æ€§
                    };
                    // console.log(`ğŸ“¦ [Emergency] Template registered: ${id}`);
                },
                getTemplateIds: function() {
                    return Object.keys(this._templates);
                },
                generateQuestion: function(id, ctx) {
                    const t = this._templates[id];
                    if(!t) return null;
                    try {
                        return t.func(ctx || {}, Math.random);
                    } catch(e) {
                        console.error("Gen Error:", e);
                        return null;
                    }
                }
            };
            // å»ºç«‹åˆ¥åï¼Œç¢ºä¿ PaperGenerator ä¹Ÿèƒ½æ‰¾åˆ°
            window.GeneratorEngine = window.RigorousGenerator;
        }
        return window.RigorousGenerator;
    }

    function init() {
        // â˜… å¼·åˆ¶ç²å–æˆ–å‰µå»ºå¼•æ“
        const G = ensureEngine();
        
        console.log("ğŸš€ [Chinese V7.7] å¼•æ“é–å®šå®Œç•¢ (ID: RigorousGenerator)ï¼Œæº–å‚™æ³¨å…¥è³‡æ–™...");

        // ==========================================
        // åœ‹æ–‡ç§‘æ ¸å¿ƒè³‡æ–™åº«
        // ==========================================
        const chiData = [
            // 1. æˆèªåˆ¤è®€
            { q: "ç™½é§’ééš™", a: "å½¢å®¹æ™‚é–“éå¾—å¾ˆå¿«", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "æŒ‡é¹¿ç‚ºé¦¬", a: "æ¯”å–»æ··æ·†æ˜¯é", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "ç•«è›‡æ·»è¶³", a: "æ¯”å–»å¤šæ­¤ä¸€èˆ‰", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "æ¯å¼“è›‡å½±", a: "æ¯”å–»ç–‘ç¥ç–‘é¬¼ï¼Œè‡ªç›¸é©šæ“¾", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "ç­é–€å¼„æ–§", a: "åœ¨è¡Œå®¶é¢å‰è³£å¼„æœ¬äº‹", tag: ["åœ‹ä¸ƒ","æˆèª"] },
            { q: "å¦‚ç«å¦‚è¼", a: "å½¢å®¹æ°£å‹¢æ—ºç››æˆ–æ°£æ°›ç†±çƒˆ", tag: ["åœ‹å…«","æˆèª"] },
            { q: "æ«›é¢¨æ²é›¨", a: "å½¢å®¹å¥”æ³¢å‹ç¢Œï¼Œä¸é¿é¢¨é›¨", tag: ["åœ‹å…«","æˆèª"] },
            { q: "éŸ‹ç·¨ä¸‰çµ•", a: "å½¢å®¹è®€æ›¸å‹¤å¥®", tag: ["åœ‹å…«","æˆèª"] },
            { q: "ä¸‰ä»¤äº”ç”³", a: "å†ä¸‰å‘½ä»¤å‘Šèª¡", tag: ["åœ‹å…«","æˆèª"] },
            { q: "ç ´é‡œæ²ˆèˆŸ", a: "æ¯”å–»åšäº‹æœæ±ºï¼Œç¾©ç„¡åé¡§", tag: ["åœ‹ä¹","æˆèª"] },
            { q: "è‡¥è–ªå˜—è†½", a: "åˆ»è‹¦è‡ªå‹µï¼Œç™¼æ†¤åœ–å¼·", tag: ["åœ‹ä¹","æˆèª"] },
            { q: "ç½„ç«¹é›£æ›¸", a: "å½¢å®¹ç½ªæƒ¡æ¥µå¤šï¼Œç„¡æ³•å¯«ç›¡", tag: ["åœ‹ä¹","æˆèª"] },
            
            // 2. ä¿®è¾­æŠ€å·§
            { q: "ç™½é«®ä¸‰åƒä¸ˆï¼Œç·£æ„ä¼¼å€‹é•·", a: "èª‡é£¾", tag: ["åœ‹å…«","ä¿®è¾­"] },
            { q: "æ„Ÿæ™‚èŠ±æ¿ºæ·šï¼Œæ¨åˆ¥é³¥é©šå¿ƒ", a: "è½‰åŒ–(æ“¬äºº)", tag: ["åœ‹å…«","ä¿®è¾­"] },
            { q: "é‚£é›ªç™½çš„ç¾½æ¯›ï¼Œåƒæ˜¯å¤©ä½¿çš„ç¿…è†€", a: "è­¬å–»(æ˜å–»)", tag: ["åœ‹ä¸ƒ","ä¿®è¾­"] },
            { q: "å±å±å–³å–³çš„éº»é›€", a: "æ‘¹å¯«(è½è¦º)", tag: ["åœ‹ä¸ƒ","ä¿®è¾­"] },
            { q: "åœ¨å¤©é¡˜ä½œæ¯”ç¿¼é³¥ï¼Œåœ¨åœ°é¡˜ç‚ºé€£ç†æ", a: "å°å¶", tag: ["åœ‹ä¹","ä¿®è¾­"] },
            { q: "çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚æ¨‚ä¹‹è€…", a: "å±¤é", tag: ["åœ‹å…«","ä¿®è¾­"] },
            { q: "å€Ÿå•é…’å®¶ä½•è™•æœ‰ï¼Ÿç‰§ç«¥é™æŒ‡æèŠ±æ‘", a: "è¨­å•(æå•)", tag: ["åœ‹å…«","ä¿®è¾­"] },
            
            // 3. åœ‹å­¸å¸¸è­˜ & å…­æ›¸
            { q: "è±¡å½¢", a: "ç•«æˆå…¶ç‰©ï¼Œéš¨é«”è©°è©˜ (å¦‚ï¼šæ—¥ã€æœˆ)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "æŒ‡äº‹", a: "è¦–è€Œå¯è­˜ï¼Œå¯Ÿè€Œè¦‹æ„ (å¦‚ï¼šä¸Šã€ä¸‹)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "æœƒæ„", a: "æ¯”é¡åˆèª¼ï¼Œä»¥è¦‹æŒ‡æ’ (å¦‚ï¼šä¼‘ã€æ­¦)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "å½¢è²", a: "ä»¥äº‹ç‚ºåï¼Œå–è­¬ç›¸æˆ (å¦‚ï¼šæ±Ÿã€æ²³)", tag: ["åœ‹å…«","å…­æ›¸"] },
            { q: "è€Œç«‹ä¹‹å¹´", a: "30æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "ä¸æƒ‘ä¹‹å¹´", a: "40æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "çŸ¥å‘½ä¹‹å¹´", a: "50æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "è€³é †ä¹‹å¹´ / èŠ±ç”²", a: "60æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },
            { q: "å¤ç¨€ä¹‹å¹´", a: "70æ­²", tag: ["åœ‹ä¸ƒ","å¹´é½¡"] },

            // 4. ç¶“å…¸å¤æ–‡
            { q: "å­¸è€Œæ™‚ç¿’ä¹‹ï¼Œä¸äº¦èªªä¹", a: "è«–èª (å­”å­å¼Ÿå­)", tag: ["åœ‹ä¸ƒ","å¤æ–‡"] },
            { q: "ä¸‰äººè¡Œï¼Œå¿…æœ‰æˆ‘å¸«ç„‰", a: "è«–èª (å¼·èª¿å­¸ç¿’)", tag: ["åœ‹ä¸ƒ","å¤æ–‡"] },
            { q: "æ¡ƒèŠ±æºè¨˜", a: "é™¶æ·µæ˜ (æ±æ™‰ï¼Œç†æƒ³ä¸–ç•Œ)", tag: ["åœ‹ä¹","å¤æ–‡"] },
            { q: "ä¸–èªªæ–°èª", a: "åŠ‰ç¾©æ…¶ (ç­†è¨˜å°èªªï¼Œé­æ™‰é¢¨åº¦)", tag: ["åœ‹å…«","å¤æ–‡"] },
            { q: "èˆ‰é ­æœ›æ˜æœˆï¼Œä½é ­æ€æ•…é„‰", a: "æç™½ (éœå¤œæ€)", tag: ["åœ‹ä¸ƒ","å”è©©"] },
            { q: "ç™»é¸›é›€æ¨“", a: "ç‹ä¹‹æ¸™ (ç››å”é‚Šå¡)", tag: ["åœ‹ä¸ƒ","å”è©©"] },
            { q: "åœ‹ç ´å±±æ²³åœ¨ï¼ŒåŸæ˜¥è‰æœ¨æ·±", a: "æœç”« (æ˜¥æœ›ï¼Œæ„Ÿæ™‚æ†‚åœ‹)", tag: ["åœ‹å…«","å”è©©"] },
            { q: "æ…ˆæ¯æ‰‹ä¸­ç·šï¼ŒéŠå­èº«ä¸Šè¡£", a: "å­ŸéƒŠ (éŠå­åŸ)", tag: ["åœ‹ä¸ƒ","å”è©©"] },
            
            // 5. ç¾ä»£æ–‡å­¸
            { q: "èƒŒå½±", a: "æœ±è‡ªæ¸… (çˆ¶æ„›)", tag: ["åœ‹ä¸ƒ","ç¾ä»£æ–‡"] },
            { q: "é›…é‡", a: "å®‹æ™¶å®œ (åŒ…å®¹å°Šé‡)", tag: ["åœ‹ä¸ƒ","ç¾ä»£æ–‡"] },
            { q: "ç´™èˆ¹å°è±¡", a: "æ´ªé†’å¤« (æ¯æ„›)", tag: ["åœ‹ä¸ƒ","ç¾ä»£æ–‡"] },
            { q: "è² è·", a: "å³æ™Ÿ (ç”œèœœçš„è² è·)", tag: ["åœ‹å…«","ç¾ä»£æ–‡"] }
        ];

        // æ•´ç†çµ„åˆ
        const combinations = new Set();
        chiData.forEach(item => {
            if(item.tag && item.tag.length >= 2) {
                combinations.add(`${item.tag[0].trim()}_${item.tag[1].trim()}`);
            }
        });

        // è¨»å†Šæ¨¡æ¿
        combinations.forEach(combo => {
            const [grade, topic] = combo.split('_');
            const pool = chiData.filter(q => q.tag[0].trim() === grade && q.tag[1].trim() === topic);

            if (pool.length > 0) {
                // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ¨™ç±¤ (å¤§å°å¯«æ··ç”¨)
                const rawTags = ["chinese", "Chinese", "åœ‹æ–‡", "èªæ–‡", topic, grade];
                const uniqueTags = [...new Set(rawTags)];

                const generatorFunc = (ctx, rnd) => {
                    const item = pool[Math.floor(Math.random() * pool.length)];
                    const others = chiData.filter(x => x.tag[1] === topic && x.q !== item.q);
                    
                    const wrongOpts = others.sort(() => 0.5 - Math.random()).slice(0, 3).map(x => x.a);
                    while(wrongOpts.length < 3) wrongOpts.push("ä»¥ä¸Šçš†é");
                    
                    const opts = [item.a, ...wrongOpts].sort(() => 0.5 - Math.random());
                    
                    let qText = "";
                    if (topic === "æˆèª") qText = `ã€Œ${item.q}ã€çš„æ„æ€ç‚ºä½•ï¼Ÿ`;
                    else if (topic === "ä¿®è¾­") qText = `ã€Œ${item.q}ã€ä½¿ç”¨äº†å“ªç¨®ä¿®è¾­ï¼Ÿ`;
                    else if (topic === "å¤æ–‡") qText = `ã€Œ${item.q}ã€å‡ºè‡ªä½•è™•æˆ–ä½•äººï¼Ÿ`;
                    else qText = `é—œæ–¼ã€Œ${item.q}ã€ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ`;

                    return {
                        question: `ã€${topic}ã€‘${qText}`,
                        options: opts,
                        answer: opts.indexOf(item.a),
                        concept: topic,
                        explanation: [`æ­£ç¢ºç­”æ¡ˆï¼š${item.a}`],
                        // â˜… V7.7 å¼·åˆ¶å›å‚³å±¬æ€§
                        subject: "chinese",
                        tags: uniqueTags,
                        meta: { subject: "chinese", grade: grade, topic: topic }
                    };
                };

                // â˜… V7.7 å±¬æ€§åˆºé’ (Property Injection)
                generatorFunc.subject = "chinese"; 
                generatorFunc.tags = uniqueTags;
                generatorFunc.grade = grade;

                // è¨»å†Š
                try {
                    // ID å‘½åè¦å‰‡: chi_åœ‹ä¸ƒ_æˆèª_auto
                    const templateId = `chi_${grade}_${topic}_auto`;
                    G.registerTemplate(templateId, generatorFunc, uniqueTags);
                } catch (e) {
                    console.error("Template Reg Error:", e);
                }
            }
        });

        console.log(`ğŸ‰ åœ‹æ–‡é¡Œåº« (V7.7 Self-Healing) å·²è¼‰å…¥ï¼è¨»å†Š ${combinations.size} çµ„æ¨¡æ¿ (è‡³ RigorousGenerator)ã€‚`);
    }

    init();
})(window);
