(function(global){
    'use strict';

    function init() {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        
        // 等待引擎載入
        if (!G || !G.registerTemplate) { 
            setTimeout(init, 100); 
            return; 
        }

        const { pick, shuffle } = G.utils;

        // ==========================================
        //  生物科資料庫 (Biology Core Database)
        // ==========================================
        const bioDB = [
            // [國七] 單元 1：生命的特性
            { s:"生物", t:["國七","細胞"], q: "細胞的發電廠，產生能量(ATP)", a: "粒線體" },
            { s:"生物", t:["國七","細胞"], q: "植物細胞進行光合作用的場所", a: "葉綠體" },
            { s:"生物", t:["國七","細胞"], q: "細胞的生命中樞，內含遺傳物質", a: "細胞核" },
            { s:"生物", t:["國七","細胞"], q: "植物細胞外層，提供支持與保護", a: "細胞壁" },
            { s:"生物", t:["國七","細胞"], q: "暫存水分、廢物與養分", a: "液泡" },
            { s:"生物", t:["國七","細胞"], q: "控制物質進出細胞的構造", a: "細胞膜" },
            { s:"生物", t:["國七","細胞"], q: "水分子通過半透膜的現象", a: "滲透作用" },
            { s:"生物", t:["國七","細胞"], q: "分子由高濃度往低濃度移動", a: "擴散作用" },

            // [國七] 單元 2：養分
            { s:"生物", t:["國七","養分"], q: "分泌膽汁的器官", a: "肝臟" },
            { s:"生物", t:["國七","養分"], q: "吸收養分與水分的主要場所", a: "小腸" },
            { s:"生物", t:["國七","養分"], q: "吸收水分與形成糞便", a: "大腸" },
            { s:"生物", t:["國七","養分"], q: "胃液中的酸性物質", a: "鹽酸" },
            { s:"生物", t:["國七","養分"], q: "唾液澱粉酶可分解", a: "澱粉" },

            // [國七] 單元 3：運輸與防禦
            { s:"生物", t:["國七","運輸"], q: "植物體內運送水分的構造", a: "木質部" },
            { s:"生物", t:["國七","運輸"], q: "植物體內運送養分(糖)的構造", a: "韌皮部" },
            { s:"生物", t:["國七","運輸"], q: "葉片散失水分的主要動力", a: "蒸散作用" },
            { s:"生物", t:["國七","運輸"], q: "將血液帶離心臟的血管", a: "動脈" },
            { s:"生物", t:["國七","運輸"], q: "將血液帶回心臟的血管", a: "靜脈" },
            { s:"生物", t:["國七","運輸"], q: "物質交換的場所，管壁最薄", a: "微血管" },
            { s:"生物", t:["國七","運輸"], q: "攜帶氧氣的血球", a: "紅血球" },
            { s:"生物", t:["國七","運輸"], q: "負責防禦與免疫的血球", a: "白血球" },
            { s:"生物", t:["國七","運輸"], q: "負責血液凝固的血球", a: "血小板" },

            // [國七] 單元 4：協調作用
            { s:"生物", t:["國七","協調"], q: "人體意識與感覺的中樞", a: "大腦" },
            { s:"生物", t:["國七","協調"], q: "協調肌肉與身體平衡", a: "小腦" },
            { s:"生物", t:["國七","協調"], q: "反射動作的中樞(如膝跳)", a: "脊髓" },
            { s:"生物", t:["國七","協調"], q: "呼吸運動的中樞", a: "腦幹" },
            { s:"生物", t:["國七","協調"], q: "血糖過高時分泌", a: "胰島素" },
            { s:"生物", t:["國七","協調"], q: "血糖過低時分泌", a: "升糖素" },
            { s:"生物", t:["國七","協調"], q: "應付緊急狀況(戰或逃)", a: "腎上腺素" },

            // [國七] 單元 5：恆定性
            { s:"生物", t:["國七","恆定"], q: "人體主要的排泄器官(尿素)", a: "腎臟" },
            { s:"生物", t:["國七","恆定"], q: "控制呼吸運動的氣體", a: "二氧化碳" },
            { s:"生物", t:["國七","恆定"], q: "皮膚調節體溫的方式", a: "流汗與血管擴張" },

            // [國七下] 生殖
            { s:"生物", t:["國七","生殖"], q: "產生精子的器官", a: "睪丸" },
            { s:"生物", t:["國七","生殖"], q: "產生卵子的器官", a: "卵巢" },
            { s:"生物", t:["國七","生殖"], q: "胎兒發育的場所", a: "子宮" },
            { s:"生物", t:["國七","生殖"], q: "酵母菌的無性生殖方式", a: "出芽生殖" },
            { s:"生物", t:["國七","生殖"], q: "變形蟲的無性生殖方式", a: "分裂生殖" },
            { s:"生物", t:["國七","生殖"], q: "草莓/馬鈴薯的生殖方式", a: "營養器官繁殖" },

            // [國七下] 遺傳
            { s:"生物", t:["國七","遺傳"], q: "遺傳學之父", a: "孟德爾" },
            { s:"生物", t:["國七","遺傳"], q: "控制性狀的特徵因子", a: "基因" },
            { s:"生物", t:["國七","遺傳"], q: "人類體細胞的染色體數目", a: "46條 (23對)" },
            { s:"生物", t:["國七","遺傳"], q: "人類精子/卵子的染色體數", a: "23條" },
            { s:"生物", t:["國七","遺傳"], q: "決定性別的染色體", a: "第23對 (性染色體)" },

            // [國七下] 演化
            { s:"生物", t:["國七","演化"], q: "天擇說的提出者", a: "達爾文" },
            { s:"生物", t:["國七","演化"], q: "演化的最直接證據", a: "化石" },
            { s:"生物", t:["國七","演化"], q: "同源器官", a: "來源相同，功能可能不同" },
            { s:"生物", t:["國七","演化"], q: "生物分類的最高階層", a: "界" },
            { s:"生物", t:["國七","演化"], q: "生物學名的組成", a: "屬名 + 種小名" },

            // [國七下] 生態
            { s:"生物", t:["國七","生態"], q: "能量流動的方向", a: "單向流動" },
            { s:"生物", t:["國七","生態"], q: "物質循環的特性", a: "循環利用" },
            { s:"生物", t:["國七","生態"], q: "生產者", a: "綠色植物、藻類" },
            { s:"生物", t:["國七","生態"], q: "分解者", a: "細菌、真菌" },
            { s:"生物", t:["國七","生態"], q: "生物放大作用", a: "毒素在高級消費者累積" },

            // [高中] 進階生物
            { s:"生物", t:["高一","細胞"], q: "細胞膜的主要成分", a: "磷脂質與蛋白質" },
            { s:"生物", t:["高一","細胞"], q: "原核細胞與真核細胞的區別", a: "有無核膜" },
            { s:"生物", t:["高一","代謝"], q: "能量貨幣", a: "ATP (三磷酸腺苷)" },
            { s:"生物", t:["高一","代謝"], q: "酵素的主要成分", a: "蛋白質" },
            { s:"生物", t:["高一","遺傳"], q: "DNA 的中文名稱", a: "去氧核糖核酸" },
            { s:"生物", t:["高一","遺傳"], q: "RNA 的中文名稱", a: "核糖核酸" },
            { s:"生物", t:["高一","遺傳"], q: "DNA 的鹼基配對", a: "A-T, C-G" },
            { s:"生物", t:["高一","遺傳"], q: "中心法則", a: "DNA -> RNA -> 蛋白質" },
            { s:"生物", t:["高二","生理"], q: "神經元傳導方向", a: "樹突 -> 本體 -> 軸突" },
            { s:"生物", t:["高二","生理"], q: "特異性免疫的主角", a: "淋巴球 (B細胞/T細胞)" },
            { s:"生物", t:["高二","生態"], q: "族群成長曲線(S型)的上限", a: "負荷量 (K值)" }
        ];

        // ==========================================
        //  ★ 核心修正：精準分類註冊 (Precision Registration) ★
        // ==========================================
        
        // 1. 找出所有獨特的「年級+單元」組合 (例如 "國七+細胞", "高一+遺傳")
        const combinations = new Set();
        bioDB.forEach(item => {
            const key = `${item.t[0]}_${item.t[1]}`; // ex: "國七_細胞"
            combinations.add(key);
        });

        // 2. 為每個組合註冊一個專屬模板
        combinations.forEach(combo => {
            const [grade, topic] = combo.split('_');
            
            // 篩選出該組合的所有題目
            const pool = bioDB.filter(q => q.t[0] === grade && q.t[1] === topic);
            
            if (pool.length > 0) {
                const templateId = `bio_${grade}_${topic}`; // ex: bio_國七_細胞

                G.registerTemplate(templateId, (ctx, rnd) => {
                    const item = pick(pool);
                    
                    // 智慧誘答：優先找同單元的錯誤選項
                    const sameTag = pool.filter(x => x.a !== item.a); // 同單元
                    const others = bioDB.filter(x => x.a !== item.a); // 全生物庫
                    
                    let wrongOpts = [];
                    // 嘗試從同單元找 3 個錯的
                    if (sameTag.length >= 3) {
                        wrongOpts = shuffle(sameTag).slice(0, 3).map(x => x.a);
                    } else {
                        // 如果不夠，就從全生物庫補
                        wrongOpts = shuffle(others).slice(0, 3).map(x => x.a);
                    }
                    
                    // 確保選項不重複
                    wrongOpts = [...new Set(wrongOpts)];
                    while(wrongOpts.length < 3) wrongOpts.push("其他構造");

                    const opts = shuffle([item.a, ...wrongOpts]);

                    return {
                        question: `【${topic}】${item.q}，是指下列何者？`,
                        options: opts,
                        answer: opts.indexOf(item.a),
                        concept: item.t[1],
                        explanation: [`正確答案：${item.a}`]
                    };
                }, ["biology", "生物", "自然", grade, topic]); // ★ 關鍵：只加上該年級和該單元的標籤
            }
        });

        console.log(`✅ 生物題庫已載入完成，共註冊 ${combinations.size} 個單元模板。`);
    }

    init();

})(window);
