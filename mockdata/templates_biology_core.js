(function(global){
    'use strict';

    // 定義啟動函式
    function init() {
        // 1. 檢查引擎是否就緒 (等待機制)
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        
        // 如果引擎還沒好，等待 100ms 後重試
        if (!G || !G.registerTemplate) {
            setTimeout(init, 100);
            return;
        }

        // 引擎已就緒，取出工具
        const { pick, shuffle } = G.utils;

        // ==========================================
        //  生物科核心資料庫 (Biology Core Database)
        // ==========================================
        const bioDB = [
            // [國七] 細胞與生物體
            { t:["國七","細胞"], q: "細胞的發電廠，產生能量(ATP)", a: "粒線體" },
            { t:["國七","細胞"], q: "植物細胞進行光合作用的場所", a: "葉綠體" },
            { t:["國七","細胞"], q: "細胞的生命中樞，內含遺傳物質", a: "細胞核" },
            { t:["國七","細胞"], q: "植物細胞外層，提供支持與保護", a: "細胞壁" },
            { t:["國七","細胞"], q: "暫存水分、廢物與養分", a: "液泡" },
            { t:["國七","細胞"], q: "控制物質進出細胞的構造", a: "細胞膜" },
            { t:["國七","運輸"], q: "水分子通過半透膜的現象", a: "滲透作用" },
            { t:["國七","運輸"], q: "分子由高濃度往低濃度移動", a: "擴散作用" },
            { t:["國七","運輸"], q: "植物體內運送水分的構造", a: "木質部" },
            { t:["國七","運輸"], q: "植物體內運送養分(糖)的構造", a: "韌皮部" },
            { t:["國七","運輸"], q: "葉片散失水分的主要動力", a: "蒸散作用" },
            
            // [國七] 人體生理
            { t:["國七","消化"], q: "分泌膽汁的器官", a: "肝臟" },
            { t:["國七","消化"], q: "吸收養分與水分的主要場所", a: "小腸" },
            { t:["國七","消化"], q: "吸收水分與形成糞便", a: "大腸" },
            { t:["國七","消化"], q: "胃液中的酸性物質", a: "鹽酸" },
            { t:["國七","消化"], q: "唾液澱粉酶可分解", a: "澱粉" },
            { t:["國七","循環"], q: "將血液帶離心臟的血管", a: "動脈" },
            { t:["國七","循環"], q: "將血液帶回心臟的血管", a: "靜脈" },
            { t:["國七","循環"], q: "物質交換的場所，管壁最薄", a: "微血管" },
            { t:["國七","循環"], q: "攜帶氧氣的血球", a: "紅血球" },
            { t:["國七","循環"], q: "負責防禦與免疫的血球", a: "白血球" },
            { t:["國七","循環"], q: "負責血液凝固的血球", a: "血小板" },
            { t:["國七","循環"], q: "心臟中含充氧血的腔室", a: "左心房與左心室" },
            { t:["國七","呼吸"], q: "控制呼吸運動的氣體", a: "二氧化碳" },
            { t:["國七","呼吸"], q: "呼吸運動的中樞", a: "腦幹" },
            { t:["國七","神經"], q: "人體意識與感覺的中樞", a: "大腦" },
            { t:["國七","神經"], q: "協調肌肉與身體平衡", a: "小腦" },
            { t:["國七","神經"], q: "反射動作的中樞(如膝跳)", a: "脊髓" },
            { t:["國七","內分泌"], q: "血糖過高時分泌", a: "胰島素" },
            { t:["國七","內分泌"], q: "血糖過低時分泌", a: "升糖素" },
            { t:["國七","內分泌"], q: "應付緊急狀況(戰或逃)", a: "腎上腺素" },
            { t:["國七","恆定"], q: "人體主要的排泄器官(尿素)", a: "腎臟" },
            { t:["國七","恆定"], q: "皮膚調節體溫的方式", a: "流汗與血管擴張" },

            // [國八] 生殖與遺傳
            { t:["國七","生殖"], q: "產生精子的器官", a: "睪丸" },
            { t:["國七","生殖"], q: "產生卵子的器官", a: "卵巢" },
            { t:["國七","生殖"], q: "胎兒發育的場所", a: "子宮" },
            { t:["國七","生殖"], q: "酵母菌的無性生殖方式", a: "出芽生殖" },
            { t:["國七","生殖"], q: "變形蟲的無性生殖方式", a: "分裂生殖" },
            { t:["國七","生殖"], q: "草莓/馬鈴薯的生殖方式", a: "營養器官繁殖" },
            { t:["國七","遺傳"], q: "遺傳學之父", a: "孟德爾" },
            { t:["國七","遺傳"], q: "控制性狀的特徵因子", a: "基因" },
            { t:["國七","遺傳"], q: "人類體細胞的染色體數目", a: "46條 (23對)" },
            { t:["國七","遺傳"], q: "人類精子/卵子的染色體數", a: "23條" },
            { t:["國七","遺傳"], q: "決定性別的染色體", a: "第23對 (性染色體)" },
            { t:["國七","演化"], q: "天擇說的提出者", a: "達爾文" },
            { t:["國七","演化"], q: "演化的最直接證據", a: "化石" },
            { t:["國七","演化"], q: "同源器官", a: "來源相同，功能可能不同" },
            { t:["國七","分類"], q: "生物分類的最高階層", a: "界" },
            { t:["國七","分類"], q: "生物學名的組成", a: "屬名 + 種小名" },
            { t:["國七","分類"], q: "藍綠菌屬於", a: "原核生物界" },
            { t:["國七","分類"], q: "黴菌/酵母菌屬於", a: "真菌界" },

            // [國八] 生態
            { t:["國七","生態"], q: "能量流動的方向", a: "單向流動" },
            { t:["國七","生態"], q: "物質循環的特性", a: "循環利用" },
            { t:["國七","生態"], q: "生產者", a: "綠色植物、藻類" },
            { t:["國七","生態"], q: "分解者", a: "細菌、真菌" },
            { t:["國七","生態"], q: "生物放大作用", a: "毒素在高級消費者累積" },

            // [高中] 進階生物
            { t:["高一","細胞"], q: "細胞膜的主要成分", a: "磷脂質與蛋白質" },
            { t:["高一","細胞"], q: "原核細胞與真核細胞的區別", a: "有無核膜" },
            { t:["高一","代謝"], q: "能量貨幣", a: "ATP (三磷酸腺苷)" },
            { t:["高一","代謝"], q: "酵素的主要成分", a: "蛋白質" },
            { t:["高一","遺傳"], q: "DNA 的中文名稱", a: "去氧核糖核酸" },
            { t:["高一","遺傳"], q: "RNA 的中文名稱", a: "核糖核酸" },
            { t:["高一","遺傳"], q: "DNA 的鹼基配對", a: "A-T, C-G" },
            { t:["高一","遺傳"], q: "中心法則", a: "DNA -> RNA -> 蛋白質" },
            { t:["高二","生理"], q: "神經元傳導方向", a: "樹突 -> 本體 -> 軸突" },
            { t:["高二","生理"], q: "特異性免疫的主角", a: "淋巴球 (B細胞/T細胞)" },
            { t:["高二","生態"], q: "族群成長曲線(S型)的上限", a: "負荷量 (K值)" }
        ];

        // 註冊模板：正向題 (描述 -> 名詞)
        G.registerTemplate('bio_concept', (ctx, rnd) => {
            const item = pick(bioDB);
            
            // 誘答：優先找同科目的錯誤選項
            const wrong = shuffle(bioDB.filter(x => x.a !== item.a)).slice(0, 3).map(x => x.a);
            // 補足選項
            while(wrong.length < 3) {
                wrong.push("其他");
            }

            const opts = shuffle([item.a, ...wrong]);

            return {
                question: `【${item.t[1]}】${item.q}，請問是指下列何者？`,
                options: opts,
                answer: opts.indexOf(item.a),
                concept: item.t[1],
                explanation: [`正確答案是：${item.a}`, `因為 ${item.a} 是 ${item.q.replace('，','，是')}。`]
            };
        }, ["biology", "生物", "自然", "觀念", "國七", "國八", "國九", "高一", "高二", "高三"]);
        
        // 註冊模板：反向題 (名詞 -> 描述)
        G.registerTemplate('bio_reverse', (ctx, rnd) => {
            const item = pick(bioDB);
            const correctDesc = item.q;
            const wrongDescs = shuffle(bioDB.filter(x => x.q !== item.q)).slice(0, 3).map(x => x.q);
            const opts = shuffle([correctDesc, ...wrongDescs]);

            return {
                question: `【${item.t[1]}】關於「${item.a}」的敘述，下列何者正確？`,
                options: opts,
                answer: opts.indexOf(correctDesc),
                concept: item.t[1],
                explanation: [`${item.a} 的特徵是：${item.q}`]
            };
        }, ["biology", "生物", "自然", "觀念", "國七", "國八", "國九", "高一", "高二", "高三"]);

        console.log("✅ 生物題庫已載入完成。");
    }

    // 啟動！
    init();

})(window);
