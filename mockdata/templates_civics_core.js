(function(global){
    'use strict';
    window.__CIVICS_REPO__ = window.__CIVICS_REPO__ || {};

    const Utils = {
        shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
        rnd: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
        pick: (arr) => arr[Math.floor(Math.random()*arr.length)]
    };

    // 基本題庫範本（主題、題幹、正答、錯誤選項）
    const templates = [
        // 自我與社會
        {q:"根據馬斯洛需求理論，哪一項屬於基本生理需求？", a:"食物與睡眠", o:["自我實現","尊重需求","社會歸屬"], t:["自我","國七"]},
        {q:"性別平等的核心價值為何？", a:"尊重與機會均等", o:["性別分工固定","只重視男性權益","限制女性受教育"], t:["性別","國七"]},
        {q:"家庭功能不包含下列哪一項？", a:"製造貨幣", o:["情感支持","社會化","經濟互助"], t:["家庭","國七"]},
        {q:"社區營造最重要的第一步通常是？", a:"凝聚居民共識", o:["大量投資建設","拆除舊屋","提高房價"], t:["社區","國七"]},

        // 政治與國家
        {q:"主權的意義最接近下列哪一項？", a:"國家最高的統治權", o:["人民的私人財產","國際組織的權力","地方政府的自治"], t:["國家","國八"]},
        {q:"五權分立中負責立法的是？", a:"立法院", o:["司法院","行政院","考試院"], t:["政治","國八"]},
        {q:"政黨的主要功能不包括？", a:"提供司法裁判", o:["整合民意","提名候選人","監督政府"], t:["政黨","國八"]},
        {q:"選舉中常見的投票制度有哪一種？", a:"相對多數制", o:["完全隨機制","世襲制","指派制"], t:["選舉","國八"]},

        // 法律與權利
        {q:"憲法保障基本權利，限制權利時應遵循哪一原則？", a:"比例原則", o:["效率優先","多數決原則","行政方便原則"], t:["憲法","高一"]},
        {q:"民法中契約自由原則的意義為何？", a:"當事人可自由訂立契約", o:["契約必須由政府核准","契約不得有任何條件","契約只能口頭訂立"], t:["民法","高一"]},
        {q:"刑法的罪刑法定原則表示？", a:"無法律明文不得處罰", o:["法官可自由創設罪名","檢察官可任意量刑","被告自動有罪"], t:["刑法","國八"]},
        {q:"行政救濟的常見途徑不包含？", a:"私人仲裁（非行政程序）", o:["行政申訴","行政訴訟","復議"], t:["行政法","高一"]},

        // 經濟基礎
        {q:"機會成本的定義為何？", a:"放棄的最佳替代選擇價值", o:["實際支付的金額","沉沒成本","邊際成本"], t:["經濟","國九"]},
        {q:"需求法則說明價格與需求量的關係為何？", a:"價格上升需求量下降", o:["價格上升需求量上升","價格與需求量無關","價格下降需求量下降"], t:["經濟","國九"]},
        {q:"GDP衡量的是哪一項？", a:"一國在一定期間內最終產品與服務的市價總值", o:["國民儲蓄總額","政府支出總額","進口總額"], t:["經濟","高二"]},
        {q:"公共財的特性包含？", a:"非排他性與非競爭性", o:["高排他性","高競爭性","私人所有"], t:["經濟","國九"]},

        // 全球與媒體
        {q:"WTO的主要目標是？", a:"促進國際貿易自由化", o:["管理全球衛生","統一貨幣政策","監督選舉"], t:["全球","國九"]},
        {q:"媒體識讀的重點不包括？", a:"盲目轉發未查證資訊", o:["辨識來源可信度","理解議題框架","分析利益關係"], t:["媒體","國九"]},
        {q:"全球化可能帶來的負面影響為何？", a:"加劇貧富差距", o:["消滅所有文化差異","立即消除失業","使所有國家富裕"], t:["全球化","國九"]},
        {q:"國際人權宣言主要強調什麼？", a:"人人生而自由且享有平等權利", o:["國家優先於個人","只有公民享有人權","人權可任意限制"], t:["人權","高一"]},

        // 社會議題與倫理
        {q:"社會正義的核心概念包含？", a:"資源分配的公平與機會平等", o:["只重視效率","只重視傳統價值","忽視弱勢"], t:["社會","高一"]},
        {q:"多元文化社會應如何處理差異？", a:"尊重並保障文化多樣性", o:["強制同化","排斥少數文化","禁止文化交流"], t:["文化","國七"]},
        {q:"環境永續的三大面向通常為？", a:"經濟、社會、環境三者平衡", o:["只重視經濟發展","只重視環境保護","只重視社會福利"], t:["環境","國九"]},
        {q:"社會福利政策的主要目的為何？", a:"保障弱勢與促進社會安全", o:["減少政府支出","提高稅收","限制公民權利"], t:["社會福利","高二"]},

        // 公民參與與民主素養
        {q:"公民投票的功能之一是？", a:"直接表達人民意志", o:["取代立法程序","取消選舉","由政府單方面決定"], t:["民主","國八"]},
        {q:"民主社會中，言論自由的限制應以何者為依據？", a:"法律並兼顧他人權利與公共秩序", o:["政府意志","多數決","媒體偏好"], t:["人權","高一"]},
        {q:"選民教育的重要性在於？", a:"提升理性投票與公共討論品質", o:["鼓勵盲從投票","減少投票率","增加政治對立"], t:["選舉","國八"]},
        {q:"學生自治組織的主要功能為何？", a:"培養民主參與與公共事務能力", o:["取代學校行政","管理學校財務","決定國家政策"], t:["學生自治","國七"]},

        // 法律實務與案例導向
        {q:"若行政機關違法處分，人民可先採取何種救濟？", a:"申訴或復議", o:["直接暴力抗爭","無條件接受","向國際法院提告"], t:["行政法","高一"]},
        {q:"契約無效的常見原因不包含？", a:"當事人自願且具完全行為能力", o:["違反強行法規","意思表示重大錯誤","詐欺或脅迫"], t:["民法","高一"]},
        {q:"刑事訴訟中被告享有哪項重要權利？", a:"無罪推定與辯護權", o:["必須自證清白","不得聘請律師","不得上訴"], t:["刑事訴訟","高一"]},
        {q:"國家賠償制度的目的為何？", a:"補償因國家違法行為所受損害", o:["懲罰受害人","替代刑罰","減少政府責任"], t:["行政法","高一"]},

        // 經濟政策與社會安全
        {q:"失業率上升通常代表？", a:"勞動市場需求減少或結構性問題", o:["國家富裕增加","物價穩定","勞動力過剩必然好事"], t:["總經","高二"]},
        {q:"通貨膨脹對一般民眾的影響為何？", a:"實質購買力下降", o:["實質購買力上升","薪資自動增加","物價下降"], t:["總經","高二"]},
        {q:"社會保險的主要功能是？", a:"分散風險並提供基本保障", o:["完全取代私人保險","只服務富人","減少社會福利"], t:["社會保險","高二"]},
        {q:"財政政策中擴張性政策通常會做什麼？", a:"增加政府支出或減稅以刺激需求", o:["減少政府支出","提高稅率","限制投資"], t:["財政政策","高二"]},

        // 公共治理與地方自治
        {q:"地方自治的核心在於？", a:"地方人民自主管理地方事務", o:["中央完全控制地方","地方無需負責任","地方可制定國際條約"], t:["地方自治","國八"]},
        {q:"透明政府的主要指標不包含？", a:"秘密決策程序", o:["資訊公開","問責機制","公民參與"], t:["治理","高一"]},
        {q:"反貪腐措施常見做法為何？", a:"強化監督與透明度", o:["減少審計","鼓勵裙帶關係","隱匿財產"], t:["治理","高二"]},
        {q:"公共政策評估常用哪種指標？", a:"成本效益分析", o:["個人偏好調查（唯一依據）","隨機決策","無需評估"], t:["政策分析","高二"]},

        // 媒體、科技與資訊倫理
        {q:"個資保護的基本原則為何？", a:"最小必要原則與告知同意", o:["無限制蒐集","公開所有資料","不需告知當事人"], t:["資訊倫理","國九"]},
        {q:"假新聞的辨識方法不包括？", a:"只看標題就分享", o:["查證來源","比對多方報導","檢視發布者背景"], t:["媒體識讀","國九"]},
        {q:"智慧財產權保護的主要目的為何？", a:"鼓勵創作並保障創作者權益", o:["禁止所有分享","只保護政府作品","取消版權制度"], t:["智慧財產","高一"]},
        {q:"網路言論自由的限制應以何者為依據？", a:"法律並兼顧他人權利與公共秩序", o:["平台偏好","個人情緒","無限制"], t:["人權","高一"]}
    ];

    // 生成題目直到達到目標數量
    const TARGET = 300;
    let existingCount = Object.keys(window.__CIVICS_REPO__).length;
    let genIndex = 0;

    while (existingCount < TARGET) {
        const tpl = Utils.pick(templates);
        // 產生少量變化（替換措辭或年級標籤）
        const gradeVariants = ["國七","國八","國九","高一","高二","高三"];
        const level = Utils.pick(tpl.t);
        const altGrade = Utils.pick(gradeVariants);
        const id = `civ_auto_${Date.now().toString(36)}_${genIndex++}`;

        // 製作選項（確保不重複）
        const correct = tpl.a;
        const distractors = tpl.o.slice(0,3);
        const opts = Utils.shuffle([correct, ...distractors]);

        const finalTags = ["civics","公民", ...tpl.t];
        // 若模板年級與隨機年級不同，加入該年級標籤以增加多樣性
        if (!finalTags.includes(altGrade)) finalTags.push(altGrade);

        window.__CIVICS_REPO__[id] = {
            func: (() => {
                const questionText = `【公民】${tpl.q}`;
                const options = opts;
                const answerIndex = options.indexOf(correct);
                const explanation = [`正確答案：${correct}`, `概念：${tpl.t.join(' / ')}`];
                return () => ({ question: questionText, options, answer: answerIndex, explanation, subject: "civics", tags: finalTags });
            })(),
            tags: finalTags,
            subject: "civics"
        };

        existingCount = Object.keys(window.__CIVICS_REPO__).length;
    }

    console.log(`✅ 公民題庫已擴充至 ${Object.keys(window.__CIVICS_REPO__).length} 題（目標 ${TARGET} 題）。`);
})(window);
