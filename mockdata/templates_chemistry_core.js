(function(global){
    'use strict';

    function init() {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        if (!G || !G.registerTemplate) { setTimeout(init, 100); return; }
        const { pick, shuffle } = G.utils;

        // ==========================================
        // 化學與地科資料庫 (Chemistry & Earth Science DB)
        // ==========================================
        const scienceDB = [
            // [國九] 天文 (Earth Science - Astronomy)
            { s:"地科", t:["國九","天文"], q: "地球自轉造成的現象", a: "晝夜交替" },
            { s:"地科", t:["國九","天文"], q: "地球公轉造成的現象", a: "四季變化" },
            { s:"地科", t:["國九","天文"], q: "太陽系最大的行星", a: "木星" },
            { s:"地科", t:["國九","天文"], q: "類地行星特徵", a: "體積小、密度大、岩石組成" },
            { s:"地科", t:["國九","天文"], q: "類木行星特徵", a: "體積大、密度小、氣體組成" },
            { s:"地科", t:["國九","天文"], q: "月相變化的週期", a: "約 29.5 天 (朔望月)" },
            { s:"地科", t:["國九","天文"], q: "日食發生的農曆日期", a: "朔 (初一)" },
            { s:"地科", t:["國九","天文"], q: "月食發生的農曆日期", a: "望 (十五)" },
            { s:"地科", t:["國九","天文"], q: "織女星屬於", a: "恆星" },
            { s:"地科", t:["國九","天文"], q: "光年是單位的", a: "距離" },
            // [國九] 地質 (Earth Science - Geology)
            { s:"地科", t:["國九","地質"], q: "板塊構造運動的動力來源", a: "地函熱對流" },
            { s:"地科", t:["國九","地質"], q: "台灣位於哪兩板塊交界", a: "歐亞板塊與菲律賓海板塊" },
            { s:"地科", t:["國九","地質"], q: "聚合性板塊邊界特徵", a: "海溝、火山、造山運動" },
            { s:"地科", t:["國九","地質"], q: "張裂性板塊邊界特徵", a: "中洋脊、裂谷" },
            { s:"地科", t:["國九","地質"], q: "花岡岩屬於", a: "火成岩" },
            { s:"地科", t:["國九","地質"], q: "大理岩屬於", a: "變質岩" },
            { s:"地科", t:["國九","地質"], q: "石灰岩屬於", a: "沈積岩" },
            { s:"地科", t:["國九","地質"], q: "地震規模的定義", a: "釋放能量的多寡" },
            { s:"地科", t:["國九","地質"], q: "地震震度的定義", a: "地面搖晃的程度" },
            // [國九] 大氣與海洋 (Earth Science - Atmosphere & Ocean)
            { s:"地科", t:["國九","大氣"], q: "天氣現象發生的那一層", a: "對流層" },
            { s:"地科", t:["國九","大氣"], q: "臭氧層所在位置", a: "平流層" },
            { s:"地科", t:["國九","大氣"], q: "大氣中含量最多的氣體", a: "氮氣" },
            { s:"地科", t:["國九","大氣"], q: "造成溫室效應的主要氣體", a: "二氧化碳、甲烷、水氣" },
            { s:"地科", t:["國九","大氣"], q: "高氣壓中心的氣流", a: "下沉、順時針旋轉(北半球)" },
            { s:"地科", t:["國九","大氣"], q: "低氣壓中心的氣流", a: "上升、逆時針旋轉(北半球)" },
            { s:"地科", t:["國九","大氣"], q: "冷鋒通過時的天氣", a: "氣溫下降、降雨" },
            { s:"地科", t:["國九","海洋"], q: "造成潮汐的主因", a: "月球與太陽的引力" },
            { s:"地科", t:["國九","海洋"], q: "黑潮是", a: "暖流" },
            // [高中] 進階地科 (High School Earth Science)
            { s:"地科", t:["高一","天文"], q: "宇宙背景輻射證明了", a: "大霹靂理論" },
            { s:"地科", t:["高一","天文"], q: "哈伯定律描述", a: "宇宙正在膨脹" },
            { s:"地科", t:["高一","天文"], q: "星等數值越小", a: "亮度越亮" },
            { s:"地科", t:["高一","地質"], q: "絕對地質年代測定", a: "放射性元素定年法" },
            { s:"地科", t:["高一","氣候"], q: "聖嬰現象特徵", a: "東太平洋海水異常增溫" },
            { s:"地科", t:["高一","氣候"], q: "科氏力在北半球", a: "向右偏轉" },
            { s:"地科", t:["高一","海洋"], q: "溫鹽環流的驅動力", a: "密度差異(溫度與鹽度)" },
            // [國八] 物質與反應 (Chemistry - Matter & Reactions)
            { s:"化學", t:["國八","物質"], q: "空氣中含量最多的氣體", a: "氮氣" },
            { s:"化學", t:["國八","物質"], q: "惰性氣體 (鈍氣)", a: "氦、氖、氬" },
            { s:"化學", t:["國八","物質"], q: "純物質", a: "有固定的組成與性質" },
            { s:"化學", t:["國八","物質"], q: "混合物", a: "無固定的熔點與沸點" },
            { s:"化學", t:["國八","原子"], q: "道耳頓原子說", a: "原子不可分割 (後被修正)" },
            { s:"化學", t:["國八","原子"], q: "原子核內帶正電粒子", a: "質子" },
            { s:"化學", t:["國八","原子"], q: "原子核內不帶電粒子", a: "中子" },
            { s:"化學", t:["國八","原子"], q: "繞核旋轉帶負電粒子", a: "電子" },
            { s:"化學", t:["國八","原子"], q: "質量數", a: "質子數 + 中子數" },
            { s:"化學", t:["國八","原子"], q: "原子序", a: "質子數" },
            { s:"化學", t:["國八","週期表"], q: "週期表縱行稱為", a: "族 (化學性質相似)" },
            { s:"化學", t:["國八","週期表"], q: "週期表橫列稱為", a: "週期" },
            { s:"化學", t:["國八","反應"], q: "質量守恆定律", a: "反應前後總質量不變" },
            { s:"化學", t:["國八","反應"], q: "莫耳 (Mole)", a: "6 x 10²³ 個粒子" },
            { s:"化學", t:["國八","反應"], q: "吸熱反應", a: "周圍溫度下降" },
            { s:"化學", t:["國八","反應"], q: "放熱反應", a: "周圍溫度上升" },
            // [國九] 電解質與酸鹼 (Chemistry - Electrolytes, Acids & Bases)
            { s:"化學", t:["國九","電解質"], q: "電解質定義", a: "溶於水能導電的化合物" },
            { s:"化學", t:["國九","酸鹼"], q: "酸的定義 (阿瑞尼士)", a: "溶於水產生氫離子(H+)" },
            { s:"化學", t:["國九","酸鹼"], q: "鹼的定義 (阿瑞尼士)", a: "溶於水產生氫氧根離子(OH-)" },
            { s:"化學", t:["國九","酸鹼"], q: "pH值小於7", a: "酸性" },
            { s:"化學", t:["國九","酸鹼"], q: "pH值大於7", a: "鹼性" },
            { s:"化學", t:["國九","酸鹼"], q: "酸鹼中和產物", a: "鹽 + 水 (+熱)" },
            { s:"化學", t:["國九","氧化"], q: "氧化反應", a: "物質與氧結合 (失去電子)" },
            { s:"化學", t:["國九","氧化"], q: "還原反應", a: "失去氧 (得到電子)" },
            { s:"化學", t:["國九","氧化"], q: "抗氧化劑", a: "自身發生氧化，保護其他物質" },
            { s:"化學", t:["國九","有機"], q: "有機化合物", a: "含碳的化合物 (除CO, CO2, 碳酸鹽等)" },
            { s:"化學", t:["國九","有機"], q: "烴類", a: "只含碳、氫的有機物" },
            { s:"化學", t:["國九","有機"], q: "天然氣主要成分", a: "甲烷 (CH4)" },
            { s:"化學", t:["國九","有機"], q: "液化石油氣(桶裝瓦斯)", a: "丙烷、丁烷" },
            { s:"化學", t:["國九","有機"], q: "發酵法製酒", a: "醣類分解為酒精與二氧化碳" },
            { s:"化學", t:["國九","有機"], q: "皂化反應", a: "油脂 + 鹼 -> 肥皂 + 甘油" },
            // [高中] 進階化學 (High School Chemistry)
            { s:"化學", t:["高一","鍵結"], q: "離子鍵", a: "金屬與非金屬間的靜電吸引力" },
            { s:"化學", t:["高一","鍵結"], q: "共價鍵", a: "非金屬間共用電子對" },
            { s:"化學", t:["高一","鍵結"], q: "金屬鍵", a: "電子海與金屬陽離子" },
            { s:"化學", t:["高一","計量"], q: "限量試劑", a: "反應中先被耗盡的反應物" },
            { s:"化學", t:["高二","氣體"], q: "理想氣體方程式", a: "PV = nRT" },
            { s:"化學", t:["高二","氣體"], q: "波以耳定律", a: "定溫下，PV = 定值" },
            { s:"化學", t:["高二","氣體"], q: "查理定律", a: "定壓下，V/T = 定值" },
            { s:"化學", t:["高二","反應"], q: "反應速率影響因素", a: "本性、濃度、溫度、催化劑、表面積" },
            { s:"化學", t:["高二","平衡"], q: "勒沙特列原理", a: "平衡移動以抵銷外加因素" },
            { s:"化學", t:["高二","酸鹼"], q: "緩衝溶液", a: "能抵抗pH值劇烈變化的溶液" }
        ];
        ];

        // ----------------------
        // 年級分池
        // ----------------------
        const grades = ["國八","國九","高一","高二","高三"];
        const gradePools = {};

        grades.forEach(g => {
            gradePools[g] = scienceDB
                .filter(item => item.t[0] === g)
                .map(item => {
                    const correctAns = item.a.trim();
                    const selectedAnswers = new Set([correctAns]);
                    const wrongOptions = [];

                    // 優先同科目
                    const sameSubjectCandidates = shuffle(scienceDB.filter(x => x.s === item.s && x.a.trim() !== correctAns));
                    for (const cand of sameSubjectCandidates) {
                        const candAns = cand.a.trim();
                        if (!selectedAnswers.has(candAns)) {
                            wrongOptions.push(candAns);
                            selectedAnswers.add(candAns);
                        }
                        if (wrongOptions.length >= 3) break;
                    }

                    // 補足全庫
                    if (wrongOptions.length < 3) {
                        const allCandidates = shuffle(scienceDB);
                        for (const cand of allCandidates) {
                            const candAns = cand.a.trim();
                            if (!selectedAnswers.has(candAns)) {
                                wrongOptions.push(candAns);
                                selectedAnswers.add(candAns);
                            }
                            if (wrongOptions.length >= 3) break;
                        }
                    }

                    const finalOptions = shuffle([correctAns, ...wrongOptions]);
                    return {
                        question: `【${item.s}】${item.q}`,
                        options: finalOptions,
                        answer: finalOptions.indexOf(correctAns),
                        concept: item.t[1],
                        grade: item.t[0],
                        explanation: [`正確答案：${item.a}`]
                    };
                });
        });

        console.log("✅ 年級分池題庫已生成", gradePools);

    init();
})(window);

