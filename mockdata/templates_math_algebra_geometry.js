(function (global) {
    'use strict';

    function init() {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        if (!G || !G.registerTemplate) {
            setTimeout(init, 100);
            return;
        }

        const { randInt, pick, shuffle } = G.utils;

        // ===============================
        // å·¥å…·
        // ===============================
        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);

        const toFrac = (n, d) => {
            if (d === 0) return "undefined";
            if (n === 0) return "0";
            const g = Math.abs(gcd(n, d));
            n /= g; d /= g;
            if (d < 0) { n = -n; d = -d; }
            return d === 1 ? `${n}` : `${n}/${d}`;
        };

        const fix = n => parseFloat(n.toFixed(2));

        function generateSmartOptions(ans) {
            const s = new Set([ans]);
            if (typeof ans === 'number') {
                s.add(ans + 1);
                s.add(ans - 1);
                s.add(ans * 2);
                s.add(fix(ans / 2));
            } else {
                s.add("0");
                s.add("1");
            }
            return shuffle([...s]).slice(0, 4);
        }

        // ===============================
        // ğŸ‘‰ æ‚¨çš„åŸ mathDBï¼ˆå®Œæ•´ä¿ç•™ï¼‰
        // ===============================
        const mathDB = [
            // =========================
            // åœ‹ä¸ƒ (Grade 7)
            // =========================
            { tag: ["åœ‹ä¸ƒ","æ•´æ•¸"], t:"æ•´æ•¸åŠ æ¸›", gen:()=>({a:randInt(10,99), b:randInt(10,99)}), q:(v)=>`${v.a} + (-${v.b}) = ?`, a:(v)=>v.a-v.b },
            { tag: ["åœ‹ä¸ƒ","æ•´æ•¸"], t:"æ•´æ•¸ä¹˜æ³•", gen:()=>({a:randInt(-20,-2), b:randInt(2,15)}), q:(v)=>`(${v.a}) Ã— ${v.b} = ?`, a:(v)=>v.a*v.b },
            { tag: ["åœ‹ä¸ƒ","æ•´æ•¸"], t:"çµ•å°å€¼", gen:()=>({a:randInt(-50,-10)}), q:(v)=>`|${v.a}| + |${v.a+5}| = ?`, a:(v)=>Math.abs(v.a)+Math.abs(v.a+5) },
            { tag: ["åœ‹ä¸ƒ","æ•´æ•¸"], t:"æŒ‡æ•¸é‹ç®—", gen:()=>({b:randInt(2,5), e:randInt(2,4)}), q:(v)=>`(-${v.b})^${v.e} = ?`, a:(v)=>Math.pow(-v.b, v.e) },
            { tag: ["åœ‹ä¸ƒ","æ•´æ•¸"], t:"ç§‘å­¸è¨˜è™Ÿ", gen:()=>({a:randInt(1,9), n:randInt(3,7)}), q:(v)=>`${v.a} Ã— 10^${v.n} å±•é–‹å¾Œæ˜¯å¹¾ä½æ•¸ï¼Ÿ`, a:(v)=>v.n+1 },
            
            { tag: ["åœ‹ä¸ƒ","åˆ†æ•¸"], t:"åˆ†æ•¸åŠ æ³•", gen:()=>({n1:1, d1:randInt(2,5), n2:1, d2:randInt(2,5)}), q:(v)=>`${v.n1}/${v.d1} + ${v.n2}/${v.d2} = ?`, a:(v)=>toFrac(v.n1*v.d2+v.n2*v.d1, v.d1*v.d2), isFrac:true },
            { tag: ["åœ‹ä¸ƒ","åˆ†æ•¸"], t:"åˆ†æ•¸ä¹˜æ³•", gen:()=>({n:randInt(1,5), d:randInt(2,8)}), q:(v)=>`(${v.n}/${v.d}) Ã— (${v.d}/${v.n+1}) = ?`, a:(v)=>toFrac(v.n, v.n+1), isFrac:true },
            { tag: ["åœ‹ä¸ƒ","åˆ†æ•¸"], t:"åˆ†æ•¸é™¤æ³•", gen:()=>({a:randInt(2,5), b:randInt(2,5)}), q:(v)=>`(${v.a}/${v.b}) Ã· (${v.a}/${v.b}) = ?`, a:(v)=>"1", isFrac:true },
            { tag: ["åœ‹ä¸ƒ","åˆ†æ•¸"], t:"æœ€ç°¡åˆ†æ•¸", gen:()=>({k:randInt(2,5), n:randInt(1,10), d:randInt(11,20)}), q:(v)=>`${v.k*v.n}/${v.k*v.d} åŒ–ç‚ºæœ€ç°¡åˆ†æ•¸ç‚ºä½•ï¼Ÿ`, a:(v)=>toFrac(v.n, v.d), isFrac:true },
            
            { tag: ["åœ‹ä¸ƒ","ä¸€å…ƒä¸€æ¬¡"], t:"è§£æ–¹ç¨‹å¼", gen:()=>({a:randInt(2,9), b:randInt(10,50)}), q:(v)=>`${v.a}x = ${v.b}ï¼Œx = ?`, a:(v)=>toFrac(v.b, v.a), isFrac:true },
            { tag: ["åœ‹ä¸ƒ","ä¸€å…ƒä¸€æ¬¡"], t:"ç§»é …æ³•å‰‡", gen:()=>({a:randInt(2,5), b:randInt(1,9), c:randInt(10,20)}), q:(v)=>`${v.a}x + ${v.b} = ${v.c}ï¼Œx = ?`, a:(v)=>toFrac(v.c-v.b, v.a), isFrac:true },
            { tag: ["åœ‹ä¸ƒ","ä¸€å…ƒä¸€æ¬¡"], t:"åˆ†é…å¾‹", gen:()=>({a:randInt(2,5)}), q:(v)=>`${v.a}(x + 2) = ${v.a*4}ï¼Œx = ?`, a:(v)=>2 },
            
            { tag: ["åœ‹ä¸ƒ","æ¯”ä¾‹"], t:"æ¯”ä¾‹å¼", gen:()=>({a:randInt(2,5), b:randInt(6,10)}), q:(v)=>`x : ${v.a} = ${v.b} : 1ï¼Œx = ?`, a:(v)=>v.a*v.b },
            { tag: ["åœ‹ä¸ƒ","æ¯”ä¾‹"], t:"é€£æ¯”ä¾‹", gen:()=>({a:2, b:3, c:4}), q:(v)=>`è‹¥ x:y:z = ${v.a}:${v.b}:${v.c}ï¼Œä¸” x=${v.a*10}ï¼Œå‰‡ z = ?`, a:(v)=>v.c*10 },
            { tag: ["åœ‹ä¸ƒ","å‡½æ•¸"], t:"å‡½æ•¸å€¼", gen:()=>({a:randInt(2,5), b:randInt(1,10), x:randInt(1,5)}), q:(v)=>`f(x) = ${v.a}x - ${v.b}ï¼Œf(${v.x}) = ?`, a:(v)=>v.a*v.x - v.b },

            // =========================
            // åœ‹å…« (Grade 8)
            // =========================
            { tag: ["åœ‹å…«","ä¹˜æ³•å…¬å¼"], t:"å’Œå¹³æ–¹", gen:()=>({a:randInt(10,50)}), q:(v)=>`${v.a}Â² + 2Ã—${v.a}Ã—1 + 1 = ?`, a:(v)=>(v.a+1)**2 },
            { tag: ["åœ‹å…«","ä¹˜æ³•å…¬å¼"], t:"å·®å¹³æ–¹", gen:()=>({a:randInt(20,50)}), q:(v)=>`${v.a}Â² - 2Ã—${v.a}Ã—2 + 4 = ?`, a:(v)=>(v.a-2)**2 },
            { tag: ["åœ‹å…«","ä¹˜æ³•å…¬å¼"], t:"å¹³æ–¹å·®", gen:()=>({a:randInt(50,100)}), q:(v)=>`${v.a}Â² - ${v.a-1}Â² = ?`, a:(v)=>v.a*2-1 },
            
            { tag: ["åœ‹å…«","å¤šé …å¼"], t:"å¤šé …å¼åŠ æ³•", gen:()=>({a:randInt(2,5), b:randInt(2,5)}), q:(v)=>`(${v.a}x + 1) + (${v.b}x - 1) = ?`, a:(v)=>`${v.a+v.b}x`, type:'text', opts:(v)=>[ `${v.a+v.b}x`, `${v.a+v.b}x+2`, `${v.a*v.b}x`, `${v.a+v.b}` ] },
            { tag: ["åœ‹å…«","å¤šé …å¼"], t:"å¤šé …å¼ä¹˜æ³•", gen:()=>({a:randInt(2,5)}), q:(v)=>`x(x + ${v.a}) = ?`, a:(v)=>`x^2 + ${v.a}x`, type:'text', opts:(v)=>[ `x^2 + ${v.a}x`, `x^2 + ${v.a}`, `2x + ${v.a}`, `x + ${v.a}x` ] },
            
            { tag: ["åœ‹å…«","æ ¹è™Ÿ"], t:"æ ¹è™ŸåŒ–ç°¡", gen:()=>({a:randInt(2,9)}), q:(v)=>`âˆš${v.a*v.a} = ?`, a:(v)=>v.a },
            { tag: ["åœ‹å…«","æ ¹è™Ÿ"], t:"æ ¹è™ŸåŠ æ¸›", gen:()=>({a:randInt(2,5)}), q:(v)=>`3âˆš${v.a} + 2âˆš${v.a} = ?`, a:(v)=>`5âˆš${v.a}`, type:'text', opts:(v)=>[ `5âˆš${v.a}`, `6âˆš${v.a}`, `âˆš${v.a*5}`, `5` ] },
            { tag: ["åœ‹å…«","æ ¹è™Ÿ"], t:"ç•¢æ°å®šç†", gen:()=>pick([{a:3,b:4,c:5},{a:5,b:12,c:13},{a:8,b:15,c:17},{a:6,b:8,c:10}]), q:(v)=>`ç›´è§’ä¸‰è§’å½¢å…©è‚¡ ${v.a}, ${v.b}ï¼Œæ–œé‚Š = ?`, a:(v)=>v.c },
            
            { tag: ["åœ‹å…«","å› å¼åˆ†è§£"], t:"æå…¬å› å¼", gen:()=>({a:randInt(2,5)}), q:(v)=>`${v.a}xÂ² + ${v.a}x å› å¼åˆ†è§£ç‚ºä½•ï¼Ÿ`, a:(v)=>`${v.a}x(x+1)`, type:'text', opts:(v)=>[ `${v.a}x(x+1)`, `${v.a}(x^2+x)`, `x(${v.a}x+${v.a})`, `${v.a}x(x-1)` ] },
            { tag: ["åœ‹å…«","å› å¼åˆ†è§£"], t:"åå­—äº¤ä¹˜", gen:()=>({a:2, b:3}), q:(v)=>`xÂ² + 5x + 6 å› å¼åˆ†è§£ç‚ºä½•ï¼Ÿ`, a:(v)=>`(x+2)(x+3)`, type:'text', opts:(v)=>[ `(x+2)(x+3)`, `(x-2)(x-3)`, `(x+1)(x+6)`, `(x-1)(x-6)` ] },
            
            { tag: ["åœ‹å…«","ä¸€å…ƒäºŒæ¬¡"], t:"è§£æ–¹ç¨‹å¼", gen:()=>({a:randInt(2,5)}), q:(v)=>`xÂ² = ${v.a*v.a}ï¼Œx = ?`, a:(v)=>`Â±${v.a}`, type:'text', opts:(v)=>[ `Â±${v.a}`, `${v.a}`, `-${v.a}`, `${v.a*v.a}` ] },
            { tag: ["åœ‹å…«","ä¸€å…ƒäºŒæ¬¡"], t:"å…¬å¼è§£", gen:()=>({}), q:(v)=>`æ–¹ç¨‹å¼ axÂ² + bx + c = 0 çš„åˆ¤åˆ¥å¼ç‚ºä½•ï¼Ÿ`, a:(v)=>`bÂ² - 4ac`, type:'text', opts:(v)=>[ `bÂ² - 4ac`, `bÂ² + 4ac`, `b - 4ac`, `2a` ] },
            
            { tag: ["åœ‹å…«","æ•¸åˆ—"], t:"ç­‰å·®æ•¸åˆ—", gen:()=>({a1:randInt(1,10), d:randInt(2,5)}), q:(v)=>`é¦–é … ${v.a1}ï¼Œå…¬å·® ${v.d}ï¼Œç¬¬ 10 é …ç‚ºä½•ï¼Ÿ`, a:(v)=>v.a1 + 9*v.d },
            { tag: ["åœ‹å…«","æ•¸åˆ—"], t:"ç­‰å·®ç´šæ•¸", gen:()=>({n:10, a1:1, an:10}), q:(v)=>`1 + 2 + ... + 10 = ?`, a:(v)=>55 },
            { tag: ["åœ‹å…«","å¹¾ä½•"], t:"å…§è§’å’Œ", gen:()=>({n:randInt(4,8)}), q:(v)=>`${v.n} é‚Šå½¢å…§è§’å’Œç‚ºå¹¾åº¦ï¼Ÿ`, a:(v)=>(v.n-2)*180 },

            // =========================
            // åœ‹ä¹ (Grade 9)
            // =========================
            { tag: ["åœ‹ä¹","å¹¾ä½•"], t:"ç›¸ä¼¼å½¢", gen:()=>({k:randInt(2,4)}), q:(v)=>`è‹¥ Î”ABC ~ Î”DEFï¼Œé‚Šé•·æ¯” 1:${v.k}ï¼Œå‰‡é¢ç©æ¯”ç‚ºä½•ï¼Ÿ`, a:(v)=>`1:${v.k*v.k}`, type:'text', opts:(v)=>[ `1:${v.k*v.k}`, `1:${v.k}`, `1:${v.k*2}`, `1:${v.k+2}` ] },
            { tag: ["åœ‹ä¹","å¹¾ä½•"], t:"å…¨ç­‰æ€§è³ª", gen:()=>({}), q:(v)=>`ä¸‹åˆ—ä½•è€…ä¸æ˜¯ä¸‰è§’å½¢å…¨ç­‰æ€§è³ªï¼Ÿ`, a:(v)=>`AAA`, type:'text', opts:(v)=>[ `AAA`, `SAS`, `SSS`, `AAS` ] },
            { tag: ["åœ‹ä¹","åœ“"], t:"åœ“å‘¨é•·", gen:()=>({r:randInt(2,10)}), q:(v)=>`åŠå¾‘ ${v.r} çš„åœ“å‘¨é•·ï¼Ÿ`, a:(v)=>`2Ï€Ã—${v.r}`, type:'text', opts:(v)=>[ `${2*v.r}Ï€`, `${v.r*v.r}Ï€`, `${v.r}Ï€`, `${4*v.r}Ï€` ] },
            { tag: ["åœ‹ä¹","åœ“"], t:"åœ“é¢ç©", gen:()=>({r:randInt(2,10)}), q:(v)=>`åŠå¾‘ ${v.r} çš„åœ“é¢ç©ï¼Ÿ`, a:(v)=>`${v.r*v.r}Ï€`, type:'text', opts:(v)=>[ `${v.r*v.r}Ï€`, `${2*v.r}Ï€`, `${v.r}Ï€`, `${v.r/2}Ï€` ] },
            { tag: ["åœ‹ä¹","åœ“"], t:"åœ“å¿ƒè§’", gen:()=>({d:pick([30,45,60,90])}), q:(v)=>`å¼§åº¦ ${v.d}Â° å°æ‡‰çš„åœ“å¿ƒè§’ç‚ºä½•ï¼Ÿ`, a:(v)=>v.d },
            
            { tag: ["åœ‹ä¹","äºŒæ¬¡å‡½æ•¸"], t:"é ‚é»", gen:()=>({h:randInt(1,5), k:randInt(1,5)}), q:(v)=>`y = (x - ${v.h})Â² + ${v.k} çš„é ‚é»ï¼Ÿ`, a:(v)=>`(${v.h}, ${v.k})`, type:'text', opts:(v)=>[ `(${v.h}, ${v.k})`, `(-${v.h}, ${v.k})`, `(${v.h}, -${v.k})`, `(0, 0)` ] },
            { tag: ["åœ‹ä¹","äºŒæ¬¡å‡½æ•¸"], t:"é–‹å£æ–¹å‘", gen:()=>({a:randInt(1,5)}), q:(v)=>`y = -${v.a}xÂ² çš„é–‹å£æ–¹å‘ï¼Ÿ`, a:(v)=>`å‘ä¸‹`, type:'text', opts:(v)=>[ `å‘ä¸‹`, `å‘ä¸Š`, `å‘å·¦`, `å‘å³` ] },
            { tag: ["åœ‹ä¹","äºŒæ¬¡å‡½æ•¸"], t:"æ¥µå€¼", gen:()=>({k:randInt(1,10)}), q:(v)=>`y = xÂ² + ${v.k} çš„æœ€å°å€¼ï¼Ÿ`, a:(v)=>v.k },
            
            { tag: ["åœ‹ä¹","æ©Ÿç‡"], t:"éª°å­", gen:()=>({}), q:(v)=>`æ“²ä¸€é¡†éª°å­ï¼Œå‡ºç¾å¶æ•¸çš„æ©Ÿç‡ï¼Ÿ`, a:(v)=>`1/2`, type:'text', opts:(v)=>[ `1/2`, `1/3`, `1/6`, `2/3` ] },
            { tag: ["åœ‹ä¹","æ©Ÿç‡"], t:"ç¡¬å¹£", gen:()=>({}), q:(v)=>`æŠ•æ“²å…©æšç¡¬å¹£ï¼Œä¸€æ­£ä¸€åçš„æ©Ÿç‡ï¼Ÿ`, a:(v)=>`1/2`, type:'text', opts:(v)=>[ `1/2`, `1/4`, `3/4`, `1/3` ] },
            { tag: ["åœ‹ä¹","çµ±è¨ˆ"], t:"ä¸­ä½æ•¸", gen:()=>({a:randInt(1,9)}), q:(v)=>`æ•¸æ“š 1, 2, ${v.a+2}, 9, 10 çš„ä¸­ä½æ•¸ï¼Ÿ`, a:(v)=>v.a+2 },
            { tag: ["åœ‹ä¹","çµ±è¨ˆ"], t:"çœ¾æ•¸", gen:()=>({a:randInt(1,9)}), q:(v)=>`æ•¸æ“š 1, ${v.a}, 2, ${v.a}, 3 çš„çœ¾æ•¸ï¼Ÿ`, a:(v)=>v.a },
            { tag: ["åœ‹ä¹","çµ±è¨ˆ"], t:"å››åˆ†ä½æ•¸", gen:()=>({}), q:(v)=>`Q2 ä»£è¡¨ä»€éº¼ï¼Ÿ`, a:(v)=>`ä¸­ä½æ•¸`, type:'text', opts:(v)=>[ `ä¸­ä½æ•¸`, `å¹³å‡æ•¸`, `çœ¾æ•¸`, `æœ€å¤§å€¼` ] },
            
            { tag: ["åœ‹ä¹","ç«‹é«”"], t:"æŸ±é«”é«”ç©", gen:()=>({a:randInt(2,5), h:randInt(2,5)}), q:(v)=>`åº•é¢ç© ${v.a}ï¼Œé«˜ ${v.h} çš„æŸ±é«”é«”ç©ï¼Ÿ`, a:(v)=>v.a*v.h },
            { tag: ["åœ‹ä¹","ç«‹é«”"], t:"éŒé«”é«”ç©", gen:()=>({a:randInt(3,9), h:randInt(2,5)}), q:(v)=>`åº•é¢ç© ${v.a}ï¼Œé«˜ ${v.h} çš„éŒé«”é«”ç©ï¼Ÿ`, a:(v)=>v.a*v.h/3 },

            // =========================
            // é«˜ä¸€ (Grade 10)
            // =========================
            { tag: ["é«˜ä¸€","ç›´ç·š"], t:"æ–œç‡", gen:()=>({x:randInt(2,5), y:randInt(2,5)}), q:(v)=>`éåŸé»èˆ‡ (${v.x},${v.y}) çš„ç›´ç·šæ–œç‡ï¼Ÿ`, a:(v)=>toFrac(v.y, v.x), isFrac:true },
            { tag: ["é«˜ä¸€","ç›´ç·š"], t:"å¹³è¡Œç·š", gen:()=>({m:randInt(2,5)}), q:(v)=>`èˆ‡ç›´ç·š y=${v.m}x+1 å¹³è¡Œçš„æ–œç‡ï¼Ÿ`, a:(v)=>v.m },
            { tag: ["é«˜ä¸€","ç›´ç·š"], t:"å‚ç›´ç·š", gen:()=>({m:randInt(2,5)}), q:(v)=>`èˆ‡ç›´ç·š y=${v.m}x å‚ç›´çš„æ–œç‡ï¼Ÿ`, a:(v)=>toFrac(-1, v.m), isFrac:true },
            { tag: ["é«˜ä¸€","ç›´ç·š"], t:"æˆªè·", gen:()=>({b:randInt(2,9)}), q:(v)=>`ç›´ç·š y=2x + ${v.b} çš„ y æˆªè·ï¼Ÿ`, a:(v)=>v.b },
            
            { tag: ["é«˜ä¸€","å¤šé …å¼"], t:"é¤˜å¼å®šç†", gen:()=>({r:randInt(1,5)}), q:(v)=>`f(x) é™¤ä»¥ (x-1) é¤˜å¼ç‚º ${v.r}ï¼Œå‰‡ f(1)=?`, a:(v)=>v.r },
            { tag: ["é«˜ä¸€","å¤šé …å¼"], t:"å› å¼å®šç†", gen:()=>({a:randInt(1,5)}), q:(v)=>`è‹¥ (x-${v.a}) æ˜¯ f(x) çš„å› å¼ï¼Œå‰‡ f(${v.a})=?`, a:(v)=>0 },
            { tag: ["é«˜ä¸€","å¤šé …å¼"], t:"é™¤æ³•åŸç†", gen:()=>({}), q:(v)=>`è¢«é™¤å¼ = é™¤å¼ Ã— å•†å¼ + ?`, a:(v)=>`é¤˜å¼`, type:'text', opts:(v)=>[ `é¤˜å¼`, `å› å¼`, `é›¶`, `ä¿‚æ•¸` ] },
            
            { tag: ["é«˜ä¸€","æŒ‡æ•¸"], t:"æŒ‡æ•¸å¾‹", gen:()=>({n:randInt(2,5)}), q:(v)=>`(2^${v.n})^2 = 2çš„å¹¾æ¬¡æ–¹ï¼Ÿ`, a:(v)=>v.n*2 },
            { tag: ["é«˜ä¸€","æŒ‡æ•¸"], t:"è² æŒ‡æ•¸", gen:()=>({n:randInt(2,5)}), q:(v)=>`2^(-${v.n}) ç­‰æ–¼ï¼Ÿ`, a:(v)=>toFrac(1, Math.pow(2,v.n)), isFrac:true },
            { tag: ["é«˜ä¸€","å°æ•¸"], t:"å°æ•¸å®šç¾©", gen:()=>({n:randInt(2,5)}), q:(v)=>`logâ‚‚(${Math.pow(2,v.n)}) = ?`, a:(v)=>v.n },
            { tag: ["é«˜ä¸€","å°æ•¸"], t:"å°æ•¸å¾‹", gen:()=>({}), q:(v)=>`log A + log B = ?`, a:(v)=>`log(AB)`, type:'text', opts:(v)=>[ `log(AB)`, `log(A+B)`, `log(A/B)`, `log(A)+log(B)` ] },
            
            { tag: ["é«˜ä¸€","ä¸ç­‰å¼"], t:"ä¸€å…ƒäºŒæ¬¡", gen:()=>({}), q:(v)=>`xÂ² < 0 çš„å¯¦æ•¸è§£ï¼Ÿ`, a:(v)=>`ç„¡è§£`, type:'text', opts:(v)=>[ `ç„¡è§£`, `0`, `å…¨é«”å¯¦æ•¸`, `1` ] },
            { tag: ["é«˜ä¸€","ä¸ç­‰å¼"], t:"çµ•å°å€¼", gen:()=>({k:randInt(2,5)}), q:(v)=>`|x| < ${v.k} çš„ç¯„åœï¼Ÿ`, a:(v)=>`-${v.k} < x < ${v.k}`, type:'text', opts:(v)=>[ `-${v.k} < x < ${v.k}`, `x > ${v.k}`, `x < -${v.k}`, `ç„¡è§£` ] },
            { tag: ["é«˜ä¸€","æ•¸æ“š"], t:"æ¨™æº–å·®", gen:()=>({}), q:(v)=>`æ•¸æ“šçš†ç‚º 5ï¼Œæ¨™æº–å·®ç‚ºä½•ï¼Ÿ`, a:(v)=>0 },
            { tag: ["é«˜ä¸€","æ•¸æ“š"], t:"ç›¸é—œä¿‚æ•¸", gen:()=>({}), q:(v)=>`å®Œå…¨æ­£ç›¸é—œçš„ä¿‚æ•¸ r = ?`, a:(v)=>1 },

            // =========================
            // é«˜äºŒ (Grade 11)
            // =========================
            { tag: ["é«˜äºŒ","ä¸‰è§’"], t:"æ­£å¼¦å€¼", gen:()=>({}), q:(v)=>`sin(30Â°) = ?`, a:(v)=>`1/2`, type:'text', opts:(v)=>[ `1/2`, `âˆš3/2`, `1`, `0` ] },
            { tag: ["é«˜äºŒ","ä¸‰è§’"], t:"é¤˜å¼¦å€¼", gen:()=>({}), q:(v)=>`cos(0Â°) = ?`, a:(v)=>1 },
            { tag: ["é«˜äºŒ","ä¸‰è§’"], t:"æ­£åˆ‡å€¼", gen:()=>({}), q:(v)=>`tan(45Â°) = ?`, a:(v)=>1 },
            { tag: ["é«˜äºŒ","ä¸‰è§’"], t:"å»£ç¾©è§’", gen:()=>({}), q:(v)=>`sin(180Â°) = ?`, a:(v)=>0 },
            { tag: ["é«˜äºŒ","ä¸‰è§’"], t:"æ­£å¼¦å®šç†", gen:()=>({}), q:(v)=>`a/sinA = ?`, a:(v)=>`2R`, type:'text', opts:(v)=>[ `2R`, `R`, `RÂ²`, `abc` ] },
            { tag: ["é«˜äºŒ","ä¸‰è§’"], t:"é¤˜å¼¦å®šç†", gen:()=>({}), q:(v)=>`cÂ² = aÂ² + bÂ² - ?`, a:(v)=>`2ab cosC`, type:'text', opts:(v)=>[ `2ab cosC`, `2ab sinC`, `ab cosC`, `0` ] },
            
            { tag: ["é«˜äºŒ","å‘é‡"], t:"å‘é‡åŠ æ³•", gen:()=>({x1:1, y1:2, x2:3, y2:4}), q:(v)=>`(${v.x1},${v.y1}) + (${v.x2},${v.y2}) = ?`, a:(v)=>`(${v.x1+v.x2}, ${v.y1+v.y2})`, type:'text', opts:(v)=>[ `(4, 6)`, `(2, 2)`, `(3, 8)`, `(0, 0)` ] },
            { tag: ["é«˜äºŒ","å‘é‡"], t:"å…§ç©", gen:()=>({}), q:(v)=>`i Â· j (å–®ä½å‘é‡) = ?`, a:(v)=>0 },
            { tag: ["é«˜äºŒ","å‘é‡"], t:"é•·åº¦", gen:()=>({a:3, b:4}), q:(v)=>`å‘é‡ (3, 4) çš„é•·åº¦ï¼Ÿ`, a:(v)=>5 },
            { tag: ["é«˜äºŒ","å‘é‡"], t:"æŸ¯è¥¿ä¸ç­‰å¼", gen:()=>({}), q:(v)=>`|u||v| â‰¥ ?`, a:(v)=>`|uÂ·v|`, type:'text', opts:(v)=>[ `|uÂ·v|`, `u+v`, `0`, `1` ] },
            
            { tag: ["é«˜äºŒ","çŸ©é™£"], t:"çŸ©é™£åŠ æ³•", gen:()=>({}), q:(v)=>`[1 2] + [3 4] = ?`, a:(v)=>`[4 6]`, type:'text', opts:(v)=>[ `[4 6]`, `[3 8]`, `[2 2]`, `[1 3]` ] },
            { tag: ["é«˜äºŒ","çŸ©é™£"], t:"è¡Œåˆ—å¼", gen:()=>({a:randInt(1,5), d:randInt(1,5)}), q:(v)=>`| ${v.a} 0 |\n| 0 ${v.d} | = ?`, a:(v)=>v.a*v.d },
            { tag: ["é«˜äºŒ","çŸ©é™£"], t:"å–®ä½æ–¹é™£", gen:()=>({}), q:(v)=>`Iâ‚‚ çš„è¡Œåˆ—å¼å€¼ï¼Ÿ`, a:(v)=>1 },
            { tag: ["é«˜äºŒ","ç©ºé–“"], t:"è·é›¢", gen:()=>({z:randInt(3,9)}), q:(v)=>`é» (1, 2, ${v.z}) åˆ° xy å¹³é¢çš„è·é›¢ï¼Ÿ`, a:(v)=>v.z },
            { tag: ["é«˜äºŒ","ç©ºé–“"], t:"å¹³éºµæ–¹ç¨‹å¼", gen:()=>({}), q:(v)=>`z=0 ä»£è¡¨ä»€éº¼å¹³é¢ï¼Ÿ`, a:(v)=>`xyå¹³é¢`, type:'text', opts:(v)=>[ `xyå¹³é¢`, `yzå¹³é¢`, `xzå¹³é¢`, `ç›´ç·š` ] },

            // =========================
            // é«˜ä¸‰ (Grade 12)
            // =========================
            { tag: ["é«˜ä¸‰","æ¥µé™"], t:"æ•¸åˆ—æ¥µé™", gen:()=>({}), q:(v)=>`lim(nâ†’âˆ) 1/n = ?`, a:(v)=>0 },
            { tag: ["é«˜ä¸‰","æ¥µé™"], t:"ç„¡çª®ç´šæ•¸", gen:()=>({}), q:(v)=>`1 + 1/2 + 1/4 + ... = ?`, a:(v)=>2 },
            { tag: ["é«˜ä¸‰","æ¥µé™"], t:"å‡½æ•¸æ¥µé™", gen:()=>({}), q:(v)=>`lim(xâ†’2) xÂ² = ?`, a:(v)=>4 },
            
            { tag: ["é«˜ä¸‰","å¾®åˆ†"], t:"å°å‡½æ•¸", gen:()=>({n:randInt(2,5)}), q:(v)=>`x^${v.n} çš„å°æ•¸ç‚ºï¼Ÿ`, a:(v)=>`${v.n}x^${v.n-1}`, type:'text', opts:(v)=>[ `${v.n}x^${v.n-1}`, `x^${v.n-1}`, `0`, `1` ] },
            { tag: ["é«˜ä¸‰","å¾®åˆ†"], t:"å¸¸æ•¸å¾®åˆ†", gen:()=>({c:randInt(10,99)}), q:(v)=>`f(x)=${v.c}ï¼Œf'(x)=?`, a:(v)=>0 },
            { tag: ["é«˜ä¸‰","å¾®åˆ†"], t:"åˆ‡ç·šæ–œç‡", gen:()=>({}), q:(v)=>`y=x åœ¨ x=1 çš„åˆ‡ç·šæ–œç‡ï¼Ÿ`, a:(v)=>1 },
            
            { tag: ["é«˜ä¸‰","ç©åˆ†"], t:"å®šç©åˆ†", gen:()=>({b:randInt(2,5)}), q:(v)=>`âˆ«(0 to ${v.b}) 1 dx = ?`, a:(v)=>v.b },
            { tag: ["é«˜ä¸‰","ç©åˆ†"], t:"ä¸å®šç©åˆ†", gen:()=>({n:randInt(2,5)}), q:(v)=>`âˆ« x^${v.n-1} dx = ?`, a:(v)=>`x^${v.n}/${v.n}`, type:'text', opts:(v)=>[ `x^${v.n}/${v.n}`, `x^${v.n}`, `x^${v.n-1}`, `0` ] },
            { tag: ["é«˜ä¸‰","ç©åˆ†"], t:"é¢ç©", gen:()=>({}), q:(v)=>`y=x, x=1, xè»¸ åœæˆçš„é¢ç©ï¼Ÿ`, a:(v)=>`1/2`, type:'text', opts:(v)=>[ `1/2`, `1`, `2`, `1/3` ] },
            
            { tag: ["é«˜ä¸‰","æ©Ÿç‡"], t:"æœŸæœ›å€¼", gen:()=>({p:100}), q:(v)=>`ä¸­çç‡ 1/2ï¼Œçé‡‘ ${v.p} å…ƒï¼ŒæœŸæœ›å€¼ï¼Ÿ`, a:(v)=>v.p/2 },
            { tag: ["é«˜ä¸‰","æ©Ÿç‡"], t:"ç¨ç«‹äº‹ä»¶", gen:()=>({}), q:(v)=>`P(Aâˆ©B) = ? (è‹¥ç¨ç«‹)`, a:(v)=>`P(A)P(B)`, type:'text', opts:(v)=>[ `P(A)P(B)`, `P(A)+P(B)`, `0`, `1` ] },
            { tag: ["é«˜ä¸‰","çµ±è¨ˆ"], t:"äºŒé …åˆ†å¸ƒ", gen:()=>({}), q:(v)=>`B(n, p) çš„å¹³å‡æ•¸ï¼Ÿ`, a:(v)=>`np`, type:'text', opts:(v)=>[ `np`, `npq`, `n`, `p` ] }
        ];

        // ===============================
        // è¨»å†Šæ¨¡æ¿ï¼ˆâ­ é—œéµä¿®æ­£ï¼šä¸€å°å¤šæ¨™ç±¤æ˜ å°„ï¼‰
        // ===============================
        mathDB.forEach((p, i) => {
            if (!p.tag || p.tag.length < 2) return;

            const grade = p.tag[0];       // ä¾‹å¦‚ "åœ‹ä¸ƒ"
            const mainConcept = p.tag[1]; // ä¾‹å¦‚ "æ•´æ•¸"
            
            // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šè‡ªå‹•æ“´å±•å­æ¨™ç±¤ â˜…â˜…â˜…
            // å¦‚æœé€™å€‹é¡Œç›®æ˜¯ "æ•´æ•¸"ï¼Œå®ƒæ‡‰è©²è¦èƒ½æ”¯æ´ "æ•´æ•¸çš„åŠ æ¸›"ã€"æ•´æ•¸çš„ä¹˜é™¤" ç­‰æ‰€æœ‰ç›¸é—œå–®å…ƒ
            let extendedTags = [grade, mainConcept];
            
            if (mainConcept === "æ•´æ•¸") extendedTags.push("æ•´æ•¸çš„åŠ æ¸›", "æ•´æ•¸çš„ä¹˜é™¤", "è² æ•¸èˆ‡çµ•å°å€¼");
            if (mainConcept === "åˆ†æ•¸") extendedTags.push("åˆ†æ•¸çš„é‹ç®—", "åˆ†æ•¸çš„åŠ æ¸›ä¹˜é™¤", "å› æ•¸èˆ‡å€æ•¸");
            if (mainConcept === "ä¸€å…ƒä¸€æ¬¡") extendedTags.push("ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¼", "è§£ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¼");
            if (mainConcept === "äºŒå…ƒä¸€æ¬¡") extendedTags.push("äºŒå…ƒä¸€æ¬¡è¯ç«‹æ–¹ç¨‹å¼", "è§£è¯ç«‹æ–¹ç¨‹å¼");
            if (mainConcept === "ä¹˜æ³•å…¬å¼") extendedTags.push("ä¹˜æ³•å…¬å¼", "å¤šé …å¼");
            if (mainConcept === "æ ¹è™Ÿ") extendedTags.push("å¹³æ–¹æ ¹", "æ ¹å¼çš„é‹ç®—");
            if (mainConcept === "å¹¾ä½•") extendedTags.push("å¹¾ä½•åœ–å½¢", "ä¸‰è§’å½¢", "å…¨ç­‰");
            if (mainConcept === "ä¸ç­‰å¼") extendedTags.push("ä¸€å…ƒä¸€æ¬¡ä¸ç­‰å¼", "ä¸ç­‰å¼");
            if (mainConcept === "åæ¨™") extendedTags.push("ç›´è§’åæ¨™", "åœ–å½¢");

            const id = `math_${grade}_${i}`;

            G.registerTemplate(id, () => {
                const v = p.gen ? p.gen() : {};
                const ans = p.a(v);

                let options;
                if (p.isFrac) { // åˆ†æ•¸é¡Œå‹ç‰¹æ®Šè™•ç†
                     options = shuffle([ans, "1", "0", "-1", "1/2"].slice(0,4));
                     if(!options.includes(ans)) options[0] = ans;
                     options = shuffle(options);
                } else if (p.type === "text") {
                    options = shuffle(typeof p.opts === 'function' ? p.opts(v) : p.opts);
                } else {
                    options = generateSmartOptions(ans);
                }

                return {
                    question: `ã€æ•¸å­¸ã€‘${p.q(v)}`,
                    options: options,
                    answer: options.indexOf(ans),
                    concept: p.t || mainConcept, // é¡¯ç¤ºåŸæœ¬çš„å°æ¨™é¡Œ
                    explanation: [`æ­£ç¢ºç­”æ¡ˆæ˜¯ ${ans}`]
                };
            }, ["math", "æ•¸å­¸", ...extendedTags]); // â˜… å°‡æ‰€æœ‰ç›¸é—œæ¨™ç±¤éƒ½è¨»å†Šé€²å»
        });

        console.log("âœ… æ•¸å­¸é¡Œåº«è¼‰å…¥æˆåŠŸï¼ˆå·²å•Ÿç”¨æ¨¡ç³Šæ¨™ç±¤æ“´å±•ï¼‰");
    }

    init();
})(window);
