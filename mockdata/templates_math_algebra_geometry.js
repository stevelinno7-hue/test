(function(global){
    'use strict';

    function init() {
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        if (!G || !G.registerTemplate) { setTimeout(init, 100); return; }
        const { randInt, shuffle, generateNumericOptions } = G.utils;

        // ==========================================
        // 數學科核心資料庫 (Math Core Database)
        // ==================================
       const mathDB = [
  // ==========================================
  // [國七] 數與式、一元一次 (Grade 7)
  // ==========================================
  { t: "整數運算", q: (a,b)=>`若甲數 = ${a}，乙數 = ${-b}，試求 甲 - 2 × 乙 之值為何？`, a: (a,b)=>a - 2*(-b), tag:["國七","整數"] },
  { t: "數線與絕對值", q: (a,b)=>`數線上兩點 A(${a})、B(${-b})，試求 A、B 兩點間的距離。`, a: (a,b)=>Math.abs(a - (-b)), tag:["國七","數線"] },
  { t: "指數律", q: (a,b)=>`計算 (${a}²)³ × ${a}⁴ ÷ ${a}⁵ 之值為何？`, a: (a,b)=>Math.pow(a, 5), tag:["國七","指數"] },
  { t: "科學記號", q: (a,b)=>`將 ${a}0000 寫成科學記號 a × 10ⁿ，求 n`, a: (a,b)=>4, tag:["國七","數與式"] },
  { t: "因數倍數", q: (a,b)=>`求 ${a*6} 與 ${a*8} 的最大公因數`, a: (a,b)=>a*2, tag:["國七","因數"] },
  { t: "一元一次", q: (a,b)=>`若 x 的方程式 ${a}x + ${b} = ${3*a}x - ${b}，則 x = ?`, a: (a,b)=>b/a, tag:["國七","方程式"] },
  { t: "二元一次", q: (a,b)=>`已知 x=${a}, y=${b} 是方程式 mx - y = 0 的一組解，試求 m 之值。`, a: (a,b)=>b/a, tag:["國七","聯立"] },
  { t: "直角坐標", q: (a,b)=>`點 P(${a}, ${b}) 到 x 軸的距離`, a: (a,b)=>Math.abs(b), tag:["國七","坐標"] },
  { t: "比與比例", q: (a,b)=>`若 x : ${a} = ${b} : 2，求 x`, a: (a,b)=>a*b/2, tag:["國七","比例"] },

  { t: "分數加減", q: (a,b)=>`計算 ${a}/${b} + ${b}/${a} 的值（以數字代入）`, a: (a,b)=>a/b + b/a, tag:["國七","分數"] },
  { t: "百分率應用", q: (a,b)=>`某商品原價 ${a} 元，打 ${b}%，折後價為多少？`, a: (a,b)=>a*(1-b/100), tag:["國七","百分率"] },
  { t: "整數因數", q: (a,b)=>`列出 ${a*b} 的所有質因數（簡述）`, qtype:'text', a: ()=>`視 a,b 而定，分解為質因數`, tag:["國七","因數"] },
  { t: "簡單代數應用", q: (a,b)=>`若 3x + 5 = ${a}, 求 x`, a: (a,b)=> (a-5)/3, tag:["國七","方程式"] },
  { t: "面積單位換算", q: (a,b)=>`${a} 平方公尺等於多少平方公分？`, a: (a,b)=>a*10000, tag:["國七","單位"] },

  // ==========================================
  // [國八] 多項式、根號、畢氏 (Grade 8)
  // ==========================================
  { t: "乘法公式", q: (a,b)=>`展開 (${a}x + 1)² 的常數項`, a: (a,b)=>1, tag:["國八","多項式"] },
  { t: "多項式運算", q: (a,b)=>`多項式 A = ${a}x² - 5x，B = x² + ${b}x，求 A + B 的 x 項係數。`, a: (a,b)=> -5+b, tag:["國八","多項式"] },
  { t: "根號運算", q: (a,b)=>`計算 √${a*a} + √${b*b} - √${(a+b)*(a+b)} 之值。`, a: (a,b)=>0, tag:["國八","方根"] },
  { t: "畢氏定理", q: (a,b)=>`直角三角形中，兩股長分別為 ${3*a}、${4*a}，試求斜邊長度。`, a: (a,b)=>5*a, tag:["國八","幾何"] },
  { t: "因式分解", q: (a,b)=>`x² + ${a+b}x + ${a*b} 因式分解為 (x+m)(x+n)，求 m+n`, a: (a,b)=>a+b, tag:["國八","因式分解"] },
  { t: "一元二次", q: (a,b)=>`方程式 x² - ${a*2}x = 0 的正根`, a: (a,b)=>a*2, tag:["國八","方程式"] },
  { t: "等差數列", q: (a,b)=>`一等差數列首項為 ${a}，公差為 ${b}，試求第 10 項之值。`, a: (a,b)=>a + 9*b, tag:["國八","數列"] },
  { t: "多邊形內角", q: (a,b)=>`正 ${a+2} 邊形的內角和度數`, a: (a,b)=>(a)*180, tag:["國八","幾何"] },

  { t: "分式運算", q: (a,b)=>`化簡 (1/${a}) + (1/${b}) 的通分結果`, a: (a,b)=> (a+b)/(a*b), tag:["國八","分式"] },
  { t: "平方差", q: (a,b)=>`計算 (${a}+${b})(${a}-${b}) 的值`, a: (a,b)=>a*a - b*b, tag:["國八","恆等式"] },
  { t: "根號簡化", q: (a,b)=>`化簡 √${a*a*b*b} 的結果`, a: (a,b)=>Math.abs(a*b), tag:["國八","方根"] },
  { t: "面積計算（梯形）", q: (a,b)=>`梯形上下底分別為 ${a} 與 ${b}，高為 5，面積為何？`, a: (a,b)=> (a+b)/2*5, tag:["國八","幾何"] },
  { t: "體積（長方體）", q: (a,b)=>`長 ${a} 寬 ${b} 高 3 的長方體體積為何？`, a: (a,b)=>a*b*3, tag:["國八","立體"] },

  // ==========================================
  // [國九] 二次函數、幾何、機率 (Grade 9)
  // ==========================================
  { t: "相似形", q: (a,b)=>`兩相似三角形的對應邊長比為 1 : ${a}，則其面積比為何？`, a: (a,b)=>a*a, tag:["國九","幾何"] },
  { t: "圓形性質", q: (a,b)=>`一圓的半徑為 ${a}，若扇形的圓心角為 60度，則該扇形面積為何？(π以3計算)`, a: (a,b)=>a*a*3/6, tag:["國九","圓"] },
  { t: "圓周角", q: (a,b)=>`圓周角 40度，其對應的圓心角幾度?`, a: (a,b)=>80, tag:["國九","圓"] },
  { t: "二次函數", q: (a,b)=>`關於二次函數 y = (x - ${a})² + ${b} 的圖形，下列敘述何者正確？`, a: (a,b)=>`頂點坐標為 (${a}, ${b})`, type:'text', opts:(a,b)=>[ `頂點坐標為 (${a}, ${b})`,`開口向下`,`對稱軸為 x = -${a}`,`通過原點`], tag:["國九","二次函數"] },
  { t: "機率", q: (a,b)=>`投擲一顆公正骰子，出現點數小於 ${a} (含) 的機率為何？(假設 ${a} < 7)`, a: (a,b)=>a/6, type:'fraction', opts:(a)=>[ `${a}/6`, `${7-a}/6`, `1/6`, `1/2`], tag:["國九","機率"] },
  { t: "統計", q: (a,b)=>`數據 1, 2, 3, ${a}, ${b} 的中位數 (已排序) 為何？`, a: (a,b)=>3, tag:["國九","統計"] },
  { t: "三角形重心", q: (a,b)=>`三角形重心到頂點距離是到對邊中點距離的幾倍？`, type:'text', opts:['2倍','1.5倍','3倍','1倍'], a:()=>0, tag:['國九','幾何'] },

  { t: "弧長與扇形面積", q: (a,b)=>`半徑 ${a} 圓心角 ${b} 度，弧長為何？(弧長公式)`, a: (a,b)=>2*Math.PI*a*b/360, tag:["國九","圓"] },
  { t: "直角三角形面積", q: (a,b)=>`直角三角形兩直角邊 ${a} 與 ${b}，面積為何？`, a: (a,b)=>0.5*a*b, tag:["國九","幾何"] },
  { t: "排列組合（簡單）", q: (a,b)=>`從 ${a} 個物品選 ${b} 個，順序重要，排列數為何？`, a: (a,b)=>{ let n=a,k=b; let res=1; for(let i=0;i<k;i++) res*= (n-i); return res; }, tag:["國九","組合"] },
  { t: "機率（互斥）", q: (a,b)=>`事件 A 與 B 互斥，P(A)=${a}, P(B)=${b}，P(A∪B)=?`, a: (a,b)=>a+b, tag:["國九","機率"] },

  // ==========================================
  // [高一] 多項式、指數對數、數據分析 (Grade 10)
  // ==========================================
  { t: "餘式定理", q: (a,b)=>`設 f(x) = x³ + ${a}x + ${b}，試求 f(x) 除以 (x-1) 的餘式。`, a: (a,b)=>1+a+b, tag:["高一","多項式"] },
  { t: "直線斜率", q: (a,b)=>`坐標平面上，通過點 (${a}, 0) 與 (0, ${b}) 的直線斜率為何？`, a: (a,b)=> -b/a, tag:["高一","直線"] },
  { t: "指數運算", q: (a,b)=>`化簡 2^${a} × 4^${b} 為 2 的幾次方？`, a: (a,b)=>a+2*b, tag:["高一","指數"] },
  { t: "對數律", q: (a,b)=>`試求 log₂${Math.pow(2, a)} + log₃${Math.pow(3, b)} 之值。`, a: (a,b)=>a+b, tag:["高一","對數"] },
  { t: "數據分析", q: (a,b)=>`若變數 X 與 Y 的相關係數為 1，則兩變數的關係為何？`, a: (a,b)=>`完全正相關`, type:'text', opts:[`完全正相關`,`完全負相關`,`零相關`,`無法判斷`], tag:["高一","數據"] },
  { t: "算幾不等式", q: (a,b)=>`若 a,b > 0 且 a+b=${2*a}，則 ab 最大值為何？`, a: (a,b)=>a*a, tag:["高一","不等式"] },

  { t: "函數映射", q: (a,b)=>`函數 f(x)=2x+${a}，求 f(${b})`, a: (a,b)=>2*b+a, tag:["高一","函數"] },
  { t: "一次不等式", q: (a,b)=>`解不等式 ${a}x + ${b} > 0，x 的範圍為何？`, a: (a,b)=>`x > ${-b/a}`, tag:["高一","不等式"] },
  { t: "座標幾何（中點）", q: (a,b)=>`線段端點 (0,0) 與 (${a},${b}) 的中點座標為何？`, a: (a,b)=>[a/2,b/2], tag:["高一","坐標"] },
  { t: "二次函數頂點", q: (a,b)=>`y = x² + ${a}x + ${b} 的頂點 x 座標為何？`, a: (a,b)=> -a/2, tag:["高一","二次函數"] },

  // ==========================================
  // [高二] 三角、向量、矩陣 (Grade 11)
  // ==========================================
  { t: "三角函數", q: (a,b)=>`試求 sin(30°) + cos(60°) + tan(45°) 之值。`, a: (a,b)=>2, tag:["高二","三角"] },
  { t: "平面向量", q: (a,b)=>`設向量 u = (${a}, 1)，v = (1, ${b})，試求內積 u・v 之值。`, a: (a,b)=>a+b, tag:["高二","向量"] },
  { t: "空間坐標", q: (a,b)=>`空間中一點 P(${a}, ${b}, 5) 到 xy 平面的距離為何？`, a: (a,b)=>5, tag:["高二","空間"] },
  { t: "矩陣運算", q: (a,b)=>`若矩陣 A = [[1, 0], [0, 1]]，則 ${a}A 的行列式值為何？`, a: (a,b)=>a*a, tag:["高二","矩陣"] },
  { t: "正弦定理", q: (a,b)=>`在三角形ABC中，a/sinA = ?`, type:'text', opts:['2R','R','R²','4R'], a:()=>0, tag:['高二','三角'] },
  { t: "柯西不等式", q: (a,b)=>`(|a||b|)² ≥ ?`, type:'text', opts:['(a·b)²','|a·b|','a·b','a+b'], a:()=>0, tag:['高二','向量'] },

  { t: "向量長度", q: (a,b)=>`向量 ( ${a}, ${b} ) 的長度為何？`, a: (a,b)=>Math.sqrt(a*a+b*b), tag:["高二","向量"] },
  { t: "向量夾角", q: (a,b)=>`向量 u=(1,0) 與 v=(${a},${b}) 的夾角 cosθ 為何？`, a: (a,b)=> (a)/Math.sqrt(a*a+b*b), tag:["高二","向量"] },
  { t: "行列式（2x2）", q: (a,b)=>`矩陣 [[${a},1],[0,${b}]] 的行列式為何？`, a: (a,b)=>a*b, tag:["高二","矩陣"] },
  { t: "三角恆等式", q: ()=>`sin²θ + cos²θ = ?`, a: ()=>1, tag:["高二","三角"] },

  // ==========================================
  // [高三] 微積分、機率統計 (Grade 12)
  // ==========================================
  { t: "極限", q: (a,b)=>`試求 lim(n→∞) (${a}n + 1) / n 之極限值。`, a: (a,b)=>a, tag:["高三","極限"] },
  { t: "微分", q: (a,b)=>`設函數 f(x) = x²，試求 f'(${a}) 之值。`, a: (a,b)=>2*a, tag:["高三","微分"] },
  { t: "積分", q: (a,b)=>`試求定積分 ∫(0 to ${a}) 2x dx 之值。`, a: (a,b)=>a*a, tag:["高三","積分"] },
  { t: "不定積分", q: (a,b)=>`求 ∫ ${a} dx = ?`, type:'text', opts:(a)=>[ `${a}x + C`, `${a} + C`, `x + C`, `${a}x`], a:()=>0, tag:["高三","積分"] },
  { t: "期望值", q: (a,b)=>`擲一骰子，出現 n 點可得 ${a}n 元，期望值為何？`, a: (a,b)=>a*3.5, tag:["高三","機率"] },
  { t: "條件機率", q: (a,b)=>`P(A|B) 的定義為何？`, type:'text', opts:['P(A∩B)/P(B)','P(A∩B)/P(A)','P(A)/P(B)','P(A)P(B)'], a:()=>0, tag:['高三','機率'] },

  { t: "導數應用（切線斜率）", q: (a,b)=>`函數 y=x³ 在 x=${a} 處切線斜率為何？`, a: (a,b)=>3*a*a, tag:["高三","微分"] },
  { t: "不定積分基本型", q: (a,b)=>`∫ x^${a} dx = ?`, a: (a,b)=>`x^${a+1}/${a+1} + C`, tag:["高三","積分"] },
  { t: "常態分配（概念）", q: ()=>`常態分配的特性為何？`, a: ()=>`對稱、以平均數為中心、由標準差決定分散程度`, tag:["高三","統計"] },
  { t: "二項分配期望", q: (n,p)=>`二項分配 B(n, p) 的期望值為何？`, a: (n,p)=>n*p, tag:["高三","機率"] },

  // ==========================================
  // 額外擴充題目（補足至 100 筆）
  // ==========================================
  
  { t: "最小公倍數", q: (a,b)=>`求 ${a} 與 ${b} 的最小公倍數`, a: (a,b)=> (a*b)/gcd(a,b), tag:["國七","倍數"] },
  { t: "最大公因數（Euclid）", q: (a,b)=>`求 ${a} 與 ${b} 的最大公因數`, a: (a,b)=>gcd(a,b), tag:["國七","因數"] },

  { t: "分數乘法應用", q: (a,b)=>`${a}/${b} × ${b}/${a} 等於多少？`, a: (a,b)=>1, tag:["國八","分數"] },
  { t: "完全平方", q: (a,b)=>`${a}² - 2·${a}·${b} + ${b}² 可寫成何種平方形式？`, a: (a,b)=>`(${a}-${b})²`, tag:["國八","恆等式"] },

  { t: "相似三角形比例應用", q: (a,b)=>`若兩相似三角形邊比為 ${a}:${b}，對應高比為何？`, a: (a,b)=>`${a}:${b}`, tag:["國九","幾何"] },
  { t: "梯形中位線", q: (a,b)=>`梯形兩底 ${a} 與 ${b}，中位線長為何？`, a: (a,b)=> (a+b)/2, tag:["國九","幾何"] },


  { t: "指數方程（簡單）", q: (a,b)=>`解 2^x = ${a}，x = ?（以 log 表示）`, a: (a,b)=>Math.log(a)/Math.log(2), tag:["高一","指數"] },
  { t: "圓錐體體積", q: (r,h)=>`半徑 ${r} 高 ${h} 的圓錐體積為何？`, a: (r,h)=> (1/3)*Math.PI*r*r*h, tag:["國八","立體"] },
  { t: "球體表面積", q: (r)=>`半徑 ${r} 的球表面積為何？`, a: (r)=>4*Math.PI*r*r, tag:["高二","立體"] },

  { t: "複數加法", q: (a,b,c,d)=>`( ${a}+${b}i ) + ( ${c}+${d}i ) = ?`, a: (a,b,c,d)=>`${a+c} + ${b+d}i`, tag:["高三","複數"] },
  { t: "複數模長", q: (a,b)=>`複數 ${a}+${b}i 的模為何？`, a: (a,b)=>Math.sqrt(a*a+b*b), tag:["高三","複數"] },

  { t: "極坐標轉換", q: (r,theta)=>`極坐標 (r, ${theta}°) 對應的直角坐標為何？`, a: (r,theta)=>[r*Math.cos(theta*Math.PI/180), r*Math.sin(theta*Math.PI/180)], tag:["高二","坐標"] },
  { t: "座標變換（平移）", q: (x,y,dx,dy)=>`點 (${x},${y}) 平移 ( ${dx}, ${dy} ) 後座標為何？`, a: (x,y,dx,dy)=>[x+dx,y+dy], tag:["高一","坐標"] },


  { t: "矩陣行列式應用", q: (a,b,c,d)=>`2×2 矩陣 [[${a},${b}],[${c},${d}]] 的行列式為何？`, a: (a,b,c,d)=>a*d - b*c, tag:["高二","矩陣"] },
  { t: "逆矩陣（2x2）", q: (a,b,c,d)=>`若行列式不為 0，逆矩陣為何？`, a: (a,b,c,d)=>`1/(${a*d-b*c}) * [[${d},-${b}],[-${c},${a}]]`, tag:["高二","矩陣"] },

];

// 輔助函式（在需要時可放在程式中）
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ let t=a%b; a=b; b=t; } return a; }
function comb(n,k){ if(k<0||k>n) return 0; let res=1; for(let i=1;i<=k;i++){ res=res*(n-(k-i))/i; } return Math.round(res); }

        // 註冊邏輯：分年級註冊
        // ==========================================
        const grades = ["國七", "國八", "國九", "高一", "高二", "高三"];

        grades.forEach(grade => {
            const pool = mathDB.filter(q => q.tag[0] === grade);
            
            // 每個題目獨立註冊，但標籤包含年級
            pool.forEach((p, idx) => {
                const templateId = `math_${grade}_${idx}`;
                
                G.registerTemplate(templateId, (ctx, rnd) => {
                    const v1 = randInt(2, 9);
                    const v2 = randInt(2, 9);
                    let ans = p.a(v1, v2);
                    let opts;

                    if (p.type === 'text') {
                        const op = typeof p.opts === 'function' ? p.opts(v1, v2) : p.opts;
                        opts = shuffle(op);
                        ans = op[0]; // 假設第一個是正確答案
                    } else if (p.type === 'fraction') {
                        const op = typeof p.opts === 'function' ? p.opts(v1) : p.opts;
                        const correctVal = a(v1,v2); // 數值答案
                        opts = shuffle(op);
                        ans = op[0]; // 字串答案
                    } else {
                        // 數值題自動生成誘答
                        const isInt = Number.isInteger(ans);
                        opts = shuffle(generateNumericOptions(ans, isInt ? 'int' : 'float'));
                    }

                    return {
                        question: `【數學】${p.q(v1, v2)}`,
                        options: opts,
                        answer: opts.indexOf(ans),
                        concept: p.t,
                        explanation: [`正確答案：${ans}`]
                    };
                }, ["math", "數學", grade, p.tag[1]]); // 關鍵：把年級加進 tags
            });
        });

        console.log("✅ 數學題庫 (分年級鎖定版) 已載入完成。");
    }

    init();

})(window);
