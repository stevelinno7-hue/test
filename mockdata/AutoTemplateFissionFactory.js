(function(global){
    'use strict';
    if (!global.RigorousGenerator) return;
    const G = global.RigorousGenerator;
    const { pick, randInt } = G.utils;

    // ==========================================
    //  1. æƒ…å¢ƒè³‡æ–™åº« (Context Database) - å¤§å¹…æ“´å……
    // ==========================================
    const DB = {
        // [è·æ¥­/è§’è‰²] - æ“´å……è‡³ 60+ ç¨®
        roles: [
            // ç§‘æŠ€/ç¾ä»£
            "AIå·¥ç¨‹å¸«", "å…¨ç«¯å·¥ç¨‹å¸«", "é›»ç«¶é¸æ‰‹", "YouTuber", "å¤–é€å“¡", 
            "è‚¡å¸‚åˆ†æå¸«", "å»ºç¯‰å¸«", "æ€¥è¨ºå®¤é†«ç”Ÿ", "ä¾¿åˆ©å•†åº—åº—å“¡", "å¥èº«æ•™ç·´",
            "FBIæ¢å“¡", "é»‘å®¢", "æ³•é†«", "æ©Ÿé•·", "æ–°èä¸»æ’­",
            // å¥‡å¹»/å†’éšª
            "ç«æ˜Ÿå¤ªç©ºäºº", "æ™‚ç©ºæ—…äºº", "å¸è¡€é¬¼çµäºº", "é­”æ³•å­¸å¾’", "ç…‰é‡‘è¡“å£«",
            "é¦´é¾é«˜æ‰‹", "æ·±æµ·æ½›æ°´å“¡", "å¿è€…", "æµ·ç›œèˆ¹é•·", "æ®­å±å€–å­˜è€…",
            "è€ƒå¤å­¸å®¶", "ç§å®¶åµæ¢", "ç‰¹å‹™ 007", "è¶…èƒ½åŠ›è€…", "çµ•åœ°æ­¦å£«",
            // ç”Ÿæ´»/ç‰¹æ®Š
            "ç±³å…¶æ—ä¸»å»š", "å‹•ç‰©æ£®å‹æœƒç©å®¶", "é¥’èˆŒæ­Œæ‰‹", "ç¸½çµ±", "æµæµªæ¼¢",
            "å¯ŒäºŒä»£", "æ¤ç‰©å­¸å®¶", "å¹¼ç¨šåœ’è€å¸«", "å…¬è»Šå¸æ©Ÿ", "ç®—å‘½å¸«",
            "å‚¬çœ å¸«", "é­”è¡“å¸«", "é¦´ç¸å¸«", "ç™»å±±å®¢", "æ¥µé™é‹å‹•å“¡",
            "æ‹è³£å®˜", "åœ–æ›¸é¤¨ç®¡ç†å“¡", "åšç‰©é¤¨é©šé­‚å¤œè­¦è¡›", "å‹•ç‰©åœ’é£¼è‚²å“¡", "éŸå±å®˜"
        ],

        // [å ´æ™¯/åœ°é»] - æ“´å……è‡³ 60+ ç¨®
        places: [
            // ç¾å¯¦åœ°é»
            "åœ¨å…¨è¯ç¦åˆ©ä¸­å¿ƒ", "åœ¨ 101 å¤§æ¨“é ‚ç«¯", "åœ¨æ’’å“ˆæ‹‰æ²™æ¼ ", "åœ¨ç‰å±±å±±é ‚",
            "åœ¨ IKEA è¿·å®®", "åœ¨æ ¸é›»å» æ§åˆ¶å®¤", "åœ¨æ‰‹è¡“å®¤", "åœ¨æ³•é™¢è­‰äººå¸­",
            "åœ¨æ¼”å”±æœƒå¾Œå°", "åœ¨æ“ æ»¿äººçš„æ·é‹è»Šå»‚", "åœ¨ç„¡äººå³¶", "åœ¨å—æ¥µç ”ç©¶ç«™",
            "åœ¨ç¾…æµ®å®®", "åœ¨è¿ªå£«å°¼æ¨‚åœ’", "åœ¨åœ‹éš›å¤ªç©ºç«™", "åœ¨æ½›æ°´è‰‡è£¡",
            // è™›æ“¬/å¥‡å¹»
            "åœ¨ç™¾æ…•é”ä¸‰è§’æ´²", "åœ¨éœæ ¼è¯èŒ²é­”æ³•å­¸æ ¡", "åœ¨æµ·åº•å…©è¬å“©", "åœ¨å–ªå±åœåŸçš„è³£å ´",
            "åœ¨æ™‚å…‰æ©Ÿè£¡", "åœ¨ç›´æ’­é–“", "åœ¨é»‘æ´é‚Šç·£", "åœ¨é‡‘å­—å¡”å¯†å®¤",
            "åœ¨å¤ç¾…é¦¬ç«¶æŠ€å ´", "åœ¨å…ƒå®‡å®™", "åœ¨å¬å–šå³½è°·", "åœ¨ä¾ç¾…ç´€å…¬åœ’",
            "åœ¨éµé”å°¼è™Ÿæ²ˆèˆ¹æ—", "åœ¨æœˆçƒèƒŒé¢", "åœ¨ç•°ä¸–ç•Œè½‰ç”Ÿé»", "åœ¨é¬¼å±‹",
            "åœ¨ç³–æœå±‹", "åœ¨å¤©ç©ºä¹‹åŸ", "åœ¨äºç‰¹è˜­ææ–¯", "åœ¨ç«æ˜Ÿæ®–æ°‘åœ°"
        ],

        // [æ ¼å¼/è¼‰é«”] - æ“´å……æ›´å¤šæ–‡é«”
        formats: [
            { type: "news", label: "æ–°è", tpl: (q)=>`ã€ç·Šæ€¥å¿«è¨Šã€‘æ“šæœ€æ–°å ±å°æŒ‡å‡ºï¼š\n${q}\nå°ˆå®¶è¡¨ç¤ºé€™å°‡å½±éŸ¿å…¨çƒå±€å‹¢ã€‚` },
            { type: "diary", label: "æ—¥è¨˜", tpl: (q)=>`ã€æ¢éšªæ—¥è¨˜ Day 42ã€‘\nä»Šå¤©ç™¼ç”Ÿäº†å¥‡æ€ªçš„äº‹ï¼š\n${q}\næˆ‘è©²æ€éº¼è¾¦ï¼Ÿ` },
            { type: "email", label: "ä¿¡ä»¶", tpl: (q)=>`Subject: ç·Šæ€¥æ±‚åŠ©\nTo: æ•™æˆ\n\næˆ‘åœ¨ç ”ç©¶ä¸­é‡åˆ°äº†ç“¶é ¸ï¼š\n${q}\nç›¼è¦†ã€‚` },
            { type: "chat", label: "å°è©±", tpl: (q)=>`Aï¼šã€Œæ¬¸ï¼Œè€ƒä½ ä¸€é¡Œã€‚ã€\nBï¼šã€Œæ”¾é¦¬éä¾†ã€‚ã€\nAï¼šã€Œ${q}ã€\nBï¼šã€Œé€™...ã€` },
            { type: "post", label: "ç¤¾ç¾¤", tpl: (q)=>`#æ€¥ #åœ¨ç·šç­‰ #æ±‚æ•‘\n${q}\nç­”å°çš„è«‹å–çå¥¶ï¼ğŸ¥¤` },
            { type: "system", label: "ç³»çµ±", tpl: (q)=>`[SYSTEM WARNING]\nåµæ¸¬åˆ°é‚è¼¯éŒ¯èª¤ï¼š\n${q}\nè«‹è¼¸å…¥æ­£ç¢ºæŒ‡ä»¤ä»¥ä¿®å¾©ç³»çµ±ã€‚` },
            { type: "exam", label: "è©¦é¡Œ", tpl: (q)=>`ã€115å¹´å­¸æ¸¬ æ¨¡æ“¬è©¦é¡Œã€‘\n${q}` },
            { type: "quest", label: "ä»»å‹™", tpl: (q)=>`ã€ä¸»ç·šä»»å‹™æ›´æ–°ã€‘\nNPC çµ¦äº†ä½ ä¸€å€‹è¬é¡Œï¼š\n${q}\nè§£é–‹å¾Œå¯ç²å¾—å‚³èªªè£å‚™ã€‚` },
            { type: "video", label: "çŸ­å½±éŸ³", tpl: (q)=>`ã€æŠ–éŸ³æŒ‘æˆ°ã€‘å¦‚æœä½ èƒ½åœ¨ä¸€åˆ†é˜å…§å›ç­”é€™å€‹å•é¡Œï¼š\nã€Œ${q}ã€\nä½ å°±æ˜¯å¤©æ‰ï¼` },
            { type: "memo", label: "ä¾¿æ¢", tpl: (q)=>`å†°ç®±ä¸Šè²¼è‘—ä¸€å¼µç´™æ¢ï¼š\nã€Œå‡ºé–€å‰è¨˜å¾—è™•ç†é€™ä»¶äº‹ï¼š${q}ã€` }
        ]
    };

    // ==========================================
    //  2. 200+ ç¨®æƒ…å¢ƒç”Ÿæˆå™¨ (Context Generator)
    // ==========================================
    const CONTEXT_WRAPPERS = {};

    // A. åŸºç¤æ¨™æº–ç‰ˆ
    CONTEXT_WRAPPERS['standard'] = (q) => q;

    // B. è§’è‰²æ‰®æ¼”ç‰ˆ (ç”Ÿæˆ 200 ç¨®çµ„åˆ IDs)
    // é›–ç„¶ç¨‹å¼é‚è¼¯æ˜¯å‹•æ…‹æ‹¼æ¹Šï¼Œä½†æˆ‘å€‘è¨»å†Š 200 å€‹ ID çµ¦ Bootstrap æŠ½
    // é€™æ¨£æ©Ÿç‡åˆ†ä½ˆæœƒæ›´å»£
    for (let i = 0; i < 200; i++) {
        CONTEXT_WRAPPERS[`roleplay_${i}`] = (q) => {
            // æ¯æ¬¡è¢«å‘¼å«æ™‚ï¼Œå³æ™‚éš¨æ©ŸæŠ½å–ï¼Œç¢ºä¿å°±ç®—æ˜¯åŒä¸€å€‹ IDï¼Œé¡Œç›®ä¹Ÿæœƒè®Š
            const r = pick(DB.roles);
            const p = pick(DB.places);
            return `ã€æƒ…å¢ƒï¼š${r}ã€‘\nä½ ç¾åœ¨${p}ï¼Œçœ¼å‰å‡ºç¾äº†ä¸€å€‹é›£é¡Œï¼š\nã€Œ${q}ã€\nèº«ç‚ºå°ˆæ¥­çš„${r}ï¼Œä½ è©²å¦‚ä½•è§£æ±ºï¼Ÿ`;
        };
    }

    // C. æ ¼å¼è®ŠåŒ–ç‰ˆ
    DB.formats.forEach((fmt) => {
        CONTEXT_WRAPPERS[fmt.type] = fmt.tpl;
    });

    // ==========================================
    //  3. è£‚è®Šç­–ç•¥ (Strategy Export)
    // ==========================================
    G.fissionStrategies = {
        /**
         * è¬èƒ½åŒ…è£æ©Ÿ
         * @param {Function} baseFunc åŸå§‹å‡½æ•¸
         * @param {String} contextType æŒ‡å®šæƒ…å¢ƒ ID
         */
        wrap: function(baseFunc, contextType) {
            return function(ctx, rnd) {
                const baseData = baseFunc(ctx, rnd);
                
                // ç²å–åŒ…è£å‡½æ•¸
                const wrapper = CONTEXT_WRAPPERS[contextType] || CONTEXT_WRAPPERS['standard'];
                
                // åŸ·è¡ŒåŒ…è£
                const newQuestion = wrapper(baseData.question);

                // æ±ºå®šæ¦‚å¿µæ¨™ç±¤
                let suffix = "åŸºç¤";
                if (contextType.includes('roleplay')) suffix = "ç´ é¤Šæ‡‰ç”¨";
                else if (['news', 'diary', 'email'].includes(contextType)) suffix = "é–±è®€ç†è§£";
                else if (['quest', 'video', 'chat'].includes(contextType)) suffix = "ç”Ÿæ´»æƒ…å¢ƒ";

                return {
                    ...baseData,
                    question: newQuestion,
                    concept: `${baseData.concept} (${suffix})`,
                    // æ¨™è¨˜é€™æ˜¯è£‚è®Šéçš„é¡Œç›®ï¼Œé¿å…é‡è¤‡è£‚è®Š
                    templateId: `${baseData.templateId || 'unknown'}_${contextType}` 
                };
            };
        },
        
        // å…¬é–‹æ‰€æœ‰å¯ç”¨çš„æƒ…å¢ƒ ID (å…± 200 + 10 = 210 ç¨®)
        availableContexts: Object.keys(CONTEXT_WRAPPERS)
    };

    console.log(`âœ… è‡ªå‹•è£‚è®Šå·¥å» å·²å°±ç·’ï¼šå·²ç”Ÿæˆ ${Object.keys(CONTEXT_WRAPPERS).length} ç¨®æƒ…å¢ƒæ¨¡çµ„ã€‚`);

})(this);