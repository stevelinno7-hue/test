(function(global){
    'use strict';

    // 定義啟動函式
    function init() {
        // 1. 檢查引擎是否就緒 (這就是數學科成功的關鍵！)
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        
        // 如果引擎還沒好，等待 100ms 後重試
        if (!G || !G.registerTemplate) {
            setTimeout(init, 100);
            return;
        }

        const { pick, shuffle } = G.utils;

        // ==========================================
        // 地理科核心資料庫 (Geography Core Database)
        // ==========================================
        const geoDB = [
            // ----------------------------------------------------
            // [國七] 台灣地理 (地形、氣候、水文)
            // ----------------------------------------------------
            { q: "台灣位於哪兩個板塊的交界處，因此地震頻繁？", a: "歐亞板塊與菲律賓海板塊", o: ["太平洋板塊與印度洋板塊", "歐亞板塊與太平洋板塊", "菲律賓海板塊與太平洋板塊"], t: ["國七","地形"] },
            { q: "在地圖上，等高線越密集代表該地的地勢特徵為何？", a: "坡度越陡", o: ["坡度越緩", "高度越高", "高度越低"], t: ["國七","地圖"] },
            { q: "台灣冬季盛行的季風風向為何？", a: "東北季風", o: ["西南季風", "東南季風", "西北季風"], t: ["國七","氣候"] },
            { q: "下列哪一種海岸地形最適合發展養殖漁業（如蚵田）？", a: "沙岸", o: ["岩岸", "斷層海岸", "珊瑚礁海岸"], t: ["國七","地形"] },
            { q: "台灣河川的主要特徵不包括下列何者？", a: "流速緩慢", o: ["長度短", "坡度陡", "流量變化大"], t: ["國七","水文"] },
            { q: "台灣哪一個地形區是人口最集中、產業最發達的區域？", a: "平原", o: ["丘陵", "台地", "盆地"], t: ["國七","人文"] },
            { q: "北回歸線（23.5°N）經過台灣哪兩個縣市？", a: "嘉義、花蓮", o: ["台南、台東", "高雄、屏東", "台中、南投"], t: ["國七","位置"] },

            // ----------------------------------------------------
            // [國八] 中國地理
            // ----------------------------------------------------
            { q: "中國地勢呈現什麼樣的特徵？", a: "西高東低，呈階梯狀分布", o: ["東高西低", "北高南低", "中間高四周低"], t: ["國八","地形"] },
            { q: "黃土高原居民傳統的居住形式「窯洞」，主要利用了黃土的哪項特性？", a: "垂直壁立性", o: ["高黏性", "透水性強", "含礦物質豐富"], t: ["國八","地形"] },
            { q: "中國氣候受到海陸性質差異影響，冬季吹什麼風？", a: "陸風（偏北風）", o: ["海風（偏南風）", "西風", "信風"], t: ["國八","氣候"] },
            { q: "長江三角洲因河網密布、農業發達，有什麼美稱？", a: "魚米之鄉", o: ["天府之國", "塞上江南", "世界屋脊"], t: ["國八","人文"] },
            { q: "坎兒井是為了適應哪種環境而發展出的水利設施？", a: "乾燥氣候", o: ["高寒氣候", "季風氣候", "雨林氣候"], t: ["國八","水文"] },

            // ----------------------------------------------------
            // [國九] 世界地理
            // ----------------------------------------------------
            { q: "位於赤道附近的氣候類型，特徵為全年高溫多雨，這是什麼氣候？", a: "熱帶雨林氣候", o: ["熱帶莽原氣候", "熱帶季風氣候", "熱帶沙漠氣候"], t: ["國九","氣候"] },
            { q: "歐洲哪種氣候類型終年受到西風吹拂與暖流調節，冬暖夏涼、全年有雨？", a: "溫帶海洋性氣候", o: ["地中海型氣候", "溫帶大陸性氣候", "溫帶季風氣候"], t: ["國九","氣候"] },
            { q: "東南亞國家協會（ASEAN）的主要成立目的為何？", a: "促進區域經濟合作與發展", o: ["建立軍事同盟", "統一貨幣", "推廣宗教"], t: ["國九","人文"] },
            { q: "非洲最高峰「吉力馬札羅山」雖然位於赤道附近，山頂卻終年積雪，主要原因為何？", a: "地勢高聳", o: ["距海遙遠", "洋流影響", "緯度高"], t: ["國九","地形"] },
            { q: "南美洲的亞馬遜河流域擁有世界最大的什麼生態系統？", a: "熱帶雨林", o: ["熱帶草原", "溫帶落葉林", "寒帶針葉林"], t: ["國九","生態"] },

            // ----------------------------------------------------
            // [高中] 通論地理
            // ----------------------------------------------------
            { q: "麥卡托投影地圖在航海使用上的最大優點是什麼？", a: "方向（角度）正確", o: ["面積正確", "距離正確", "形狀完全無變形"], t: ["高一","地圖"] },
            { q: "地理資訊系統（GIS）中，用來表示地表特徵位置與形狀的資料（如點、線、面）稱為什麼？", a: "向量資料", o: ["網格資料", "屬性資料", "後設資料"], t: ["高一","GIS"] },
            { q: "在中地理論中，較高級的中心地（如大都市）與低級中心地（如小鎮）相比，具有什麼特徵？", a: "商品種類多、服務範圍大", o: ["數量多、距離近", "商品種類少、服務範圍小", "只提供基本生活需求"], t: ["高一","人文"] }
        ];

        // 註冊模板：地理通用題 (Geo General)
        // 標籤包含各年級，確保 PaperGen 搜尋時能匹配到
        G.registerTemplate('geo_universal', (ctx, rnd) => {
            const item = pick(geoDB);
            const opts = shuffle([item.a, ...item.o]);
            
            return {
                question: `【地理 - ${item.t[1]}】${item.q}`,
                options: opts,
                answer: opts.indexOf(item.a),
                concept: item.t[1], // 子單元概念
                explanation: [`正確答案：${item.a}`]
            };
        }, ["geography", "地理", "社會", "國七", "國八", "國九", "高一", "高二", "高三"]);

        console.log("✅ 地理題庫已載入完成。");
    }

    // 啟動！
    init();

})(window);
