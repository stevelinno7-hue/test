(function(global){
    'use strict';

    function init() {
        // 1. æª¢æŸ¥å¼•æ“æ˜¯å¦å°±ç·’ (ç­‰å¾…æ©Ÿåˆ¶)
        const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
        
        // å¦‚æœå¼•æ“é‚„æ²’å¥½ï¼Œç­‰å¾… 100ms å¾Œé‡è©¦
        if (!G || !G.registerTemplate) {
            setTimeout(init, 100);
            return;
        }

        // å¼•æ“å·²å°±ç·’ï¼Œå–å‡ºå·¥å…·
        const { pick, shuffle } = G.utils;

        // ==========================================
        //  åœ°ç†ç§‘æ ¸å¿ƒè³‡æ–™åº« (Geography Core Database)
        // ==========================================
        const geoDB = [
            // [åœ‹ä¸ƒ] å°ç£åœ°ç†
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"æ²³è°·åœ°å½¢", y:"Vå‹è°·", p:"æ²³æµä¾µè•", k:"ä¸Šæ¸¸", d:"æ²³æµä¸Šæ¸¸ä¾µè•åŠ›å¼·ï¼Œä¸‹åˆ‡å½¢æˆæ·±è°·" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"æ²–ç©æ‰‡", y:"æ‰‡ç‹€å †ç©", p:"æ²³æµå †ç©", k:"è°·å£", d:"æ²³æµå‡ºè°·å£æµé€Ÿæ¸›ç·©ï¼Œæ³¥æ²™å †ç©æˆæ‰‡ç‹€" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"ä¸‰è§’æ´²", y:"æ²³å£å †ç©", p:"æ²³æµ", k:"å‡ºæµ·å£", d:"æ²³æµå…¥æµ·è™•æµé€Ÿæ¥µæ…¢ï¼Œæ³¥æ²™å †ç©æˆä¸‰è§’å½¢" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"çŸ³ç°å²©åœ°å½¢", y:"å–€æ–¯ç‰¹", p:"æº¶è•ä½œç”¨", k:"é˜ä¹³çŸ³", d:"åœ°ä¸‹æ°´æº¶è•çŸ³ç°å²©å±¤å½¢æˆçš„ç‰¹æ®Šåœ°å½¢" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","åœ°å½¢"], e:"æ²™æ´²èˆ‡æ½Ÿæ¹–", y:"æ³¢æµªå †ç©", p:"æ²¿æµ·", k:"æ¿±å¤–æ²™æ´²", d:"æ²¿å²¸æµèˆ‡æ³¢æµªæ¬é‹å †ç©å½¢æˆçš„æµ·ç©åœ°å½¢" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","æ°£å€™"], e:"å­£é¢¨æ°£å€™", y:"å¤é›¨å†¬ä¹¾", p:"æµ·é™¸æ€§è³ªå·®ç•°", k:"è½‰å‘", d:"å¤å­£å¹æµ·é¢¨å¤šé›¨ï¼Œå†¬å­£å¹é™¸é¢¨ä¹¾ç‡¥" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","æ°£å€™"], e:"åœ°å½¢é›¨", y:"è¿é¢¨å¡å¤šé›¨", p:"åœ°å½¢æŠ¬å‡", k:"èƒŒé¢¨å¡", d:"æ°£æµå—å±±è„ˆé˜»æ“‹æŠ¬å‡ï¼Œå†·å»å‡çµé™é›¨" },
            { s:"åœ°ç†", t:["åœ‹ä¸ƒ","ç”¢æ¥­"], e:"é›†ç´„è¾²æ¥­", y:"æŠ•å…¥å¤šç”¢å‡ºé«˜", p:"æ°´ç¨»", k:"å‹åŠ›å¯†é›†", d:"å–®ä½é¢ç©æŠ•å…¥å¤§é‡å‹åŠ›èˆ‡è³‡é‡‘çš„è¾²æ¥­" },

            // [åœ‹å…«] ä¸­åœ‹åœ°ç†
            { s:"åœ°ç†", t:["åœ‹å…«","ä¸­åœ‹"], e:"é»ƒåœŸé«˜åŸ", y:"çª¯æ´", p:"é¢¨åŠ›å †ç©", k:"æ°´åœŸæµå¤±", d:"åœŸè³ªç–é¬†ï¼Œæ˜“å—æµæ°´ä¾µè•ï¼Œå½¢æˆæºå£‘ç¸±æ©«" },
            { s:"åœ°ç†", t:["åœ‹å…«","ä¸­åœ‹"], e:"åå…’äº•", y:"ä¹¾ç‡¥æ°£å€™", p:"æ–°ç–†", k:"æš—æ¸ ", d:"æ¸›å°‘æ°´åˆ†è’¸ç™¼çš„å¤è€æ°´åˆ©è¨­æ–½" },
            { s:"åœ°ç†", t:["åœ‹å…«","ä¸­åœ‹"], e:"é•·æ±Ÿä¸‰è§’æ´²", y:"æ°´é„‰æ¾¤åœ‹", p:"æ°´é‹", k:"é­šç±³ä¹‹é„‰", d:"æ²³ç¶²å¯†å¸ƒï¼Œä¸­åœ‹ç¶“æ¿Ÿæœ€ç™¼é”çš„åœ°å€" },

            // [åœ‹ä¹] ä¸–ç•Œåœ°ç†
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"ç†±å¸¶é›¨æ—", y:"äºé¦¬éœ", p:"èµ¤é“", k:"å°æµé›¨", d:"å…¨å¹´é«˜æº«å¤šé›¨ï¼Œç”Ÿç‰©å¤šæ¨£æ€§é«˜" },
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"ç†±å¸¶è½åŸ", y:"ä¹¾æº¼åˆ†æ˜", p:"ç…å­æ–‘é¦¬", k:"è–©å‡¡ç´", d:"å—èµ¤é“ä½å£“èˆ‡å‰¯ç†±å¸¶é«˜å£“äº¤æ›¿æ§åˆ¶ï¼Œä¹¾æº¼å­£æ˜é¡¯" },
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"åœ°ä¸­æµ·å‹æ°£å€™", y:"å¤ä¹¾å†¬é›¨", p:"è¥¿é¢¨å¸¶", k:"æ©„æ¬–è‘¡è„", d:"å¤å­£ä¹¾ç‡¥å°‘é›¨ï¼Œå†¬å­£å—è¥¿é¢¨å¹æ‹‚å¤šé›¨" },
            { s:"åœ°ç†", t:["åœ‹ä¹","ä¸–ç•Œ"], e:"æº«å¸¶æµ·æ´‹æ€§", y:"å…¨å¹´æœ‰é›¨", p:"è¥¿æ­", k:"è¥¿é¢¨å¹æ‹‚", d:"çµ‚å¹´å—è¥¿é¢¨èˆ‡æš–æµå½±éŸ¿ï¼Œæ°£å€™æº«å’Œæ¿•æ½¤" },

            // [é«˜ä¸­] é€šè«–åœ°ç†
            { s:"åœ°ç†", t:["é«˜ä¸€","åœ°åœ–"], e:"éº¥å¡æ‰˜æŠ•å½±", y:"è§’åº¦æ­£ç¢º", p:"èˆªæµ·", k:"é«˜ç·¯æ”¾å¤§", d:"é©åˆèˆªæµ·å°èˆªï¼Œä½†é«˜ç·¯åº¦é¢ç©åš´é‡è®Šå½¢" },
            { s:"åœ°ç†", t:["é«˜ä¸€","åœ°åœ–"], e:"ç­‰é«˜ç·š", y:"åœ°å½¢èµ·ä¼", p:"åœ°å½¢åœ–", k:"é–‰åˆæ›²ç·š", d:"é€£ç·šä¸Šæµ·æ‹”é«˜åº¦ç›¸åŒçš„é»ï¼Œé¡¯ç¤ºåœ°å½¢å¡åº¦" },
            { s:"åœ°ç†", t:["é«˜ä¸€","GIS"], e:"å‘é‡è³‡æ–™", y:"é»ç·šé¢", p:"GIS", k:"å¹¾ä½•åœ–å½¢", d:"ç”¨åº§æ¨™èˆ‡é»ç·šé¢ä¾†å„²å­˜åœ°ç†è³‡è¨Š" },
            { s:"åœ°ç†", t:["é«˜ä¸€","GIS"], e:"ç¶²æ ¼è³‡æ–™", y:"åƒå…ƒ", p:"è¡›æ˜Ÿå½±åƒ", k:"è§£æåº¦", d:"å°‡åœ°è¡¨åˆ‡å‰²æˆç¶²æ ¼ï¼Œç´€éŒ„å±¬æ€§æ•¸å€¼" }
        ];

        // è¨»å†Šæ¨¡æ¿ï¼šåœ°ç†ç‰¹å¾µé¡Œ
        G.registerTemplate('geo_feat', (ctx, rnd) => {
            const item = pick(geoDB);
            // èª˜ç­”ï¼šéš¨æ©Ÿæ‰¾ 3 å€‹éŒ¯èª¤ç‰¹å¾µ
            const wrong = shuffle(geoDB.filter(x => x !== item)).slice(0, 3).map(x => x.y);
            const opts = shuffle([item.y, ...wrong]);
            
            return {
                question: `ã€åœ°ç†ã€‘é—œæ–¼ã€Œ${item.e}ã€ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ`,
                options: opts,
                answer: opts.indexOf(item.y),
                concept: item.t[1],
                explanation: [`æ­£ç¢ºç­”æ¡ˆï¼š${item.y}`, `èªªæ˜ï¼š${item.d}`]
            };
        }, ["geography", "åœ°ç†", "ç¤¾æœƒ", "åœ‹ä¸ƒ", "åœ‹å…«", "åœ‹ä¹", "é«˜ä¸€"]);

        // è¨»å†Šæ¨¡æ¿ï¼šåœ°ç†é—œéµå­—é¡Œ
        G.registerTemplate('geo_key', (ctx, rnd) => {
            const item = pick(geoDB);
            // èª˜ç­”ï¼šéš¨æ©Ÿæ‰¾ 3 å€‹éŒ¯èª¤é—œéµå­—
            const wrong = shuffle(geoDB.filter(x => x !== item)).slice(0, 3).map(x => x.k);
            const opts = shuffle([item.k, ...wrong]);
            
            return {
                question: `ã€åœ°ç†ã€‘æåˆ°ã€Œ${item.e}ã€ï¼Œé€šå¸¸æœƒè¯æƒ³åˆ°å“ªå€‹é—œéµè©ï¼Ÿ`,
                options: opts,
                answer: opts.indexOf(item.k),
                concept: item.t[1],
                explanation: [`${item.e} é—œéµè©ï¼š${item.k}`, `æˆå› ï¼š${item.p}`]
            };
        }, ["geography", "åœ°ç†", "ç¤¾æœƒ", "åœ‹ä¸ƒ", "åœ‹å…«", "åœ‹ä¹", "é«˜ä¸€"]);

        console.log("ğŸŒ åœ°ç†é¡Œåº«ï¼ˆæ´»æ½‘ç‰ˆï¼‰å·²è¼‰å…¥ï¼");
    }
    init();
})(window);
