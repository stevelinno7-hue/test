<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>解題論壇（AI 助教展示）｜翰林雲端學院</title>

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- 系統 JS -->
<script src="mockdata/users.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/real_ai_tutor.js"></script>

<style>
body {
    font-family: 'Noto Sans TC', sans-serif;
    background: #f4f6f8;
}
.ai-card {
    background: linear-gradient(135deg,#f0f9ff,#e0f2fe);
    border-left: 4px solid #0ea5e9;
}
.markdown-body ul { list-style: disc; margin-left: 1.5rem; }
.markdown-body p { margin-bottom: .5rem; }
.typing-dot { animation: typing 1.4s infinite ease-in-out both; }
.typing-dot:nth-child(1){animation-delay:-.32s}
.typing-dot:nth-child(2){animation-delay:-.16s}
@keyframes typing {
    0%,80%,100%{transform:scale(0)}
    40%{transform:scale(1)}
}
</style>
</head>

<body class="h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-64 bg-white border-r hidden lg:flex flex-col">
    <div class="h-16 flex items-center px-6 border-b font-bold text-xl">
        <span class="w-8 h-8 bg-blue-600 text-white rounded flex items-center justify-center mr-2">翰</span>
        雲端學院
    </div>

    <div class="p-6 text-center">
        <div class="w-14 h-14 mx-auto bg-blue-100 rounded-full flex items-center justify-center text-xl text-blue-600 mb-2">
            <i class="fas fa-user-graduate"></i>
        </div>
        <div id="sideUserName" class="font-bold"></div>
        <div id="sideUserRole" class="text-xs text-gray-500"></div>
    </div>

    <nav class="px-4 space-y-1 flex-grow">
        <a class="block px-4 py-3 rounded hover:bg-gray-100" href="#">解題論壇</a>
    </nav>

    <div class="p-4 border-t">
        <button onclick="Auth.logout()" class="w-full text-gray-500 hover:text-red-500">
            <i class="fas fa-sign-out-alt"></i> 登出
        </button>
    </div>
</aside>

<!-- Main -->
<main class="flex-grow flex flex-col">

<header class="h-16 bg-white border-b flex items-center justify-between px-6">
    <h2 class="font-bold text-lg flex items-center gap-2">
        <i class="fas fa-comments text-blue-500"></i> 解題討論區
    </h2>
    <button onclick="toggleForm()" class="bg-blue-600 text-white px-5 py-2 rounded font-bold">
        我要發問
    </button>
</header>

<section class="flex-grow overflow-y-auto p-6" id="scrollContainer">
<div class="max-w-3xl mx-auto space-y-6 pb-24">

<!-- 發問表單 -->
<div id="postForm" class="hidden bg-white p-6 rounded shadow">
    <h3 class="font-bold mb-3">建立新提問</h3>
    <input id="postTitle" class="w-full p-3 border rounded mb-3 font-bold"
        placeholder="標題：例如 高中微分問題">
    <textarea id="postContent" class="w-full p-3 border rounded h-28 mb-3"
        placeholder="請描述你的問題"></textarea>
    <div class="flex justify-between">
        <span class="text-xs text-gray-400">
            <i class="fas fa-robot text-blue-500"></i> AI 助教即時分析
        </span>
        <button onclick="addPost()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">
            發佈
        </button>
    </div>
</div>

<!-- 貼文列表 -->
<div id="postList" class="space-y-6"></div>

<!-- AI loading -->
<div id="aiThinking" class="hidden bg-white p-4 rounded shadow flex items-center gap-3 w-fit mx-auto">
    <i class="fas fa-robot text-indigo-600"></i>
    <div class="flex gap-1">
        <div class="w-2 h-2 bg-indigo-400 rounded-full typing-dot"></div>
        <div class="w-2 h-2 bg-indigo-400 rounded-full typing-dot"></div>
        <div class="w-2 h-2 bg-indigo-400 rounded-full typing-dot"></div>
    </div>
    <span class="text-xs text-gray-500">AI 助教分析中...</span>
</div>

</div>
</section>
</main>

<script>
const currentUser = Auth.requireLogin();
if(currentUser){
    sideUserName.textContent = currentUser.name;
    sideUserRole.textContent = currentUser.grade || "學生";
}

const dbKey = "forum_posts";

function toggleForm(){
    postForm.classList.toggle("hidden");
}

function loadPosts(){
    const posts = JSON.parse(localStorage.getItem(dbKey) || "[]");
    postList.innerHTML = "";
    posts.reverse().forEach(renderPost);
}

function renderPost(p){
    const isAI = p.reply && p.reply.author === RealAITutor.name;
    const replyHTML = p.reply ? `
        <div class="mt-4 p-4 rounded border ${isAI?'ai-card':'bg-gray-50'} flex gap-3">
            <i class="fas fa-robot text-indigo-600"></i>
            <div class="markdown-body text-sm">${marked.parse(p.reply.content)}</div>
        </div>` :
        `<div class="mt-4 text-xs text-gray-400">等待回覆中…</div>`;

    postList.insertAdjacentHTML("beforeend",`
        <div class="bg-white p-6 rounded shadow">
            <div class="font-bold text-lg">${p.title}</div>
            <div class="text-xs text-gray-500 mb-2">${p.author}｜${p.date}</div>
            <div class="text-sm text-gray-700">${p.content}</div>
            ${replyHTML}
        </div>
    `);
}

async function addPost(){
    const t = postTitle.value.trim();
    const c = postContent.value.trim();
    if(!t || !c) return alert("請填寫完整內容");

    const post = {
        id: Date.now(),
        title: t,
        content: c,
        author: currentUser.name,
        date: new Date().toLocaleString(),
        reply: null
    };

    const posts = JSON.parse(localStorage.getItem(dbKey)||"[]");
    posts.push(post);
    localStorage.setItem(dbKey, JSON.stringify(posts));

    postTitle.value = postContent.value = "";
    toggleForm();
    loadPosts();

    aiThinking.classList.remove("hidden");

    const aiText = await RealAITutor.askGemini(t,c);

    const updated = JSON.parse(localStorage.getItem(dbKey));
    const target = updated.find(p=>p.id===post.id);
    if(target) target.reply = {author:RealAITutor.name, content:aiText};
    localStorage.setItem(dbKey, JSON.stringify(updated));

    aiThinking.classList.add("hidden");
    loadPosts();
}

loadPosts();
</script>
</body>
</html>
