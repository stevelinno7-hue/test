(function(global){
    'use strict';
    const G = global.RigorousGenerator || (window.global && window.global.RigorousGenerator);
    if (!G) return;
    const { pick, shuffle } = G.utils;

    // ==========================================
    // 社會科全方位資料庫 (Social Studies Mega DB)
    // 包含：歷史(台/中/世)、地理、公民
    // ==========================================
    const socialDB = [
        // ----------------------------------------------------
        // [歷史 - 台灣史] (Prehistory ~ Modern)
        // ----------------------------------------------------
        { s:"歷史", t:["國七","台灣史"], e:"長濱文化", y:"舊石器時代", p:"早期人類", k:"八仙洞", d:"台灣已知最早的史前文化，以敲打石器為主，已知用火" },
        { s:"歷史", t:["國七","台灣史"], e:"大坌坑文化", y:"新石器早期", p:"南島語族祖先", k:"繩紋陶", d:"台灣最早的新石器文化，開始有農業與定居生活" },
        { s:"歷史", t:["國七","台灣史"], e:"卑南文化", y:"新石器晚期", p:"史前人類", k:"石板棺", d:"具有精美的玉器陪葬品，顯示已有社會階級" },
        { s:"歷史", t:["國七","台灣史"], e:"十三行文化", y:"金屬器時代", p:"凱達格蘭族祖先", k:"煉鐵", d:"台灣進入金屬器時代的代表，發現來自中國的銅錢" },
        { s:"歷史", t:["國七","台灣史"], e:"荷蘭治台", y:"1624-1662", p:"荷蘭東印度公司", k:"熱蘭遮城", d:"以台灣為轉口貿易站，輸出鹿皮、蔗糖，引入黃牛" },
        { s:"歷史", t:["國七","台灣史"], e:"西班牙治台", y:"1626-1642", p:"西班牙人", k:"聖薩爾瓦多城", d:"佔領北台灣，推廣天主教，後被荷蘭人驅逐" },
        { s:"歷史", t:["國七","台灣史"], e:"鄭氏治台", y:"1661-1683", p:"鄭成功", k:"全台首學", d:"建立台灣第一個漢人政權，陳永華建立孔廟推動儒學" },
        { s:"歷史", t:["國八","台灣史"], e:"渡台禁令", y:"清領前期", p:"康熙皇帝", k:"羅漢腳", d:"限制漢人來台，導致台灣男多女少，社會動盪" },
        { s:"歷史", t:["國八","台灣史"], e:"林爽文事件", y:"1786", p:"林爽文", k:"天地會", d:"清領時期規模最大的民變，諸羅縣因此改名嘉義" },
        { s:"歷史", t:["國八","台灣史"], e:"開港通商", y:"1860", p:"英法聯軍", k:"茶、糖、樟腦", d:"台灣納入世界經濟體系，經濟重心由南轉北" },
        { s:"歷史", t:["國八","台灣史"], e:"牡丹社事件", y:"1874", p:"日本/沈葆楨", k:"開山撫番", d:"日本藉口琉球船民遇害犯台，清廷治台態度轉積極" },
        { s:"歷史", t:["國八","台灣史"], e:"中法戰爭", y:"1884", p:"劉銘傳", k:"台灣建省", d:"法軍攻打基隆淡水，戰後清廷宣布台灣建省" },
        { s:"歷史", t:["國八","台灣史"], e:"乙未戰爭", y:"1895", p:"唐景崧", k:"台灣民主國", d:"馬關條約割讓台灣，台灣人民自發性武裝抗日" },
        { s:"歷史", t:["國八","台灣史"], e:"噍吧哖事件", y:"1915", p:"余清芳", k:"西來庵", d:"日治時期規模最大的漢人武裝抗日，後轉為非武裝抗爭" },
        { s:"歷史", t:["國八","台灣史"], e:"霧社事件", y:"1930", p:"莫那魯道", k:"賽德克族", d:"原住民不滿日本高壓統治爆發的武裝抗爭" },
        { s:"歷史", t:["國九","台灣史"], e:"台灣議會設置請願", y:"1921-1934", p:"林獻堂", k:"台灣文化協會", d:"日治時期歷時最久的政治社會運動" },
        { s:"歷史", t:["國九","台灣史"], e:"皇民化運動", y:"1937", p:"小林躋造", k:"改姓名", d:"中日戰爭爆發，日本企圖將台灣人改造成日本人" },
        { s:"歷史", t:["國九","台灣史"], e:"二二八事件", y:"1947", p:"陳儀", k:"查緝私菸", d:"戰後初期因政治腐敗與文化衝突引發的嚴重流血事件" },
        { s:"歷史", t:["國九","台灣史"], e:"耕者有其田", y:"1953", p:"陳誠", k:"土地改革", d:"政府徵收地主土地放領給佃農，促進農業發展" },
        { s:"歷史", t:["國九","台灣史"], e:"美麗島事件", y:"1979", p:"施明德", k:"黨外運動", d:"人權日遊行遭鎮壓，審判過程喚起民眾民主意識" },
        { s:"歷史", t:["國九","台灣史"], e:"解嚴", y:"1987", p:"蔣經國", k:"開放黨禁報禁", d:"解除長達38年的戒嚴，台灣邁向民主憲政" },
        { s:"歷史", t:["國九","台灣史"], e:"野百合學運", y:"1990", p:"大學生", k:"廢除萬年國會", d:"台灣戰後最大規模學生運動，促成憲政改革" },

        // ----------------------------------------------------
        // [歷史 - 中國史] (Ancient ~ Modern)
        // ----------------------------------------------------
        { s:"歷史", t:["國八","中國史"], e:"商鞅變法", y:"戰國時期", p:"商鞅", k:"富國強兵", d:"秦國因此強盛，為後來統一中國奠定基礎" },
        { s:"歷史", t:["國八","中國史"], e:"秦始皇統一", y:"西元前221", p:"嬴政", k:"郡縣制", d:"廢封建、行郡縣，統一文字、車軌、度量衡" },
        { s:"歷史", t:["國八","中國史"], e:"獨尊儒術", y:"漢武帝", p:"董仲舒", k:"察舉制", d:"罷黜百家，確立儒家思想為中國正統文化" },
        { s:"歷史", t:["國八","中國史"], e:"張騫通西域", y:"漢武帝", p:"張騫", k:"絲路", d:"原本為了聯絡大月氏夾擊匈奴，意外開通東西貿易" },
        { s:"歷史", t:["國八","中國史"], e:"赤壁之戰", y:"208年", p:"孫權/劉備", k:"三分天下", d:"孫劉聯軍擊敗曹操，奠定三國鼎立局勢" },
        { s:"歷史", t:["國八","中國史"], e:"永嘉之禍", y:"311年", p:"匈奴", k:"衣冠南渡", d:"西晉滅亡，世族南遷，北方進入五胡十六國" },
        { s:"歷史", t:["國八","中國史"], e:"孝文帝漢化", y:"北魏", p:"拓跋宏", k:"改漢姓", d:"鮮卑族漢化政策，促進胡漢融合" },
        { s:"歷史", t:["國八","中國史"], e:"貞觀之治", y:"唐太宗", p:"李世民", k:"天可汗", d:"唐朝國力強盛，君主被西北各族尊為共主" },
        { s:"歷史", t:["國八","中國史"], e:"安史之亂", y:"755-763", p:"安祿山", k:"藩鎮割據", d:"唐朝由盛轉衰的關鍵，導致地方節度使權力坐大" },
        { s:"歷史", t:["國八","中國史"], e:"澶淵之盟", y:"北宋", p:"宋真宗", k:"歲幣", d:"宋遼簽訂和約，維持了百年的和平" },
        { s:"歷史", t:["國八","中國史"], e:"蒙古西征", y:"13世紀", p:"成吉思汗", k:"火藥西傳", d:"建立跨歐亞大帝國，促進東西文化交流" },
        { s:"歷史", t:["國八","中國史"], e:"鄭和下西洋", y:"明成祖", p:"鄭和", k:"朝貢貿易", d:"宣揚國威，最遠到達非洲東岸" },
        { s:"歷史", t:["國八","中國史"], e:"張居正變法", y:"明神宗", p:"張居正", k:"一條鞭法", d:"將賦役合併徵銀，簡化稅制" },
        { s:"歷史", t:["國八","中國史"], e:"鴉片戰爭", y:"1840", p:"林則徐", k:"南京條約", d:"中國簽訂第一個不平等條約，割讓香港" },
        { s:"歷史", t:["國八","中國史"], e:"太平天國", y:"1851", p:"洪秀全", k:"天朝田畝", d:"清末規模最大的民變，重創清朝統治根基" },
        { s:"歷史", t:["國八","中國史"], e:"自強運動", y:"1860", p:"李鴻章", k:"師夷長技", d:"學習西方器物層面，推動軍事工業" },
        { s:"歷史", t:["國八","中國史"], e:"甲午戰爭", y:"1894", p:"光緒", k:"馬關條約", d:"清朝戰敗，割讓台灣澎湖給日本" },
        { s:"歷史", t:["國八","中國史"], e:"戊戌變法", y:"1898", p:"康有為", k:"百日維新", d:"學習西方制度層面，因慈禧太后政變失敗" },
        { s:"歷史", t:["國八","中國史"], e:"辛亥革命", y:"1911", p:"孫中山", k:"武昌起義", d:"推翻滿清帝制，建立亞洲第一個民主共和國" },
        { s:"歷史", t:["國八","中國史"], e:"五四運動", y:"1919", p:"胡適", k:"德先生賽先生", d:"抗議巴黎和會山東問題，提倡民主與科學" },
        { s:"歷史", t:["國八","中國史"], e:"北伐統一", y:"1928", p:"蔣中正", k:"黃金十年", d:"國民革命軍統一中國，展開建設" },
        { s:"歷史", t:["國八","中國史"], e:"文化大革命", y:"1966-1976", p:"毛澤東", k:"紅衛兵", d:"十年動亂，破四舊，傳統文化遭嚴重破壞" },
        { s:"歷史", t:["國八","中國史"], e:"改革開放", y:"1978", p:"鄧小平", k:"經濟特區", d:"中國經濟體制改革，設立深圳等特區" },

        // ----------------------------------------------------
        // [歷史 - 世界史] (Civilization ~ Modern)
        // ----------------------------------------------------
        { s:"歷史", t:["國九","世界史"], e:"漢摩拉比法典", y:"古巴比倫", p:"漢摩拉比", k:"以牙還牙", d:"世界上現存最早的成文法典之一" },
        { s:"歷史", t:["國九","世界史"], e:"金字塔", y:"古埃及", p:"法老", k:"尼羅河", d:"埃及人相信來世，製作木乃伊與巨大陵墓" },
        { s:"歷史", t:["國九","世界史"], e:"種姓制度", y:"古印度", p:"阿利安人", k:"婆羅門", d:"將人分為四個階級，階級森嚴世襲" },
        { s:"歷史", t:["國九","世界史"], e:"雅典民主", y:"古希臘", p:"伯里克利", k:"陶片流放", d:"成年男性公民可參與公民大會，實行直接民主" },
        { s:"歷史", t:["國九","世界史"], e:"亞歷山大東征", y:"希臘化時代", p:"亞歷山大", k:"東西融合", d:"融合希臘、西亞、埃及文化，科學藝術發達" },
        { s:"歷史", t:["國九","世界史"], e:"羅馬和平", y:"羅馬帝國", p:"屋大維", k:"條條大路通羅馬", d:"帝國初期兩百年的強盛與和平時期" },
        { s:"歷史", t:["國九","世界史"], e:"十字軍東征", y:"11-13世紀", p:"教宗", k:"收復聖地", d:"雖軍事失敗，但促進了東西方貿易與文化交流" },
        { s:"歷史", t:["國九","世界史"], e:"黑死病", y:"14世紀", p:"鼠疫", k:"人口銳減", d:"造成歐洲三分之一人口死亡，封建制度動搖" },
        { s:"歷史", t:["國九","世界史"], e:"文藝復興", y:"14-16世紀", p:"達文西", k:"人文主義", d:"以人為本，重新重視希臘羅馬古典文化" },
        { s:"歷史", t:["國九","世界史"], e:"宗教改革", y:"1517", p:"馬丁路德", k:"因信稱義", d:"反對贖罪券與教會腐敗，促成新教產生" },
        { s:"歷史", t:["國九","世界史"], e:"地理大發現", y:"15世紀末", p:"哥倫布", k:"新航路", d:"發現新大陸，全球貿易網開始形成" },
        { s:"歷史", t:["國九","世界史"], e:"科學革命", y:"17世紀", p:"牛頓", k:"萬有引力", d:"強調觀察與實驗，建立近代科學基礎" },
        { s:"歷史", t:["國九","世界史"], e:"啟蒙運動", y:"18世紀", p:"伏爾泰", k:"理性", d:"強調理性與天賦人權，影響美國與法國革命" },
        { s:"歷史", t:["國九","世界史"], e:"工業革命", y:"18世紀中", p:"瓦特", k:"蒸汽機", d:"生產方式由手工轉為機械，工廠制度興起" },
        { s:"歷史", t:["國九","世界史"], e:"美國獨立", y:"1776", p:"華盛頓", k:"獨立宣言", d:"脫離英國殖民，建立三權分立的民主國家" },
        { s:"歷史", t:["國九","世界史"], e:"法國大革命", y:"1789", p:"路易十六", k:"人權宣言", d:"推翻專制王權，追求自由平等博愛" },
        { s:"歷史", t:["國九","世界史"], e:"第一次世界大戰", y:"1914-1918", p:"威廉二世", k:"壕溝戰", d:"奧匈帝國皇儲被刺引爆，同盟國與協約國對抗" },
        { s:"歷史", t:["國九","世界史"], e:"經濟大恐慌", y:"1929", p:"羅斯福", k:"新政", d:"華爾街股市崩盤引發全球經濟衰退" },
        { s:"歷史", t:["國九","世界史"], e:"第二次世界大戰", y:"1939-1945", p:"希特勒", k:"軸心國", d:"德國入侵波蘭引爆，人類史上最大規模戰爭" },
        { s:"歷史", t:["國九","世界史"], e:"冷戰", y:"1947-1991", p:"美蘇", k:"鐵幕", d:"資本主義與共產主義兩大陣營的對抗" },

        // ----------------------------------------------------
        // [地理] (Physical & Human)
        // ----------------------------------------------------
        { s:"地理", t:["國七","地形"], e:"河谷地形", y:"V型谷", p:"河流侵蝕", k:"上游", d:"河流上游侵蝕力強，下切形成深谷" },
        { s:"地理", t:["國七","地形"], e:"沖積扇", y:"扇狀堆積", p:"河流堆積", k:"谷口", d:"河流出谷口流速減緩，泥沙堆積成扇狀" },
        { s:"地理", t:["國七","地形"], e:"三角洲", y:"河口堆積", p:"河流", k:"出海口", d:"河流入海處流速極慢，泥沙堆積成三角形" },
        { s:"地理", t:["國七","地形"], e:"石灰岩地形", y:"喀斯特", p:"溶蝕作用", k:"鐘乳石", d:"地下水溶蝕石灰岩層形成的特殊地形" },
        { s:"地理", t:["國七","地形"], e:"沙洲與潟湖", y:"波浪堆積", p:"沿海", k:"濱外沙洲", d:"沿岸流與波浪搬運堆積形成的海積地形" },
        { s:"地理", t:["國七","氣候"], e:"季風氣候", y:"夏雨冬乾", p:"海陸性質差異", k:"轉向", d:"夏季吹海風多雨，冬季吹陸風乾燥" },
        { s:"地理", t:["國七","氣候"], e:"地形雨", y:"迎風坡多雨", p:"地形抬升", k:"背風坡", d:"氣流受山脈阻擋抬升，冷卻凝結降雨" },
        { s:"地理", t:["國七","產業"], e:"集約農業", y:"投入多產出高", p:"水稻", k:"勞力密集", d:"單位面積投入大量勞力與資金的農業" },
        { s:"地理", t:["國八","中國"], e:"黃土高原", y:"窯洞", p:"風力堆積", k:"水土流失", d:"土質疏鬆，易受流水侵蝕，形成溝壑縱橫" },
        { s:"地理", t:["國八","中國"], e:"坎兒井", y:"乾燥氣候", p:"新疆", k:"暗渠", d:"減少水分蒸發的古老水利設施" },
        { s:"地理", t:["國八","中國"], e:"長江三角洲", y:"水鄉澤國", p:"水運", k:"魚米之鄉", d:"河網密布，中國經濟最發達的地區" },
        { s:"地理", t:["國九","世界"], e:"熱帶雨林", y:"亞馬遜", p:"赤道", k:"對流雨", d:"全年高溫多雨，生物多樣性高" },
        { s:"地理", t:["國九","世界"], e:"熱帶莽原", y:"乾溼分明", p:"獅子斑馬", k:"薩凡納", d:"受赤道低壓與副熱帶高壓交替控制，乾溼季明顯" },
        { s:"地理", t:["國九","世界"], e:"地中海型氣候", y:"夏乾冬雨", p:"西風帶", k:"橄欖葡萄", d:"夏季乾燥少雨，冬季受西風吹拂多雨" },
        { s:"地理", t:["國九","世界"], e:"溫帶海洋性", y:"全年有雨", p:"西歐", k:"西風吹拂", d:"終年受西風與暖流影響，氣候溫和濕潤" },
        { s:"地理", t:["高一","地圖"], e:"麥卡托投影", y:"角度正確", p:"航海", k:"高緯放大", d:"適合航海導航，但高緯度面積嚴重變形" },
        { s:"地理", t:["高一","地圖"], e:"等高線", y:"地形起伏", p:"地形圖", k:"閉合曲線", d:"連線上海拔高度相同的點，顯示地形坡度" },
        { s:"地理", t:["高一","GIS"], e:"向量資料", y:"點線面", p:"GIS", k:"幾何圖形", d:"用座標與點線面來儲存地理資訊" },
        { s:"地理", t:["高一","GIS"], e:"網格資料", y:"像元", p:"衛星影像", k:"解析度", d:"將地表切割成網格，紀錄屬性數值" },

        // ----------------------------------------------------
        // [公民] (Social, Law, Economics)
        // ----------------------------------------------------
        { s:"公民", t:["國七","社會"], e:"性別刻板印象", y:"偏見", p:"文化", k:"男主外", d:"對特定性別抱持固定的看法或期望" },
        { s:"公民", t:["國七","社會"], e:"家庭功能", y:"社會化", p:"教育", k:"生育", d:"家庭教導子女社會規範與價值觀的過程" },
        { s:"公民", t:["國八","政治"], e:"主權", y:"國家最高權力", p:"國家要素", k:"對內最高", d:"國家對內擁有最高統治權，對外獨立自主" },
        { s:"公民", t:["國八","政治"], e:"基本人權", y:"憲法保障", p:"自由權", k:"平等權", d:"人民與生俱來的權利，政府應予以保障" },
        { s:"公民", t:["國八","政治"], e:"權力分立", y:"制衡", p:"孟德斯鳩", k:"三權分立", d:"行政、立法、司法互相制衡，避免專制" },
        { s:"公民", t:["國八","法律"], e:"罪刑法定主義", y:"法律保留", p:"刑法", k:"不溯及既往", d:"行為時法律未規定者，不得處罰" },
        { s:"公民", t:["國八","法律"], e:"契約自由", y:"私法自治", p:"民法", k:"誠信原則", d:"個人可依自由意志訂立契約，法律原則不干涉" },
        { s:"公民", t:["國八","法律"], e:"行政處分", y:"公權力", p:"行政機關", k:"罰單", d:"行政機關就公法上具體事件所做的單方決定" },
        { s:"公民", t:["國九","經濟"], e:"機會成本", y:"代價", p:"選擇", k:"價值最高", d:"做出選擇時，所放棄的選項中價值最高者" },
        { s:"公民", t:["國九","經濟"], e:"需求法則", y:"反向變動", p:"消費者", k:"價格", d:"其他條件不變下，價格上漲，需求量減少" },
        { s:"公民", t:["國九","經濟"], e:"供給法則", y:"正向變動", p:"生產者", k:"價格", d:"其他條件不變下，價格上漲，供給量增加" },
        { s:"公民", t:["國九","經濟"], e:"外部效果", y:"市場失靈", p:"庇古", k:"成本內部化", d:"經濟行為對無關第三人造成的影響(如汙染)" },
        { s:"公民", t:["國九","經濟"], e:"公共財", y:"共享性", p:"國防", k:"無法排他", d:"具有共享性與無法排他性的財貨" },
        { s:"公民", t:["國九","經濟"], e:"GDP", y:"國內生產毛額", p:"經濟成長", k:"最終產品", d:"一國境內在一定期間內生產的最終產品與勞務總值" },
        { s:"公民", t:["高一","政治"], e:"內閣制", y:"虛位元首", p:"英國", k:"信任投票", d:"行政權對立法權負責，國會可提不信任案" },
        { s:"公民", t:["高一","政治"], e:"總統制", y:"覆議權", p:"美國", k:"分立制衡", d:"總統由人民直選，行政與立法權完全分立" },
        { s:"公民", t:["高一","法律"], e:"比例原則", y:"憲法第23條", p:"大法官", k:"最小侵害", d:"國家限制人民權利手段必須必要且適當" }
    ];

   // ==========================================
    // 註冊模板 (分科註冊)
    // ==========================================
    const subjects = [
        { name: "歷史", code: "his" },
        { name: "地理", code: "geo" },
        { name: "公民", code: "civ" }
    ];

    subjects.forEach(subj => {
        // 1. 篩選
        const subData = socialDB.filter(item => item.s === subj.name);
        if (subData.length === 0) return;

        // 2. 註冊 (特徵題)
        G.registerTemplate(`${subj.code}_feat`, (ctx, rnd) => {
            const item = pick(subData);
            const wrong = shuffle(subData.filter(x => x !== item)).slice(0, 3).map(x => x.y);
            const opts = shuffle([item.y, ...wrong]);
            return {
                question: `【${item.s}】關於「${item.e}」，下列何者為其關鍵特徵？`,
                options: opts, answer: opts.indexOf(item.y), concept: item.t[1],
                explanation: [`${item.e}：${item.y}`]
            };
        }, [subj.name, "社會", "記憶"]);

        // 3. 註冊 (關鍵字題)
        G.registerTemplate(`${subj.code}_key`, (ctx, rnd) => {
            const item = pick(subData);
            const wrong = shuffle(subData.filter(x => x !== item)).slice(0, 3).map(x => x.k);
            const opts = shuffle([item.k, ...wrong]);
            return {
                question: `【${item.s}】提到「${item.e}」，通常會聯想到哪個關鍵詞？`,
                options: opts, answer: opts.indexOf(item.k), concept: item.t[1],
                explanation: [`${item.e} 關鍵詞：${item.k}`]
            };
        }, [subj.name, "社會", "關鍵字"]);
    });

})(this);